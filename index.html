<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Complete Supermarket Management System with POS, Inventory, Dashboard, and Billing">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SMS POS">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23667eea' width='192' height='192'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='100' fill='white' font-weight='bold'>SMS</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23667eea' width='192' height='192'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='100' fill='white' font-weight='bold'>SMS</text></svg>">
    <title>Supermarket Management System - POS</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --secondary-light: #f472b6;
            --accent: #14b8a6;
            --accent-light: #2dd4bf;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --light: #f8fafc;
            --dark: #0f172a;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --border-radius: 16px;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.12);
            --shadow-colored: 0 12px 40px rgba(99, 102, 241, 0.2);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.18);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(20, 184, 166, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* ===== CONTAINER & LAYOUT ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            overflow: hidden;
            min-height: calc(100vh - 40px);
            position: relative;
            z-index: 10;
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            background-size: 200% 200%;
            animation: gradient-shift 8s ease infinite;
            color: white;
            padding: 40px 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: pattern-move 20s linear infinite;
            opacity: 0.3;
        }

        @keyframes pattern-move {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 12px;
            font-weight: 800;
            letter-spacing: -1px;
            position: relative;
            z-index: 1;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            background: linear-gradient(to right, #ffffff, #f0f0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            opacity: 0.95;
            font-size: 1.05rem;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-weight: 500;
        }



        /* ===== NAVIGATION ===== */
        .nav-tabs {
            display: flex;
            background: linear-gradient(to bottom, rgba(248, 250, 252, 0.9), rgba(241, 245, 249, 0.9));
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
            padding: 8px;
            gap: 8px;
        }

        .nav-tab {
            flex: 1;
            padding: 14px 20px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--gray);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.1));
            opacity: 0;
            transition: var(--transition);
        }

        .nav-tab:hover::before {
            opacity: 1;
        }

        .nav-tab:hover {
            color: var(--primary);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            color: white;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .nav-tab.active::before {
            opacity: 0;
        }

        /* ===== CONTENT SECTIONS ===== */
        .content {
            padding: 30px;
        }

        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== CONFETTI & SPARKLE ANIMATIONS ===== */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 99999;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary);
            opacity: 0;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(0) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotate(720deg);
            }
        }

        .sparkle {
            position: absolute;
            font-size: 20px;
            animation: sparkle-burst 1s ease-out forwards;
            pointer-events: none;
        }

        @keyframes sparkle-burst {
            0% {
                opacity: 1;
                transform: scale(0) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.5) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(0) rotate(360deg);
            }
        }

        .success-ripple {
            position: fixed;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(76, 175, 80, 0.4) 0%, rgba(76, 175, 80, 0) 70%);
            pointer-events: none;
            z-index: 9998;
            animation: ripple-expand 0.8s ease-out forwards;
        }

        @keyframes ripple-expand {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }
            100% {
                width: 500px;
                height: 500px;
                opacity: 0;
            }
        }

        .shake-animation {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .pulse-animation {
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .bounce-in {
            animation: bounce-in 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounce-in {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
            }
        }

        .slide-in-right {
            animation: slide-in-right 0.4s ease-out;
        }

        @keyframes slide-in-right {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .glow-success {
            animation: glow-success 1s ease-in-out;
        }

        @keyframes glow-success {
            0%, 100% {
                box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(76, 175, 80, 0.8), 0 0 30px rgba(76, 175, 80, 0.6);
            }
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            animation: toast-slide-in 0.3s ease-out;
            pointer-events: all;
            border-left: 4px solid var(--primary);
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast.info {
            border-left-color: var(--primary);
        }

        @keyframes toast-slide-in {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toast-slide-out {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .toast.removing {
            animation: toast-slide-out 0.3s ease-out forwards;
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray);
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: var(--transition);
        }

        .toast-close:hover {
            background: var(--light-gray);
            color: var(--dark);
        }

        /* ===== POS SECTION ===== */
        .pos-header {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .pos-search {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .pos-search input {
            width: 100%;
            padding: 14px 45px 14px 45px;
            border: 2px solid rgba(226, 232, 240, 0.8);
            border-radius: 12px;
            font-size: 0.95rem;
            transition: var(--transition);
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .pos-search input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 
                0 0 0 4px rgba(99, 102, 241, 0.1),
                0 4px 12px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }

        .pos-search::before {
            content: 'üîç';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .barcode-input {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .barcode-input input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .barcode-input::before {
            content: 'üì∑';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .customer-info-card {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .customer-info-card h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .customer-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .customer-form input {
            padding: 10px 12px;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .customer-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .discount-tax-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 2px solid var(--light-gray);
        }

        .discount-tax-section h4 {
            font-size: 0.9rem;
            margin-bottom: 12px;
            color: var(--dark);
        }

        .discount-tax-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .discount-tax-controls input,
        .discount-tax-controls select {
            padding: 8px 10px;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .quick-discount-btns {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .quick-discount-btn {
            padding: 6px 12px;
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .quick-discount-btn:hover {
            background: var(--primary);
            color: white;
        }

        .pos-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(236, 72, 153, 0.05));
            opacity: 0;
            transition: var(--transition);
        }

        .product-card::after {
            content: '‚ú®';
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 24px;
            opacity: 0;
            transform: scale(0) rotate(0deg);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .product-card:hover::before {
            opacity: 1;
        }

        .product-card:hover::after {
            opacity: 1;
            transform: scale(1) rotate(360deg);
        }

        .product-card:hover {
            border-color: var(--primary);
            box-shadow: 
                0 12px 35px rgba(99, 102, 241, 0.2),
                0 0 0 1px rgba(99, 102, 241, 0.1);
            transform: translateY(-8px) scale(1.02);
        }

        .product-card:active {
            transform: translateY(-5px) scale(0.98);
        }

        .product-card.out-of-stock {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .product-card.out-of-stock:hover {
            transform: none;
            border-color: var(--light-gray);
            box-shadow: none;
        }

        .product-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .product-price {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .product-stock {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 15px;
        }

        .product-stock.low {
            color: var(--warning);
            font-weight: 600;
        }

        .product-stock.out {
            color: var(--danger);
            font-weight: 600;
        }

        /* ===== CART SECTION ===== */
        .cart-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(236, 72, 153, 0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 20px;
            padding: 28px;
            height: fit-content;
            position: sticky;
            top: 20px;
            box-shadow: 
                0 10px 30px rgba(99, 102, 241, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .cart-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
        }

        .cart-count {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .cart-items {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
        }

        .cart-items::-webkit-scrollbar {
            width: 6px;
        }

        .cart-items::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 3px;
        }

        .cart-items::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .cart-item {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            transition: var(--transition);
        }

        .cart-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 12px;
            padding: 2px;
            background: linear-gradient(135deg, #6366f1, #ec4899);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: var(--transition);
        }

        .cart-item:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.15);
        }

        .cart-item:hover::before {
            opacity: 1;
        }

        .cart-item-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .cart-item-info {
            flex: 1;
            min-width: 0;
        }

        .cart-item-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--dark);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cart-item-price {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid var(--light-gray);
            background: white;
            color: var(--dark);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .qty-btn:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .qty-display {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
        }

        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .remove-btn:hover {
            background: #ff5252;
            transform: scale(1.05);
        }

        /* ===== CART SUMMARY ===== */
        .cart-summary {
            border-top: 2px solid var(--light-gray);
            padding-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .summary-row.total {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--light-gray);
        }

        .checkout-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        .checkout-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .checkout-btn:hover::before {
            left: 100%;
        }

        .checkout-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 35px rgba(16, 185, 129, 0.4);
        }

        .checkout-btn:disabled {
            background: var(--light-gray);
            color: var(--gray);
            cursor: not-allowed;
            transform: none !important;
        }

        .clear-cart-btn {
            width: 100%;
            padding: 12px;
            background: var(--light-gray);
            color: var(--gray);
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: var(--transition);
        }

        .clear-cart-btn:hover {
            background: white;
            border-color: var(--danger);
            color: var(--danger);
        }

        .exchange-refund-btn {
            transition: var(--transition);
        }

        .exchange-refund-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .exchange-refund-btn:active {
            transform: translateY(0) !important;
        }

        .promo-type-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .promo-card {
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            padding: 20px;
            transition: var(--transition);
        }

        .promo-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
        }

        .promo-card.active {
            border-left: 4px solid var(--success);
            background: #f0fff4;
        }

        .promo-card.inactive {
            opacity: 0.6;
            border-left: 4px solid var(--gray);
        }

        .promo-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .promo-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .promo-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .transaction-card:not([style*="cursor: not-allowed"]):hover {
            border-color: var(--primary) !important;
            transform: translateX(5px);
        }

        /* ===== ADMIN PANEL STYLES ===== */
        .admin-login {
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
        }

        .admin-login-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .admin-login-card h2 {
            margin-bottom: 10px;
            color: var(--dark);
        }

        .admin-login-card p {
            color: var(--gray);
            margin-bottom: 30px;
        }

        .pin-input-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .pin-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            transition: var(--transition);
        }

        .pin-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .admin-content {
            display: none;
        }

        .admin-content.authenticated {
            display: block;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .admin-header h2 {
            margin: 0;
            font-size: 1.8rem;
        }

        .admin-logout-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .admin-logout-btn:hover {
            background: white;
            color: var(--primary);
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
        }

        .admin-card h3 {
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-stock-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .quick-stock-info {
            flex: 1;
        }

        .quick-stock-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .quick-stock-current {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .quick-stock-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .quick-stock-input {
            width: 70px;
            padding: 6px;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        .quick-stock-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .quick-stock-btn.add {
            background: var(--success);
            color: white;
        }

        .quick-stock-btn.remove {
            background: var(--danger);
            color: white;
        }

        .quick-stock-btn:hover {
            transform: scale(1.05);
        }

        .admin-action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .admin-action-btn {
            padding: 20px;
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            font-weight: 600;
        }

        .admin-action-btn:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .admin-action-btn .icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
        }

        .pin-change-form {
            display: grid;
            gap: 15px;
        }

        /* ===== INVENTORY SECTION ===== */
        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .inventory-search-bar {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .inventory-search-bar input {
            width: 100%;
            padding: 12px 45px 12px 45px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .inventory-search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .inventory-search-bar::before {
            content: 'üîç';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .inventory-search-bar .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--gray);
            display: none;
        }

        .inventory-search-bar .clear-search.active {
            display: block;
        }

        .inventory-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: var(--transition);
            color: var(--gray);
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .inventory-quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-stat {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .quick-stat-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 5px;
        }

        .quick-stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .bulk-action-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bulk-action-btn:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .inventory-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            background: var(--light);
            padding: 25px;
            border-radius: 12px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark);
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            padding: 12px 15px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-product-btn {
            padding: 14px 32px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            background-size: 200% 200%;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.95rem;
            transition: var(--transition);
            align-self: flex-end;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
            letter-spacing: 0.3px;
        }

        .add-product-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .add-product-btn:hover::before {
            width: 400px;
            height: 400px;
        }

        .add-product-btn:hover {
            background-position: 100% 0;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(99, 102, 241, 0.4);
        }

        .add-product-btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        /* ===== TABLES ===== */
        .table-container {
            overflow-x: auto;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            -webkit-overflow-scrolling: touch;
            background: white;
            border: 1px solid rgba(226, 232, 240, 0.6);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 1300px;
            table-layout: fixed;
        }

        .table th {
            background: var(--light);
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--light-gray);
            border-right: 1px solid var(--light-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }

        .table th:hover {
            background: var(--light-gray);
        }

        .table th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.3;
            font-size: 0.8rem;
        }

        .table th.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
            color: var(--primary);
        }

        .table th.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
            color: var(--primary);
        }
        
        .table th:last-child {
            border-right: none;
        }

        .table td {
            padding: 15px 12px;
            border-bottom: 1px solid var(--light-gray);
            border-right: 1px solid #f0f0f0;
            vertical-align: middle;
            overflow: hidden;
            word-wrap: break-word;
        }
        
        .table td:last-child {
            border-right: none;
        }
        
        /* Set exact column widths */
        .table th:nth-child(1),
        .table td:nth-child(1) {
            width: 200px;
        }
        
        .table th:nth-child(2),
        .table td:nth-child(2) {
            width: 110px;
        }
        
        .table th:nth-child(3),
        .table td:nth-child(3) {
            width: 120px;
        }
        
        .table th:nth-child(4),
        .table td:nth-child(4) {
            width: 120px;
        }
        
        .table th:nth-child(5),
        .table td:nth-child(5) {
            width: 120px;
        }
        
        .table th:nth-child(6),
        .table td:nth-child(6) {
            width: 130px;
        }
        
        .table th:nth-child(7),
        .table td:nth-child(7) {
            width: 80px;
            text-align: center;
        }
        
        .table th:nth-child(8),
        .table td:nth-child(8) {
            width: 120px;
        }
        
        .table th:nth-child(9),
        .table td:nth-child(9) {
            width: 160px;
        }

        .table tr:hover {
            background: rgba(102, 126, 234, 0.03);
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: var(--transition);
            white-space: nowrap;
        }

        .btn-edit {
            background: var(--primary);
            color: white;
        }

        .btn-edit:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .btn-delete:hover {
            background: #ff5252;
            transform: translateY(-1px);
        }

        /* ===== DASHBOARD ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 28px;
            border-radius: 18px;
            border: 2px solid rgba(226, 232, 240, 0.6);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.03), transparent 70%);
            transition: var(--transition);
        }

        .stat-card:hover::before {
            top: -30%;
            right: -30%;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--primary);
            box-shadow: 
                0 12px 35px rgba(99, 102, 241, 0.15),
                0 0 0 1px rgba(99, 102, 241, 0.1);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .dashboard-card h3 {
            font-size: 1.2rem;
            color: var(--dark);
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ===== SETTINGS ===== */
        .settings-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }

        .settings-card h3 {
            font-size: 1.3rem;
            color: var(--dark);
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* ===== INVOICE STYLES ===== */
        .quick-filter-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray);
        }

        .quick-filter-btn:hover, .quick-filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .invoice-card {
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            padding: 20px;
            transition: var(--transition);
            cursor: pointer;
        }

        .invoice-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .invoice-card.exchanged {
            border-left: 4px solid var(--warning);
            background: #fff9e6;
        }

        .invoice-card.refunded {
            border-left: 4px solid var(--danger);
            background: #ffe6e6;
        }

        .invoice-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .invoice-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .invoice-badge.exchanged {
            background: #fff3cd;
            color: #856404;
        }

        .invoice-badge.refunded {
            background: #f8d7da;
            color: #721c24;
        }

        .categories-list {
            display: grid;
            gap: 12px;
            margin-top: 20px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--light);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 0;
            border-radius: 24px;
            max-width: 500px;
            width: 100%;
            border: 1px solid rgba(226, 232, 240, 0.6);
            box-shadow: 
                0 25px 60px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            padding: 28px 32px;
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(236, 72, 153, 0.05));
            border-bottom: 2px solid rgba(226, 232, 240, 0.6);
            position: relative;
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 32px;
            right: 32px;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #ec4899);
            border-radius: 3px;
        }

        .modal-close {
            background: rgba(226, 232, 240, 0.5);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            transform: rotate(90deg) scale(1.1);
        }

        .modal-body {
            margin-bottom: 25px;
            padding: 0 32px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            min-width: 100px;
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .modal-btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .modal-btn-cancel {
            background: var(--light-gray);
            color: var(--dark);
        }

        .modal-btn-cancel:hover {
            background: #d1d9e6;
        }

        /* ===== PAYMENT METHODS ===== */
        .payment-methods {
            display: grid;
            gap: 12px;
        }

        .payment-method-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
            transition: var(--transition);
            text-align: left;
        }

        .payment-method-btn:hover {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
            transform: translateX(5px);
        }
        
        @media (max-width: 768px) {
            .payment-method-btn {
                padding: 15px 15px;
                gap: 12px;
                font-size: 0.95rem;
            }
        }
        
        @media (max-width: 480px) {
            .payment-method-btn {
                padding: 12px 12px;
                gap: 10px;
                font-size: 0.9rem;
            }
        }

        .payment-method-icon {
            font-size: 1.8rem;
            width: 40px;
            text-align: center;
        }

        /* ===== RECEIPT ===== */
        .receipt {
            width: 100%;
            max-width: 400px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        
        @media (max-width: 768px) {
            .receipt {
                max-width: 95vw;
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .receipt {
                max-width: 100%;
                padding: 15px;
                border-radius: 8px;
            }
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed var(--dark);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .receipt-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .receipt-shop-info {
            font-size: 0.85rem;
            color: var(--gray);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .receipt-date {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .receipt-items {
            margin-bottom: 20px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
            padding-bottom: 8px;
            border-bottom: 1px dashed var(--light-gray);
        }

        .receipt-item-name {
            flex: 1;
        }

        .receipt-item-qty {
            width: 40px;
            text-align: center;
        }

        .receipt-item-price {
            width: 80px;
            text-align: right;
            font-weight: 600;
        }

        .receipt-totals {
            border-top: 2px dashed var(--dark);
            padding-top: 15px;
            margin-top: 15px;
        }

        .receipt-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .receipt-total-row.grand-total {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--light-gray);
        }

        .receipt-payment {
            margin: 15px 0;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .receipt-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed var(--light-gray);
            font-size: 0.85rem;
            color: var(--gray);
            line-height: 1.5;
        }

        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .empty-state-subtext {
            font-size: 0.95rem;
            opacity: 0.7;
        }
        
        @media (max-width: 768px) {
            .empty-state {
                padding: 40px 15px;
            }
            
            .empty-state-icon {
                font-size: 2.5rem;
                margin-bottom: 15px;
            }
            
            .empty-state-text {
                font-size: 1rem;
            }
            
            .empty-state-subtext {
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            .empty-state {
                padding: 30px 12px;
            }
            
            .empty-state-icon {
                font-size: 2rem;
                margin-bottom: 12px;
            }
            
            .empty-state-text {
                font-size: 0.95rem;
                margin-bottom: 8px;
            }
            
            .empty-state-subtext {
                font-size: 0.85rem;
            }
        }

        /* ===== ALERT CARDS ===== */
        .alert-card {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #e8f5e9;
            border-left-color: var(--success);
        }

        .alert-warning {
            background: #fff3cd;
            border-left-color: var(--warning);
        }

        .alert-danger {
            background: #ffebee;
            border-left-color: var(--danger);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        
        /* ===== TABLETS & SMALL SCREENS (768px - 1024px) ===== */
        @media (max-width: 1024px) {
            body {
                padding: 15px;
            }
            
            .container {
                min-height: calc(100vh - 30px);
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .reset-btn {
                top: 15px;
                right: 15px;
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .content {
                padding: 25px;
            }
            
            .pos-container {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .cart-section {
                position: relative;
                top: 0;
                height: auto;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 15px;
            }
            
            .product-card {
                padding: 15px;
            }
            
            .product-icon {
                font-size: 2rem;
                height: 50px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .inventory-controls {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                padding: 20px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .table-container {
                font-size: 0.9rem;
            }
            
            .table th,
            .table td {
                padding: 12px 10px;
            }
        }
        
        /* ===== MOBILE SCREENS (481px - 768px) ===== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                min-height: calc(100vh - 20px);
                border-radius: 8px;
            }
            
            .header {
                padding: 15px 12px;
            }
            
            .header h1 {
                font-size: 1.4rem;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            .reset-btn {
                top: 10px;
                right: 10px;
                padding: 5px 10px;
                font-size: 0.75rem;
            }
            
            .nav-tabs {
                flex-direction: column;
                border-bottom: 1px solid var(--light-gray);
            }
            
            .nav-tab {
                text-align: left;
                padding: 12px 15px;
                font-size: 0.9rem;
                border-bottom: 1px solid var(--light-gray);
            }
            
            .nav-tab.active {
                background: rgba(102, 126, 234, 0.1);
                border-left: 4px solid var(--primary);
                padding-left: calc(15px - 4px);
            }
            
            .nav-tab.active::after {
                display: none;
            }
            
            .content {
                padding: 15px;
            }
            
            .section-title {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }
            
            .pos-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 12px;
            }
            
            .product-card {
                padding: 12px;
                border-radius: 8px;
            }
            
            .product-icon {
                font-size: 1.8rem;
                height: 45px;
                margin-bottom: 8px;
            }
            
            .product-name {
                font-size: 0.85rem;
                margin-bottom: 5px;
            }
            
            .product-price {
                font-size: 0.95rem;
                margin-bottom: 3px;
            }
            
            .product-stock {
                font-size: 0.75rem;
                margin-bottom: 10px;
            }
            
            .add-btn {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            
            .cart-section {
                padding: 20px;
                border-radius: 8px;
            }
            
            .cart-title {
                font-size: 1.1rem;
            }
            
            .cart-count {
                font-size: 0.75rem;
                padding: 3px 10px;
            }
            
            .cart-items {
                max-height: 300px;
            }
            
            .cart-item {
                padding: 12px;
                margin-bottom: 10px;
                gap: 10px;
            }
            
            .cart-item-name {
                font-size: 0.85rem;
            }
            
            .cart-item-icon {
                font-size: 1.3rem;
            }
            
            .qty-btn {
                width: 24px;
                height: 24px;
                font-size: 0.9rem;
            }
            
            .qty-display {
                min-width: 25px;
                font-size: 0.9rem;
            }
            
            .remove-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
            }
            
            .checkout-btn,
            .clear-cart-btn {
                font-size: 0.9rem;
                padding: 12px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-label {
                font-size: 0.85rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .inventory-controls {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 15px;
            }
            
            .input-group input,
            .input-group select {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .input-group label {
                font-size: 0.85rem;
            }
            
            .add-product-btn {
                width: 100%;
                align-self: auto;
                padding: 10px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                font-size: 0.85rem;
            }
            
            .table th,
            .table td {
                padding: 10px 8px;
                font-size: 0.8rem;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 0.75rem;
                width: 100%;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .dashboard-card {
                padding: 20px;
            }
            
            .dashboard-card h3 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            
            .settings-card {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .settings-card h3 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            
            /* Modal responsive */
            .modal-content {
                width: 90%;
                max-width: 90%;
                max-height: 90vh;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-body {
                padding: 15px;
                max-height: calc(90vh - 100px);
                overflow-y: auto;
            }
            
            .modal-footer {
                padding: 15px;
                gap: 10px;
            }
            
            .modal-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
                flex: 1;
            }
        }
        
        /* ===== SMALL MOBILE (up to 480px) ===== */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                border-radius: 0;
                min-height: 100vh;
            }
            
            .header {
                padding: 12px 10px;
            }
            
            .header h1 {
                font-size: 1.2rem;
                margin-bottom: 4px;
            }
            
            .header p {
                font-size: 0.75rem;
            }
            
            .reset-btn {
                top: 8px;
                right: 8px;
                padding: 4px 8px;
                font-size: 0.7rem;
            }
            
            .nav-tab {
                padding: 10px 12px;
                font-size: 0.8rem;
            }
            
            .content {
                padding: 10px;
            }
            
            .section-title {
                font-size: 1.1rem;
                margin-bottom: 12px;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 10px;
            }
            
            .product-card {
                padding: 10px;
            }
            
            .product-icon {
                font-size: 1.5rem;
                height: 40px;
            }
            
            .product-name {
                font-size: 0.75rem;
            }
            
            .product-price {
                font-size: 0.85rem;
            }
            
            .product-stock {
                font-size: 0.7rem;
            }
            
            .add-btn {
                font-size: 0.7rem;
                padding: 6px 8px;
            }
            
            .cart-section {
                padding: 15px;
            }
            
            .cart-item {
                padding: 10px;
            }
            
            .qty-btn {
                width: 20px;
                height: 20px;
                font-size: 0.8rem;
            }
            
            .stats-grid {
                gap: 12px;
            }
            
            .stat-card {
                padding: 12px;
                border-left-width: 3px;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
            
            .stat-value {
                font-size: 1.3rem;
            }
            
            .inventory-controls {
                gap: 10px;
                padding: 12px;
            }
            
            .table th,
            .table td {
                padding: 8px 6px;
                font-size: 0.75rem;
            }
            
            .btn {
                padding: 5px 8px;
                font-size: 0.7rem;
            }
            
            .modal-content {
                width: 95%;
                max-width: 95%;
            }
            
            .input-group input,
            .input-group select {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            
            .action-buttons {
                gap: 3px;
            }
        }
        
        /* ===== HORIZONTAL SCROLL FOR TABLES ===== */
        @media (max-width: 768px) {
            .table {
                font-size: 0.8rem;
                min-width: 1100px;
            }
            
            .table th {
                white-space: nowrap;
                padding: 10px 8px;
                min-width: 70px;
                font-size: 0.8rem;
            }
            
            .table th:nth-child(1) {
                min-width: 140px;
            }
            
            .table th:nth-child(2) {
                min-width: 90px;
            }
            
            .table th:nth-child(3),
            .table th:nth-child(4),
            .table th:nth-child(5),
            .table th:nth-child(6) {
                min-width: 100px;
            }
            
            .table th:nth-child(9) {
                min-width: 140px;
            }
            
            .table td {
                padding: 10px 8px;
                white-space: nowrap;
                font-size: 0.8rem;
            }
            
            .action-buttons {
                gap: 5px;
            }
            
            .btn {
                padding: 6px 8px;
                font-size: 0.7rem;
            }
        }
        
        @media (max-width: 480px) {
            .table {
                font-size: 0.75rem;
                min-width: 1000px;
            }
            
            .table th {
                padding: 8px 6px;
                min-width: 60px;
                font-size: 0.75rem;
            }
            
            .table th:nth-child(1) {
                min-width: 120px;
            }
            
            .table th:nth-child(2) {
                min-width: 80px;
            }
            
            .table th:nth-child(3),
            .table th:nth-child(4),
            .table th:nth-child(5),
            .table th:nth-child(6) {
                min-width: 90px;
            }
            
            .table th:nth-child(9) {
                min-width: 130px;
            }
            
            .table td {
                padding: 8px 6px;
                font-size: 0.75rem;
            }
            
            .btn {
                padding: 5px 6px;
                font-size: 0.65rem;
            }
        }
        
        /* ===== STICKY HEADER FOR MOBILE ===== */
        @media (max-width: 768px) {
            .header {
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .nav-tabs {
                position: sticky;
                top: 70px;
                z-index: 99;
            }
        }
        
        /* ===== TOUCH-FRIENDLY BUTTONS ===== */
        @media (max-width: 768px) {
            .btn,
            .checkout-btn,
            .clear-cart-btn,
            .add-product-btn,
            .nav-tab {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            * {
                margin: 0;
                padding: 0;
            }
            
            html, body {
                background: white;
                margin: 0;
                padding: 0;
                width: 100%;
                height: auto;
            }
            
            .container,
            .modal:not(#receiptModal) {
                display: none !important;
            }
            
            #receiptModal {
                position: static !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                display: block !important;
                align-items: auto !important;
                justify-content: auto !important;
                z-index: 10000 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .receipt {
                width: 100%;
                max-width: 400px;
                margin: 0 auto;
                padding: 20px;
                box-shadow: none;
                border-radius: 0;
                page-break-after: avoid;
            }
            
            .receipt-buttons {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè™ Supermarket Management System</h1>
            <p>Point of Sale - Inventory Management - Analytics Dashboard</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="pos" onclick="switchTab('pos')">üõí POS</button>
            <button class="nav-tab" data-tab="inventory" onclick="switchTab('inventory')">üì¶ Inventory</button>
            <button class="nav-tab" data-tab="invoices" onclick="switchTab('invoices')">ÔøΩ Invoices</button>
            <button class="nav-tab" data-tab="invoices" onclick="switchTab('invoices')">üìÑ Invoices</button>
            <button class="nav-tab" data-tab="promotions" onclick="switchTab('promotions')">üéâ Promotions</button>
            <button class="nav-tab" data-tab="expenses" onclick="switchTab('expenses')">üí∞ Expenses</button>
            <button class="nav-tab" data-tab="suppliers" onclick="switchTab('suppliers')">üè™ Suppliers</button>
            <button class="nav-tab" data-tab="dashboard" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" data-tab="admin" onclick="switchTab('admin')">üîê Admin</button>
            <button class="nav-tab" data-tab="settings" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <div class="content">
            <!-- POS Section -->
            <div id="pos" class="section active">
                <h2 class="section-title">üí≥ Point of Sale</h2>
                
                <!-- Search and Barcode -->
                <div class="pos-header">
                    <div class="pos-search">
                        <input type="text" id="posSearch" placeholder="üîç Search products by name..." oninput="filterPOSProducts()">
                    </div>
                    <div class="barcode-input">
                        <input type="text" id="barcodeInput" placeholder="üì∑ Scan barcode or enter code" onkeypress="handleBarcodeInput(event)" autocomplete="off">
                        <button class="btn btn-edit" onclick="document.getElementById('barcodeInput').focus()" style="margin-left: 8px; padding: 10px 16px;" title="Focus barcode scanner">üì∑</button>
                    </div>
                </div>

                <div class="pos-container">
                    <div>
                        <div class="products-grid" id="productsGrid"></div>
                    </div>
                    <div class="cart-section">
                        <!-- Customer Information -->
                        <div class="customer-info-card">
                            <h3>üë§ Customer Details</h3>
                            <div class="customer-form">
                                <input type="text" id="customerName" placeholder="Customer Name (Optional)">
                                <input type="tel" id="customerPhone" placeholder="Phone Number">
                            </div>
                        </div>

                        <div class="cart-header">
                            <div class="cart-title">Shopping Cart</div>
                            <div class="cart-count" id="cartCount">0 items</div>
                        </div>
                        <div class="cart-items" id="cartItems"></div>
                        
                        <!-- Discount & Tax Section -->
                        <div class="discount-tax-section">
                            <h4>üè∑Ô∏è Discount & Tax</h4>
                            <div class="discount-tax-controls">
                                <select id="discountType" onchange="calculateBill()">
                                    <option value="none">No Discount</option>
                                    <option value="percentage">Percentage (%)</option>
                                    <option value="fixed">Fixed Amount (‚Çπ)</option>
                                </select>
                                <input type="number" id="discountValue" placeholder="0" min="0" step="0.01" oninput="calculateBill()">
                                <select id="taxType" onchange="calculateBill()">
                                    <option value="0">No Tax</option>
                                    <option value="5">GST 5%</option>
                                    <option value="12">GST 12%</option>
                                    <option value="18">GST 18%</option>
                                    <option value="28">GST 28%</option>
                                </select>
                                <input type="number" id="customTax" placeholder="Custom %" min="0" max="100" step="0.1" oninput="applyCustomTax()">
                            </div>
                            <div class="quick-discount-btns">
                                <button class="quick-discount-btn" onclick="applyQuickDiscount(5)">5% Off</button>
                                <button class="quick-discount-btn" onclick="applyQuickDiscount(10)">10% Off</button>
                                <button class="quick-discount-btn" onclick="applyQuickDiscount(15)">15% Off</button>
                                <button class="quick-discount-btn" onclick="applyQuickDiscount(20)">20% Off</button>
                            </div>
                        </div>

                        <div class="cart-summary">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="subtotal">‚Çπ0.00</span>
                            </div>
                            <div class="summary-row" id="discountRow" style="display: none; color: var(--success);">
                                <span>Discount:</span>
                                <span id="discountAmount">-‚Çπ0.00</span>
                            </div>
                            <div class="summary-row" id="promotionRow" style="display: none; color: var(--success);">
                                <span>üéÅ Promotion:</span>
                                <span id="promotionAmount">-‚Çπ0.00</span>
                            </div>
                            <div class="summary-row" id="couponRow" style="display: none; color: var(--success);">
                                <span>üé´ Coupon <span id="appliedCouponCode"></span>:</span>
                                <span>
                                    <span id="couponAmount">-‚Çπ0.00</span>
                                    <button onclick="removeCoupon()" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0 5px; font-size: 1rem;" title="Remove coupon">√ó</button>
                                </span>
                            </div>
                            <div class="summary-row" id="taxRow" style="display: none;">
                                <span>Tax (<span id="taxRate">0</span>%):</span>
                                <span id="taxAmount">‚Çπ0.00</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total Amount:</span>
                                <span id="total">‚Çπ0.00</span>
                            </div>
                            <button class="checkout-btn" id="checkoutBtn" onclick="showPaymentModal()" disabled>
                                üí≥ Complete Purchase
                            </button>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <button class="exchange-refund-btn" onclick="showQuickExchangeRefund('exchange')" style="background: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: var(--transition);">
                                    üîÑ Exchange
                                </button>
                                <button class="exchange-refund-btn" onclick="showQuickExchangeRefund('refund')" style="background: var(--warning); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: var(--transition);">
                                    üí∞ Refund
                                </button>
                            </div>
                            
                            <button onclick="showApplyCouponModal()" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: var(--transition);">
                                üé´ Apply Coupon Code
                            </button>
                            
                            <button class="clear-cart-btn" onclick="clearCart()">
                                üóëÔ∏è Clear Cart
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Section -->
            <div id="inventory" class="section">
                <h2 class="section-title">Manage Inventory</h2>
                
                <!-- Quick Stats -->
                <div class="inventory-quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-label">Total Products</div>
                        <div class="quick-stat-value" id="totalProducts">0</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-label">Total Stock Units</div>
                        <div class="quick-stat-value" id="totalUnits">0</div>
                    </div>
                    <div class="quick-stat" style="border-left-color: var(--warning);">
                        <div class="quick-stat-label">Low Stock Items</div>
                        <div class="quick-stat-value" id="lowStockCount" style="color: var(--warning);">0</div>
                    </div>
                    <div class="quick-stat" style="border-left-color: var(--danger);">
                        <div class="quick-stat-label">Out of Stock</div>
                        <div class="quick-stat-value" id="outOfStockCount" style="color: var(--danger);">0</div>
                    </div>
                    <div class="quick-stat" style="border-left-color: var(--success);">
                        <div class="quick-stat-label">Total Inventory Value</div>
                        <div class="quick-stat-value" id="totalInventoryValue" style="color: var(--success);">‚Çπ0</div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="inventory-header">
                    <div class="inventory-search-bar">
                        <input type="text" id="inventorySearch" placeholder="Search products by name, category..." oninput="filterInventory()">
                        <button class="clear-search" onclick="clearInventorySearch()">‚úï</button>
                    </div>
                    <div class="inventory-filters">
                        <select id="categoryFilter" class="filter-btn" onchange="filterInventory()" style="padding: 8px 16px;">
                            <option value="">All Categories</option>
                        </select>
                        <select id="stockFilter" class="filter-btn" onchange="filterInventory()" style="padding: 8px 16px;">
                            <option value="">All Stock Levels</option>
                            <option value="in-stock">In Stock</option>
                            <option value="low-stock">Low Stock</option>
                            <option value="out-of-stock">Out of Stock</option>
                        </select>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="bulk-actions">
                    <button class="bulk-action-btn" onclick="exportInventoryCSV()">
                        <span>üì•</span> Export CSV
                    </button>
                    <button class="bulk-action-btn" onclick="document.getElementById('importCSV').click()">
                        <span>üì§</span> Import CSV
                    </button>
                    <input type="file" id="importCSV" accept=".csv" style="display: none;" onchange="importInventoryCSV(event)">
                    <button class="bulk-action-btn" onclick="printInventoryReport()">
                        <span>üñ®Ô∏è</span> Print Report
                    </button>
                    <button class="bulk-action-btn" onclick="toggleAddProductForm()">
                        <span>‚ûï</span> Add New Product
                    </button>
                </div>
                
                <!-- Add Product Form (Collapsible) -->
                <div class="inventory-controls" id="addProductForm" style="display: none;">
                    <div class="input-group">
                        <label>Product Name *</label>
                        <input type="text" id="productName" placeholder="Enter product name">
                    </div>
                    <div class="input-group">
                        <label>Product Icon *</label>
                        <input type="text" id="productIcon" placeholder="e.g., üçé">
                    </div>
                    <div class="input-group">
                        <label>Barcode <span style="font-size: 0.85rem; color: var(--gray);">(Auto-generated)</span></label>
                        <input type="text" id="productBarcode" placeholder="Auto-generated" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="input-group">
                        <label>Category *</label>
                        <select id="productCategory"></select>
                    </div>
                    <div class="input-group">
                        <label>MRP (‚Çπ) *</label>
                        <input type="number" id="productMRP" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="input-group">
                        <label>Cost Price (‚Çπ) *</label>
                        <input type="number" id="productCostPrice" placeholder="0.00" step="0.01" min="0" oninput="calculateProfitMargin()">
                    </div>
                    <div class="input-group">
                        <label>Selling Price (‚Çπ) *</label>
                        <input type="number" id="productPrice" placeholder="0.00" step="0.01" min="0" oninput="calculateProfitMargin()">
                    </div>
                    <div class="input-group">
                        <label>Initial Stock *</label>
                        <input type="number" id="productQty" placeholder="0" min="0">
                    </div>
                    <div class="input-group">
                        <label>Min Stock Threshold <span style="font-size: 0.85rem; color: var(--gray);">(Low Stock Alert)</span></label>
                        <input type="number" id="productMinStock" placeholder="10" min="0" value="10">
                    </div>
                    <div class="input-group">
                        <label>Supplier <span style="font-size: 0.85rem; color: var(--gray);">(Optional)</span></label>
                        <select id="productSupplier">
                            <option value="">-- Select Supplier --</option>
                        </select>
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label>Profit Margin</label>
                        <div id="profitMarginDisplay" style="padding: 12px; background: white; border-radius: 8px; font-weight: 600; color: var(--success);">-</div>
                    </div>
                    <div style="display: flex; gap: 10px; grid-column: 1 / -1;">
                        <button class="add-product-btn" onclick="addProduct()" style="flex: 1;">
                            ‚úÖ Add Product
                        </button>
                        <button class="add-product-btn" onclick="toggleAddProductForm()" style="flex: 1; background: var(--light-gray); color: var(--gray);">
                            ‚úï Cancel
                        </button>
                    </div>
                </div>

                <!-- Inventory Table -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortInventory('name')">Product</th>
                                <th class="sortable" onclick="sortInventory('category')">Category</th>
                                <th>Barcode</th>
                                <th class="sortable" onclick="sortInventory('mrp')">MRP</th>
                                <th class="sortable" onclick="sortInventory('costPrice')">Cost Price</th>
                                <th class="sortable" onclick="sortInventory('price')">Selling Price</th>
                                <th class="sortable" onclick="sortInventory('profit')">Profit</th>
                                <th class="sortable" onclick="sortInventory('qty')">Stock</th>
                                <th class="sortable" onclick="sortInventory('status')">Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <h2 class="section-title">Sales Dashboard & Analytics</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-label">Total Sales Revenue</div>
                        <div class="stat-value" id="totalSales">‚Çπ0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-label">Total Transactions</div>
                        <div class="stat-value" id="totalTransactions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-label">Total Stock Value</div>
                        <div class="stat-value" id="stockValue">‚Çπ0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-label">Items in Stock</div>
                        <div class="stat-value" id="totalStock">0</div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>‚ö†Ô∏è Low Stock Alert</h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Current Stock</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="lowStockList"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <h3>üì¶ Stock by Category</h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody id="stockByCategory"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>üìä Sales by Product</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Units Sold</th>
                                    <th>Revenue</th>
                                    <th>Current Stock</th>
                                </tr>
                            </thead>
                            <tbody id="salesByProduct"></tbody>
                        </table>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>üìú Recent Transactions</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Amount</th>
                                    <th>Payment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Panel Section -->
            <div id="admin" class="section">
                <!-- Login Screen -->
                <div id="adminLogin" class="admin-login">
                    <div class="admin-login-card">
                        <h2>üîê Admin Access</h2>
                        <p>Enter your 4-digit PIN to access admin panel</p>
                        <div class="pin-input-container">
                            <input type="password" class="pin-input" maxlength="1" id="pin1" oninput="movePinFocus(1)" onkeydown="handlePinBackspace(event, 1)">
                            <input type="password" class="pin-input" maxlength="1" id="pin2" oninput="movePinFocus(2)" onkeydown="handlePinBackspace(event, 2)">
                            <input type="password" class="pin-input" maxlength="1" id="pin3" oninput="movePinFocus(3)" onkeydown="handlePinBackspace(event, 3)">
                            <input type="password" class="pin-input" maxlength="1" id="pin4" oninput="movePinFocus(4)" onkeydown="handlePinBackspace(event, 4)">
                        </div>
                        <button class="add-product-btn" onclick="verifyAdminPin()" style="width: 100%;">
                            üîì Unlock Admin Panel
                        </button>
                        <p style="margin-top: 20px; font-size: 0.85rem; color: var(--gray);">
                            Default PIN: 1234<br>
                            Change it after first login
                        </p>
                    </div>
                </div>

                <!-- Admin Content -->
                <div id="adminContent" class="admin-content">
                    <div class="admin-header">
                        <div>
                            <h2>üë®‚Äçüíº Admin Dashboard</h2>
                            <p style="margin: 0; opacity: 0.9;">Full system control and management</p>
                        </div>
                        <button class="admin-logout-btn" onclick="logoutAdmin()">
                            üö™ Logout
                        </button>
                    </div>

                    <!-- Quick Actions -->
                    <div class="admin-card">
                        <h3>‚ö° Quick Actions</h3>
                        <div class="admin-action-grid">
                            <button class="admin-action-btn" onclick="showBulkStockUpdate()">
                                <span class="icon">üì¶</span>
                                Bulk Stock Update
                            </button>
                            <button class="admin-action-btn" onclick="openChangePinModal()">
                                <span class="icon">üîë</span>
                                Change PIN
                            </button>
                            <button class="admin-action-btn" onclick="exportAllData()">
                                <span class="icon">üíæ</span>
                                Export All Data
                            </button>
                            <button class="admin-action-btn" onclick="viewSystemLogs()">
                                <span class="icon">üìã</span>
                                System Logs
                            </button>
                        </div>
                    </div>

                    <!-- Quick Stock Management -->
                    <div class="admin-grid">
                        <div class="admin-card">
                            <h3>üìä Quick Stock Adjustments</h3>
                            <div id="quickStockList" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>

                        <div class="admin-card">
                            <h3>‚ö†Ô∏è Stock Alerts</h3>
                            <div id="adminStockAlerts"></div>
                        </div>
                    </div>

                    <!-- Advanced Stock Management -->
                    <div class="admin-card">
                        <h3>üîß Advanced Stock Management</h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Current Stock</th>
                                        <th>Add Stock</th>
                                        <th>Remove Stock</th>
                                        <th>Set Stock</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminStockTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- System Statistics -->
                    <div class="admin-card">
                        <h3>üìà System Statistics</h3>
                        <div class="inventory-quick-stats">
                            <div class="quick-stat">
                                <div class="quick-stat-label">Total Revenue</div>
                                <div class="quick-stat-value" id="adminTotalRevenue">‚Çπ0</div>
                            </div>
                            <div class="quick-stat" style="border-left-color: var(--success);">
                                <div class="quick-stat-label">Total Profit</div>
                                <div class="quick-stat-value" id="adminTotalProfit" style="color: var(--success);">‚Çπ0</div>
                            </div>
                            <div class="quick-stat" style="border-left-color: var(--warning);">
                                <div class="quick-stat-label">Products Sold</div>
                                <div class="quick-stat-value" id="adminProductsSold">0</div>
                            </div>
                            <div class="quick-stat" style="border-left-color: var(--danger);">
                                <div class="quick-stat-label">Avg Order Value</div>
                                <div class="quick-stat-value" id="adminAvgOrder">‚Çπ0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoices Section -->
            <div id="invoices" class="section">
                <h2 class="section-title">üßØ Invoice History & Search</h2>
                
                <!-- Search and Filters -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 15px; margin-bottom: 15px;">
                        <div class="input-group" style="margin: 0;">
                            <label style="font-size: 0.85rem; margin-bottom: 5px;">üîç Search Invoice</label>
                            <input type="text" id="invoiceSearch" placeholder="Invoice #, customer name, or amount" oninput="filterInvoices()" style="padding: 10px;">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label style="font-size: 0.85rem; margin-bottom: 5px;">From Date</label>
                            <input type="date" id="invoiceDateFrom" onchange="filterInvoices()" style="padding: 10px;">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label style="font-size: 0.85rem; margin-bottom: 5px;">To Date</label>
                            <input type="date" id="invoiceDateTo" onchange="filterInvoices()" style="padding: 10px;">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label style="font-size: 0.85rem; margin-bottom: 5px;">Payment Method</label>
                            <select id="invoicePaymentFilter" onchange="filterInvoices()" style="padding: 10px;">
                                <option value="all">All Methods</option>
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="UPI">UPI</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button onclick="clearInvoiceFilters()" class="btn btn-delete" style="padding: 10px 20px; white-space: nowrap;">‚ùå Clear</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="filterInvoicesByPeriod('today')" class="quick-filter-btn">Today</button>
                        <button onclick="filterInvoicesByPeriod('week')" class="quick-filter-btn">This Week</button>
                        <button onclick="filterInvoicesByPeriod('month')" class="quick-filter-btn">This Month</button>
                        <button onclick="filterInvoicesByPeriod('all')" class="quick-filter-btn">All Time</button>
                    </div>
                </div>

                <!-- Invoice Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="totalInvoicesCount">0</div>
                        <div class="stat-label">Total Invoices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="totalInvoicesAmount">‚Çπ0.00</div>
                        <div class="stat-label">Total Amount</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="completedInvoicesCount">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üîÑ</div>
                        <div class="stat-value" id="exchangedInvoicesCount">0</div>
                        <div class="stat-label">Exchanged</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-value" id="refundedInvoicesCount">0</div>
                        <div class="stat-label">Refunded</div>
                    </div>
                </div>

                <!-- Invoices List -->
                <div id="invoicesList" style="display: grid; gap: 15px;">
                    <!-- Invoices will be populated here -->
                </div>
            </div>

            <!-- Promotions Section -->
            <div id="promotions" class="section">
                <h2 class="section-title">üéÅ Promotions & Offers</h2>
                
                <!-- Quick Actions -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <button onclick="showPromotionModal('bogo')" class="promo-type-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: var(--transition);">
                        üéØ Buy 1 Get 1
                    </button>
                    <button onclick="showPromotionModal('bundle')" class="promo-type-btn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: var(--transition);">
                        üì¶ Bundle Deal
                    </button>
                    <button onclick="showPromotionModal('timebased')" class="promo-type-btn" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; padding: 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: var(--transition);">
                        ‚è∞ Happy Hour
                    </button>
                    <button onclick="showPromotionModal('seasonal')" class="promo-type-btn" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; border: none; padding: 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: var(--transition);">
                        üåü Seasonal
                    </button>
                    <button onclick="showPromotionModal('coupon')" class="promo-type-btn" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border: none; padding: 20px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: var(--transition);">
                        üé´ Coupon Code
                    </button>
                </div>

                <!-- Active Promotions Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-icon">üéÅ</div>
                        <div class="stat-value" id="totalPromotions">0</div>
                        <div class="stat-label">Total Promotions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="activePromotions">0</div>
                        <div class="stat-label">Active Now</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="promotionSavings">‚Çπ0.00</div>
                        <div class="stat-label">Total Savings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="promotionUsage">0</div>
                        <div class="stat-label">Times Used</div>
                    </div>
                </div>

                <!-- Promotions List -->
                <div id="promotionsList" style="display: grid; gap: 15px;">
                    <!-- Promotions will be populated here -->
                </div>
            </div>

            <!-- Expenses Section -->
            <div id="expenses" class="section">
                <h2 class="section-title">üí∞ Expense Tracking</h2>
                
                <!-- Add Expense Card -->
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px;">
                    <h3 style="margin-bottom: 20px; color: var(--dark);">‚ûï Record New Expense</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="input-group" style="margin: 0;">
                            <label>Date</label>
                            <input type="date" id="expenseDate">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Category</label>
                            <select id="expenseCategory">
                                <option value="Rent">üè¢ Rent</option>
                                <option value="Utilities">üí° Utilities</option>
                                <option value="Salaries">üë• Salaries</option>
                                <option value="Supplies">üì¶ Supplies</option>
                                <option value="Maintenance">üîß Maintenance</option>
                                <option value="Transport">üöó Transport</option>
                                <option value="Marketing">üì¢ Marketing</option>
                                <option value="Other">üìù Other</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Amount (‚Çπ)</label>
                            <input type="number" id="expenseAmount" placeholder="0.00" step="0.01" min="0">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Description</label>
                            <input type="text" id="expenseDescription" placeholder="e.g., Monthly electricity bill">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button onclick="addExpense()" class="add-product-btn" style="width: 100%; margin: 0;">‚ûï Add Expense</button>
                        </div>
                    </div>
                </div>

                <!-- Expense Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-icon">üí∏</div>
                        <div class="stat-value" id="totalExpensesToday">‚Çπ0.00</div>
                        <div class="stat-label">Today's Expenses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-value" id="totalExpensesMonth">‚Çπ0.00</div>
                        <div class="stat-label">This Month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíπ</div>
                        <div class="stat-value" id="profitThisMonth">‚Çπ0.00</div>
                        <div class="stat-label">Net Profit (Month)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="cashFlow">‚Çπ0.00</div>
                        <div class="stat-label">Cash Flow</div>
                    </div>
                </div>

                <!-- Expense Filters -->
                <div style="background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="filterExpensesByPeriod('today')" class="quick-filter-btn">Today</button>
                        <button onclick="filterExpensesByPeriod('week')" class="quick-filter-btn">This Week</button>
                        <button onclick="filterExpensesByPeriod('month')" class="quick-filter-btn active">This Month</button>
                        <button onclick="filterExpensesByPeriod('all')" class="quick-filter-btn">All Time</button>
                    </div>
                </div>

                <!-- Expenses List -->
                <div id="expensesList">
                    <!-- Expenses will be populated here -->
                </div>
            </div>

            <!-- Suppliers Section -->
            <div id="suppliers" class="section">
                <h2 class="section-title">üè™ Supplier Management</h2>
                
                <!-- Add Supplier Button -->
                <button onclick="showAddSupplierModal()" class="add-product-btn" style="margin-bottom: 20px;">
                    ‚ûï Add New Supplier
                </button>

                <!-- Suppliers Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-icon">üè™</div>
                        <div class="stat-value" id="totalSuppliersCount">0</div>
                        <div class="stat-label">Total Suppliers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-value" id="totalPurchaseOrders">0</div>
                        <div class="stat-label">Purchase Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è∞</div>
                        <div class="stat-value" id="pendingPayments">0</div>
                        <div class="stat-label">Pending Payments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="totalPayableAmount">‚Çπ0.00</div>
                        <div class="stat-label">Total Payable</div>
                    </div>
                </div>

                <!-- Suppliers List -->
                <div id="suppliersList" style="display: grid; gap: 15px;">
                    <!-- Suppliers will be populated here -->
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section">
                <div class="settings-card">
                    <h3>Manage Categories</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="input-group">
                            <label>Category Name</label>
                            <input type="text" id="newCategoryName" placeholder="e.g., Snacks">
                        </div>
                        <div class="input-group">
                            <label>Category Icon/Emoji</label>
                            <input type="text" id="newCategoryIcon" placeholder="e.g., üçø" maxlength="2">
                        </div>
                    </div>
                    <button class="add-product-btn" onclick="addCategory()" style="width: 100%; margin-bottom: 20px;">
                        ‚ûï Add New Category
                    </button>
                    
                    <div class="categories-list" id="categoriesList"></div>
                </div>

                <div class="settings-card">
                    <h3>Shop Details</h3>
                    <div style="display: grid; gap: 20px;">
                        <div class="input-group">
                            <label>Shop Name</label>
                            <input type="text" id="shopName" placeholder="Enter your shop name">
                        </div>
                        <div class="input-group">
                            <label>Shop Address</label>
                            <textarea id="shopAddress" placeholder="Enter your shop address" rows="3"></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="input-group">
                                <label>Phone Number</label>
                                <input type="tel" id="shopPhone" placeholder="Enter your phone number">
                            </div>
                            <div class="input-group">
                                <label>Email Address</label>
                                <input type="email" id="shopEmail" placeholder="Enter your email address">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>GST Number (Optional)</label>
                            <input type="text" id="shopGST" placeholder="Enter your GST number">
                        </div>
                        <div class="input-group">
                            <label>Receipt Footer Message</label>
                            <textarea id="shopFooter" placeholder="Thank you for shopping with us!" rows="2"></textarea>
                        </div>
                    </div>
                    <button class="add-product-btn" onclick="saveShopSettings()" style="width: 100%; margin-top: 20px;">
                        üíæ Save Shop Settings
                    </button>
                </div>

                <div class="settings-card">
                    <h3>üì± App Installation</h3>
                    <p style="margin-bottom: 15px; color: var(--gray); font-size: 0.9rem;">
                        Install this app on all your devices for easy access and offline support.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button class="add-product-btn" onclick="installAppForAllDevices()" style="width: 100%; background: var(--success);">
                            ‚¨áÔ∏è Install App Now
                        </button>
                        <button class="add-product-btn" onclick="showInstallationGuide()" style="width: 100%; background: var(--primary);">
                            üìñ Installation Guide
                        </button>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: var(--light); border-radius: 8px; font-size: 0.85rem; color: var(--gray);">
                        <strong>Benefits:</strong>
                        <ul style="margin-top: 8px; margin-left: 20px;">
                            <li>Access the app on desktop, tablet, and mobile devices</li>
                            <li>Work offline when internet is unavailable</li>
                            <li>Fast loading with app-like experience</li>
                            <li>Sync data across all your devices</li>
                        </ul>
                    </div>
                </div>

                <div class="alert-card alert-info">
                    <h3 style="margin-bottom: 10px;">‚ÑπÔ∏è Information</h3>
                    <p>
                        The shop details you enter here will appear on all printed bills and receipts. 
                        This helps your customers identify your business and includes important contact information.
                    </p>
                </div>

                <div class="alert-card alert-danger">
                    <h3 style="margin-bottom: 10px;">‚ö†Ô∏è Danger Zone</h3>
                    <p style="margin-bottom: 15px;">
                        This will permanently delete all data including products, transactions, and settings.
                        This action cannot be undone.
                    </p>
                    <button class="btn btn-delete" onclick="clearAllData()" style="width: 100%; padding: 12px;">
                        üóëÔ∏è Clear All Data & Start Fresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="receipt" id="receipt"></div>
    </div>

    <!-- Invoice Detail Modal -->
    <div id="invoiceDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <span>üìÑ Invoice Details</span>
                <button class="modal-close" onclick="closeInvoiceDetailModal()">√ó</button>
            </div>
            <div class="modal-body" id="invoiceDetailContent">
                <!-- Invoice details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeInvoiceDetailModal()">Close</button>
                <button class="modal-btn modal-btn-confirm" onclick="reprintInvoice()" style="background: var(--primary);">üñ®Ô∏è Print Receipt</button>
                <button class="modal-btn modal-btn-confirm" onclick="emailInvoice()" style="background: var(--success);">üìß Email</button>
                <button class="modal-btn modal-btn-confirm" onclick="smsInvoice()" style="background: var(--warning);">üì± SMS</button>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Edit Product</span>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Product Name</label>
                    <input type="text" id="editProductName">
                </div>
                <div class="input-group">
                    <label>MRP (‚Çπ)</label>
                    <input type="number" id="editProductMRP" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Cost Price (‚Çπ)</label>
                    <input type="number" id="editProductCostPrice" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Selling Price (‚Çπ)</label>
                    <input type="number" id="editProductPrice" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Stock Quantity</label>
                    <input type="number" id="editProductQty" min="0">
                </div>
                <div class="input-group">
                    <label>Category</label>
                    <select id="editProductCategory"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveProduct()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Payment Method Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <span>Select Payment Method</span>
                <button class="modal-close" onclick="closePaymentModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="payment-methods">
                    <button class="payment-method-btn" onclick="completeCheckout('Cash')">
                        <span class="payment-method-icon">üíµ</span>
                        <span>Cash</span>
                    </button>
                    <button class="payment-method-btn" onclick="completeCheckout('Card')">
                        <span class="payment-method-icon">üí≥</span>
                        <span>Debit/Credit Card</span>
                    </button>
                    <button class="payment-method-btn" onclick="completeCheckout('UPI')">
                        <span class="payment-method-icon">üì±</span>
                        <span>UPI/Digital Wallet</span>
                    </button>
                    <button class="payment-method-btn" onclick="completeCheckout('Cheque')">
                        <span class="payment-method-icon">üìÑ</span>
                        <span>Cheque</span>
                    </button>
                    <button class="payment-method-btn" onclick="completeCheckout('Bank Transfer')">
                        <span class="payment-method-icon">üè¶</span>
                        <span>Bank Transfer</span>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closePaymentModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <span>Confirm Reset</span>
                <button class="modal-close" onclick="closeConfirmModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 10px;">‚ö†Ô∏è Are you sure you want to reset the system?</p>
                <p style="font-size: 0.9rem; color: var(--gray);">
                    This will clear all data and reload the page. Any unsaved changes will be lost.
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="forceResetSystem()">Reset System</button>
            </div>
        </div>
    </div>

    <!-- Change PIN Modal -->
    <div id="changePinModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <span>üîë Change Admin PIN</span>
                <button class="modal-close" onclick="closeChangePinModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="pin-change-form">
                    <div class="input-group">
                        <label>Current PIN</label>
                        <input type="password" id="currentPin" maxlength="4" placeholder="Enter current PIN">
                    </div>
                    <div class="input-group">
                        <label>New PIN</label>
                        <input type="password" id="newPin" maxlength="4" placeholder="Enter new 4-digit PIN">
                    </div>
                    <div class="input-group">
                        <label>Confirm New PIN</label>
                        <input type="password" id="confirmNewPin" maxlength="4" placeholder="Re-enter new PIN">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeChangePinModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveNewPin()">Change PIN</button>
            </div>
        </div>
    </div>

    <!-- Exchange/Refund Modal -->
    <div id="exchangeRefundModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <span id="exchangeRefundTitle">üîÑ Exchange / Refund</span>
                <button class="modal-close" onclick="closeExchangeRefundModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="exchangeRefundContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer" id="exchangeRefundFooter">
                <!-- Footer buttons will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Quick Exchange/Refund Selection Modal -->
    <div id="quickExchangeRefundModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <span id="quickExchangeRefundTitle">üîÑ Select Transaction</span>
                <button class="modal-close" onclick="closeQuickExchangeRefundModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="background: #e7f3ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; color: #0066cc;">
                    üí° <strong>Tip:</strong> Select a recent transaction to process exchange or refund
                </div>
                <div id="quickTransactionsList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Transactions will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeQuickExchangeRefundModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div id="promotionModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <span id="promotionModalTitle">üéÅ Create Promotion</span>
                <button class="modal-close" onclick="closePromotionModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="promotionId">
                <input type="hidden" id="promotionType">
                
                <div class="input-group">
                    <label>Promotion Name *</label>
                    <input type="text" id="promotionName" placeholder="e.g., Weekend Special">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="input-group">
                        <label>Start Date *</label>
                        <input type="date" id="promotionStartDate">
                    </div>
                    <div class="input-group">
                        <label>End Date *</label>
                        <input type="date" id="promotionEndDate">
                    </div>
                </div>

                <!-- BOGO Fields -->
                <div id="bogoFields" style="display: none;">
                    <div class="input-group">
                        <label>Select Product *</label>
                        <select id="bogoProduct">
                            <option value="">-- Select Product --</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Offer Type</label>
                        <select id="bogoType">
                            <option value="free">Buy 1 Get 1 Free</option>
                            <option value="50">Buy 1 Get 1 at 50% Off</option>
                            <option value="buy2get1">Buy 2 Get 1 Free</option>
                        </select>
                    </div>
                </div>

                <!-- Bundle Fields -->
                <div id="bundleFields" style="display: none;">
                    <div class="input-group">
                        <label>Bundle Products * (Select multiple)</label>
                        <div id="bundleProductsList" style="max-height: 200px; overflow-y: auto; border: 2px solid var(--light-gray); border-radius: 8px; padding: 10px;">
                            <!-- Products will be populated -->
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Bundle Discount (%) *</label>
                        <input type="number" id="bundleDiscount" placeholder="20" min="0" max="100">
                    </div>
                    <div class="input-group">
                        <label>Bundle Price (‚Çπ) <span style="font-size: 0.85rem; color: var(--gray);">(Optional, overrides discount)</span></label>
                        <input type="number" id="bundlePrice" placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>

                <!-- Time-based Fields -->
                <div id="timebasedFields" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group">
                            <label>Start Time *</label>
                            <input type="time" id="timebasedStartTime">
                        </div>
                        <div class="input-group">
                            <label>End Time *</label>
                            <input type="time" id="timebasedEndTime">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Discount (%) *</label>
                        <input type="number" id="timebasedDiscount" placeholder="15" min="0" max="100">
                    </div>
                    <div class="input-group">
                        <label>Apply To</label>
                        <select id="timebasedApplyTo">
                            <option value="all">All Products</option>
                            <option value="category">Specific Category</option>
                        </select>
                    </div>
                    <div class="input-group" id="timebasedCategoryDiv" style="display: none;">
                        <label>Category</label>
                        <select id="timebasedCategory"></select>
                    </div>
                </div>

                <!-- Seasonal Fields -->
                <div id="seasonalFields" style="display: none;">
                    <div class="input-group">
                        <label>Season/Event *</label>
                        <select id="seasonalEvent">
                            <option value="summer">Summer Sale</option>
                            <option value="monsoon">Monsoon Madness</option>
                            <option value="diwali">Diwali Dhamaka</option>
                            <option value="christmas">Christmas Special</option>
                            <option value="newyear">New Year Bash</option>
                            <option value="holi">Holi Festival</option>
                            <option value="eid">Eid Celebration</option>
                            <option value="custom">Custom Event</option>
                        </select>
                    </div>
                    <div class="input-group" id="customEventDiv" style="display: none;">
                        <label>Custom Event Name</label>
                        <input type="text" id="customEventName" placeholder="Enter event name">
                    </div>
                    <div class="input-group">
                        <label>Discount (%) *</label>
                        <input type="number" id="seasonalDiscount" placeholder="25" min="0" max="100">
                    </div>
                    <div class="input-group">
                        <label>Apply To</label>
                        <select id="seasonalApplyTo">
                            <option value="all">All Products</option>
                            <option value="category">Specific Category</option>
                        </select>
                    </div>
                    <div class="input-group" id="seasonalCategoryDiv" style="display: none;">
                        <label>Category</label>
                        <select id="seasonalCategory"></select>
                    </div>
                </div>

                <!-- Coupon Fields -->
                <div id="couponFields" style="display: none;">
                    <div class="input-group">
                        <label>Coupon Code * <button onclick="generateCouponCode()" type="button" style="margin-left: 10px; padding: 4px 12px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Generate</button></label>
                        <input type="text" id="couponCode" placeholder="e.g., SAVE20" style="text-transform: uppercase;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group">
                            <label>Discount Type *</label>
                            <select id="couponDiscountType">
                                <option value="percentage">Percentage (%)</option>
                                <option value="fixed">Fixed Amount (‚Çπ)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Discount Value *</label>
                            <input type="number" id="couponDiscountValue" placeholder="20" min="0" step="0.01">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group">
                            <label>Min Purchase Amount (‚Çπ)</label>
                            <input type="number" id="couponMinPurchase" placeholder="0" min="0" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Max Uses <span style="font-size: 0.85rem; color: var(--gray);">(0 = unlimited)</span></label>
                            <input type="number" id="couponMaxUses" placeholder="0" min="0" value="0">
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Description <span style="font-size: 0.85rem; color: var(--gray);">(Optional)</span></label>
                    <textarea id="promotionDescription" placeholder="Enter promotion details" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closePromotionModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="savePromotion()">üíæ Save Promotion</button>
            </div>
        </div>
    </div>

    <!-- Apply Coupon Modal -->
    <div id="applyCouponModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <span>üé´ Apply Coupon Code</span>
                <button class="modal-close" onclick="closeApplyCouponModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Enter Coupon Code</label>
                    <input type="text" id="applyCouponCode" placeholder="Enter code" style="text-transform: uppercase;" onkeypress="if(event.key==='Enter') applyCouponCode()">
                </div>
                <div id="couponMessage" style="margin-top: 10px; padding: 10px; border-radius: 6px; display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeApplyCouponModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="applyCouponCode()">‚úÖ Apply</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Supplier Modal -->
    <div id="supplierModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <span id="supplierModalTitle">‚ûï Add Supplier</span>
                <button class="modal-close" onclick="closeSupplierModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="supplierId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="input-group">
                        <label>Supplier Name *</label>
                        <input type="text" id="supplierName" placeholder="Enter supplier name">
                    </div>
                    <div class="input-group">
                        <label>Contact Person</label>
                        <input type="text" id="supplierContact" placeholder="Contact person name">
                    </div>
                    <div class="input-group">
                        <label>Phone Number *</label>
                        <input type="tel" id="supplierPhone" placeholder="1234567890">
                    </div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="supplierEmail" placeholder="supplier@example.com">
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label>Address</label>
                        <textarea id="supplierAddress" placeholder="Enter full address" rows="2"></textarea>
                    </div>
                    <div class="input-group">
                        <label>Payment Terms (Days)</label>
                        <input type="number" id="supplierPaymentTerms" placeholder="30" min="0" value="30">
                    </div>
                    <div class="input-group">
                        <label>GST Number</label>
                        <input type="text" id="supplierGST" placeholder="GST number">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeSupplierModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveSupplier()">üíæ Save Supplier</button>
            </div>
        </div>
    </div>

    <!-- Purchase Order Modal -->
    <div id="purchaseOrderModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <span>üì¶ Create Purchase Order</span>
                <button class="modal-close" onclick="closePurchaseOrderModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="input-group" style="margin: 0;">
                        <label>Supplier *</label>
                        <select id="poSupplier">
                            <option value="">-- Select Supplier --</option>
                        </select>
                    </div>
                    <div class="input-group" style="margin: 0;">
                        <label>Expected Delivery Date</label>
                        <input type="date" id="poDeliveryDate">
                    </div>
                </div>
                <div style="background: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px;">Add Products to Order</h4>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: end;">
                        <select id="poProduct" class="form-control">
                            <option value="">-- Select Product --</option>
                        </select>
                        <input type="number" id="poQuantity" placeholder="Quantity" min="1" value="1" class="form-control">
                        <input type="number" id="poUnitPrice" placeholder="Unit Price" step="0.01" min="0" class="form-control">
                        <button onclick="addProductToPO()" class="btn btn-primary">‚ûï Add</button>
                    </div>
                </div>
                <div id="poItemsList" style="margin-bottom: 15px;">
                    <!-- PO items will be listed here -->
                </div>
                <div style="text-align: right; font-size: 1.2rem; font-weight: 700; color: var(--primary);">
                    Total: <span id="poTotalAmount">‚Çπ0.00</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closePurchaseOrderModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="savePurchaseOrder()">üì¶ Create Order</button>
            </div>
        </div>
    </div>

    <!-- Low Stock Alert Notification -->
    <div id="lowStockAlert" style="position: fixed; top: 80px; right: 20px; background: #fff3cd; border-left: 4px solid #ff9800; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; display: none; max-width: 350px;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div style="font-weight: 600; color: #856404;">‚ö†Ô∏è Low Stock Alert</div>
            <button onclick="closeLowStockAlert()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #856404;">&times;</button>
        </div>
        <div id="lowStockAlertContent" style="font-size: 0.9rem; color: #856404;">
            <!-- Alert content will be populated here -->
        </div>
    </div>

    <!-- Barcode Modal -->
    <div id="barcodeModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <span>üìä Product Barcode</span>
                <button class="modal-close" onclick="closeBarcodeModal()">√ó</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div id="barcodeProductInfo" style="margin-bottom: 20px;">
                    <!-- Product info will be populated -->
                </div>
                <div style="background: white; padding: 20px; border-radius: 8px; display: inline-block;">
                    <svg id="barcodeDisplay"></svg>
                </div>
                <div id="barcodeValue" style="margin-top: 15px; font-weight: 600; font-size: 1.1rem; color: var(--primary);">
                    <!-- Barcode value will be shown -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeBarcodeModal()">Close</button>
                <button class="modal-btn modal-btn-confirm" onclick="printBarcode()">üñ®Ô∏è Print Barcode</button>
            </div>
        </div>
    </div>

    <script>
        // ===== DATA MANAGEMENT =====
        const STORAGE_KEYS = {
            PRODUCTS: 'supermarket_products',
            TRANSACTIONS: 'supermarket_transactions',
            CATEGORIES: 'supermarket_categories',
            SHOP_DETAILS: 'supermarket_shop_details',
            ADMIN_PIN: 'supermarket_admin_pin',
            EXPENSES: 'supermarket_expenses',
            SUPPLIERS: 'supermarket_suppliers',
            PURCHASE_ORDERS: 'supermarket_purchase_orders',
            PROMOTIONS: 'supermarket_promotions'
        };

        let products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS)) || [];
        let cart = [];
        let transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS)) || [];
        let expenses = JSON.parse(localStorage.getItem(STORAGE_KEYS.EXPENSES)) || [];
        let suppliers = JSON.parse(localStorage.getItem(STORAGE_KEYS.SUPPLIERS)) || [];
        let purchaseOrders = JSON.parse(localStorage.getItem(STORAGE_KEYS.PURCHASE_ORDERS)) || [];
        let promotions = JSON.parse(localStorage.getItem(STORAGE_KEYS.PROMOTIONS)) || [];
        let editingProductId = null;
        let selectedPaymentMethod = null;
        let appliedCoupon = null;
        let nextProductId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
        let nextExpenseId = expenses.length > 0 ? Math.max(...expenses.map(e => e.id)) + 1 : 1;
        let nextSupplierId = suppliers.length > 0 ? Math.max(...suppliers.map(s => s.id)) + 1 : 1;
        let nextPOId = purchaseOrders.length > 0 ? Math.max(...purchaseOrders.map(po => po.id)) + 1 : 1;
        let adminAuthenticated = false;
        let adminPin = localStorage.getItem(STORAGE_KEYS.ADMIN_PIN) || '1234';
        let userRole = 'cashier'; // 'cashier' or 'admin'
        let currentPOItems = [];
        let editingSupplierId = null;

        let categories = JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES)) || [
            { name: 'Vegetables', icon: 'ü•¨' },
            { name: 'Fruits', icon: 'üçé' },
            { name: 'Dairy', icon: 'ü•õ' },
            { name: 'Meat', icon: 'üçñ' },
            { name: 'Bakery', icon: 'üçû' },
            { name: 'Beverages', icon: 'ü•§' },
            { name: 'Snacks', icon: 'üçø' },
            { name: 'Cleaning', icon: 'üßπ' }
        ];

        let shopDetails = JSON.parse(localStorage.getItem(STORAGE_KEYS.SHOP_DETAILS)) || {
            shopName: 'Supermarket Store',
            shopAddress: '123 Market Street, City Center',
            shopPhone: '+91 9876543210',
            shopEmail: 'shop@example.com',
            shopGST: '',
            shopFooter: 'Thank you for your purchase! Visit us again.'
        };

        // ===== UTILITY FUNCTIONS =====
        function saveData() {
            localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
            localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));
            localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(categories));
            localStorage.setItem(STORAGE_KEYS.SHOP_DETAILS, JSON.stringify(shopDetails));
        }

        function formatCurrency(amount) {
            return '‚Çπ' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function formatDate(date) {
            return new Date(date).toLocaleString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        // ===== BARCODE MANAGEMENT =====
        function generateBarcode(productId) {
            // Generate EAN-13 style barcode (13 digits)
            // Format: 890 (country code) + 9-digit code + check digit
            const countryCode = '890';
            const paddedId = String(productId).padStart(9, '0');
            const baseCode = countryCode + paddedId;
            
            // Calculate EAN-13 check digit (proper algorithm)
            let sum = 0;
            for (let i = 0; i < 12; i++) {
                const digit = parseInt(baseCode[i]);
                sum += (i % 2 === 0) ? digit : digit * 3;
            }
            const checkDigit = (10 - (sum % 10)) % 10;
            
            return baseCode + checkDigit;
        }

        function handleBarcodeInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const barcode = document.getElementById('barcodeInput').value.trim();
                
                if (!barcode) {
                    return;
                }

                // Ensure all products have barcodes
                let needsUpdate = false;
                products.forEach(p => {
                    if (!p.barcode || p.barcode.length !== 13 || !/^\d+$/.test(p.barcode)) {
                        p.barcode = generateBarcode(p.id);
                        needsUpdate = true;
                    }
                });
                if (needsUpdate) {
                    localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
                }

                // Find product by barcode or ID
                const product = products.find(p => 
                    p.barcode === barcode || 
                    String(p.id) === barcode
                );

                if (product) {
                    if (product.qty > 0) {
                        addToCart(product.id);
                        document.getElementById('barcodeInput').value = '';
                        
                        // Visual feedback
                        const input = document.getElementById('barcodeInput');
                        input.style.background = '#d4edda';
                        setTimeout(() => {
                            input.style.background = '';
                        }, 300);
                    } else {
                        alert(`‚ùå ${product.name} is out of stock!`);
                        document.getElementById('barcodeInput').value = '';
                    }
                } else {
                    alert(`‚ùå Product not found with barcode: ${barcode}`);
                    document.getElementById('barcodeInput').value = '';
                }
            }
        }

        function showBarcode(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Check if JsBarcode is available
            if (typeof JsBarcode === 'undefined') {
                alert('‚ùå Barcode library not loaded. Please refresh the page.');
                return;
            }

            // Validate and regenerate barcode if needed (silently)
            if (!product.barcode || product.barcode.length !== 13 || !/^\d+$/.test(product.barcode)) {
                console.log('Regenerating barcode for product:', productId);
                product.barcode = generateBarcode(productId);
                localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
            }

            // Populate product info
            document.getElementById('barcodeProductInfo').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                    <span style="font-size: 2rem;">${product.icon || 'üì¶'}</span>
                    <div style="text-align: left;">
                        <div style="font-weight: 600; font-size: 1.2rem;">${product.name}</div>
                        <div style="color: var(--gray); font-size: 0.9rem;">${product.category}</div>
                        <div style="color: var(--primary); font-weight: 600; margin-top: 5px;">${formatCurrency(product.price)}</div>
                    </div>
                </div>
            `;

            // Clear previous barcode
            const barcodeElement = document.getElementById('barcodeDisplay');
            barcodeElement.innerHTML = '';

            // Generate barcode using JsBarcode
            try {
                JsBarcode(barcodeElement, product.barcode, {
                    format: "EAN13",
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontSize: 16,
                    margin: 10,
                    valid: function(valid) {
                        if (!valid) {
                            throw new Error('Invalid EAN13 barcode');
                        }
                    }
                });
                
                document.getElementById('barcodeValue').innerHTML = `Barcode: <strong>${product.barcode}</strong>`;
                document.getElementById('barcodeModal').classList.add('active');
            } catch (error) {
                console.error('Barcode generation error:', error, 'Barcode:', product.barcode);
                alert(`‚ùå Error: ${error.message}. Please contact support.`);
            }
        }

        function closeBarcodeModal() {
            document.getElementById('barcodeModal').classList.remove('active');
        }

        function printBarcode() {
            const productId = parseInt(document.getElementById('barcodeValue').textContent.match(/\d+/g).join(''));
            const product = products.find(p => p.barcode && document.getElementById('barcodeValue').textContent.includes(p.barcode));
            if (!product) return;

            const printWindow = window.open('', '', 'width=400,height=300');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Print Barcode - ${product.name}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            padding: 20px;
                        }
                        .product-info {
                            text-align: center;
                            margin-bottom: 20px;
                        }
                        .product-name {
                            font-size: 18px;
                            font-weight: bold;
                            margin-bottom: 5px;
                        }
                        .product-price {
                            font-size: 16px;
                            color: #667eea;
                            font-weight: 600;
                        }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
                </head>
                <body>
                    <div class="product-info">
                        <div class="product-name">${product.icon || 'üì¶'} ${product.name}</div>
                        <div class="product-price">${formatCurrency(product.price)}</div>
                    </div>
                    <svg id="printBarcode"></svg>
                    <script>
                        JsBarcode("#printBarcode", "${product.barcode}", {
                            format: "EAN13",
                            width: 2,
                            height: 80,
                            displayValue: true,
                            fontSize: 14,
                            margin: 5
                        });
                        window.onload = function() {
                            setTimeout(function() {
                                window.print();
                                window.close();
                            }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // ===== TAB MANAGEMENT =====
        function switchTab(tabName) {
            // Prevent cashier access to inventory
            if (tabName === 'inventory' && userRole === 'cashier') {
                alert('üîí Access Denied: Only administrators can access inventory.');
                return;
            }
            
            // Update tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Update sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.toggle('active', section.id === tabName);
            });

            // Load data for the tab
            switch(tabName) {
                case 'pos':
                    renderProducts();
                    checkLowStock();
                    break;
                case 'inventory':
                    renderInventory();
                    checkLowStock();
                    break;
                case 'invoices':
                    renderInvoices();
                    break;
                case 'promotions':
                    renderPromotions();
                    break;
                case 'expenses':
                    renderExpenses();
                    break;
                case 'suppliers':
                    renderSuppliers();
                    break;
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'admin':
                    if (adminAuthenticated) {
                        renderAdminPanel();
                    } else {
                        resetPinInputs();
                    }
                    break;
                case 'settings':
                    loadShopSettings();
                    break;
            }
        }

        // ===== ADMIN PANEL FUNCTIONS =====
        function movePinFocus(currentIndex) {
            const currentInput = document.getElementById(`pin${currentIndex}`);
            if (currentInput.value.length === 1 && currentIndex < 4) {
                document.getElementById(`pin${currentIndex + 1}`).focus();
            }
            if (currentIndex === 4 && currentInput.value.length === 1) {
                verifyAdminPin();
            }
        }

        function handlePinBackspace(event, currentIndex) {
            if (event.key === 'Backspace') {
                const currentInput = document.getElementById(`pin${currentIndex}`);
                if (currentInput.value.length === 0 && currentIndex > 1) {
                    document.getElementById(`pin${currentIndex - 1}`).focus();
                }
            }
        }

        function resetPinInputs() {
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(`pin${i}`);
                if (input) input.value = '';
            }
            const firstInput = document.getElementById('pin1');
            if (firstInput) firstInput.focus();
        }

        function verifyAdminPin() {
            const enteredPin = 
                document.getElementById('pin1').value +
                document.getElementById('pin2').value +
                document.getElementById('pin3').value +
                document.getElementById('pin4').value;

            if (enteredPin.length !== 4) {
                alert('‚ö†Ô∏è Please enter a 4-digit PIN');
                resetPinInputs();
                return;
            }

            if (enteredPin === adminPin) {
                adminAuthenticated = true;
                userRole = 'admin';
                updateNavigationVisibility();
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminContent').classList.add('authenticated');
                renderAdminPanel();
                alert('‚úÖ Access granted! Welcome to Admin Panel');
            } else {
                alert('‚ùå Incorrect PIN. Please try again.');
                resetPinInputs();
            }
        }

        function logoutAdmin() {
            if (confirm('üö™ Are you sure you want to logout from admin panel?')) {
                adminAuthenticated = false;
                userRole = 'cashier';
                updateNavigationVisibility();
                document.getElementById('adminLogin').style.display = 'block';
                document.getElementById('adminContent').classList.remove('authenticated');
                resetPinInputs();
                switchTab('pos');
            }
        }

        function updateNavigationVisibility() {
            const inventoryTab = document.querySelector('[data-tab="inventory"]');
            if (inventoryTab) {
                if (userRole === 'admin') {
                    inventoryTab.style.display = 'flex';
                } else {
                    inventoryTab.style.display = 'none';
                }
            }
        }

        function renderAdminPanel() {
            renderQuickStockList();
            renderAdminStockAlerts();
            renderAdminStockTable();
            renderAdminStatistics();
        }

        function renderQuickStockList() {
            const list = document.getElementById('quickStockList');
            const lowStockProducts = products.filter(p => p.qty <= 20).slice(0, 10);

            if (lowStockProducts.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">All products have sufficient stock</p>';
                return;
            }

            list.innerHTML = lowStockProducts.map(p => `
                <div class="quick-stock-item">
                    <div class="quick-stock-info">
                        <div class="quick-stock-name">${p.icon || 'üì¶'} ${p.name}</div>
                        <div class="quick-stock-current">Current: ${p.qty} units</div>
                    </div>
                    <div class="quick-stock-controls">
                        <input type="number" class="quick-stock-input" id="quickQty${p.id}" placeholder="Qty" min="1" value="10">
                        <button class="quick-stock-btn add" onclick="quickAdjustStock(${p.id}, 'add')">+</button>
                        <button class="quick-stock-btn remove" onclick="quickAdjustStock(${p.id}, 'remove')">‚àí</button>
                    </div>
                </div>
            `).join('');
        }

        function renderAdminStockAlerts() {
            const alerts = document.getElementById('adminStockAlerts');
            const outOfStock = products.filter(p => p.qty === 0);
            const lowStock = products.filter(p => p.qty > 0 && p.qty <= 10);

            let html = '';
            
            if (outOfStock.length > 0) {
                html += `<div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--danger);">
                    <strong style="color: var(--danger);">üö® ${outOfStock.length} Product(s) Out of Stock</strong><br>
                    <small>${outOfStock.map(p => p.name).join(', ')}</small>
                </div>`;
            }

            if (lowStock.length > 0) {
                html += `<div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning);">
                    <strong style="color: var(--warning);">‚ö†Ô∏è ${lowStock.length} Product(s) Low Stock</strong><br>
                    <small>${lowStock.map(p => `${p.name} (${p.qty})`).join(', ')}</small>
                </div>`;
            }

            if (html === '') {
                html = '<p style="text-align: center; color: var(--success); padding: 20px;">‚úÖ All products have healthy stock levels</p>';
            }

            alerts.innerHTML = html;
        }

        function renderAdminStockTable() {
            const table = document.getElementById('adminStockTable');
            
            if (products.length === 0) {
                table.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No products available</td></tr>';
                return;
            }

            table.innerHTML = products.map(p => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.2rem;">${p.icon || 'üì¶'}</span>
                            <strong>${p.name}</strong>
                        </div>
                    </td>
                    <td style="font-weight: 600; font-size: 1.1rem; ${p.qty === 0 ? 'color: var(--danger);' : p.qty <= 10 ? 'color: var(--warning);' : ''}">${p.qty}</td>
                    <td>
                        <input type="number" id="addStock${p.id}" style="width: 80px; padding: 8px; border: 2px solid var(--light-gray); border-radius: 6px;" min="1" placeholder="0">
                    </td>
                    <td>
                        <input type="number" id="removeStock${p.id}" style="width: 80px; padding: 8px; border: 2px solid var(--light-gray); border-radius: 6px;" min="1" placeholder="0">
                    </td>
                    <td>
                        <input type="number" id="setStock${p.id}" style="width: 80px; padding: 8px; border: 2px solid var(--light-gray); border-radius: 6px;" min="0" placeholder="${p.qty}">
                    </td>
                    <td>
                        <div class="action-buttons" style="gap: 8px;">
                            <button class="btn btn-edit" onclick="applyStockChanges(${p.id})" style="padding: 8px 16px;">
                                ‚úÖ Apply
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderAdminStatistics() {
            const totalRevenue = transactions.reduce((sum, t) => sum + t.total, 0);
            const totalProfit = transactions.reduce((sum, t) => {
                return sum + t.items.reduce((itemSum, item) => {
                    const product = products.find(p => p.id === item.id);
                    const costPrice = product ? product.costPrice || 0 : 0;
                    return itemSum + ((item.price - costPrice) * item.qty);
                }, 0);
            }, 0);
            const productsSold = transactions.reduce((sum, t) => sum + t.items.reduce((s, i) => s + i.qty, 0), 0);
            const avgOrder = transactions.length > 0 ? totalRevenue / transactions.length : 0;

            document.getElementById('adminTotalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('adminTotalProfit').textContent = formatCurrency(totalProfit);
            document.getElementById('adminProductsSold').textContent = productsSold.toLocaleString();
            document.getElementById('adminAvgOrder').textContent = formatCurrency(avgOrder);
        }

        function quickAdjustStock(productId, action) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const qtyInput = document.getElementById(`quickQty${productId}`);
            const qty = parseInt(qtyInput.value) || 0;

            if (qty <= 0) {
                alert('‚ö†Ô∏è Please enter a valid quantity');
                return;
            }

            if (action === 'add') {
                product.qty += qty;
                alert(`‚úÖ Added ${qty} units to ${product.name}\nNew stock: ${product.qty}`);
            } else if (action === 'remove') {
                if (product.qty >= qty) {
                    product.qty -= qty;
                    alert(`‚úÖ Removed ${qty} units from ${product.name}\nNew stock: ${product.qty}`);
                } else {
                    alert(`‚ö†Ô∏è Cannot remove ${qty} units. Only ${product.qty} available.`);
                    return;
                }
            }

            saveData();
            renderAdminPanel();
            renderProducts();
            renderInventory();
        }

        function applyStockChanges(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const addQty = parseInt(document.getElementById(`addStock${productId}`).value) || 0;
            const removeQty = parseInt(document.getElementById(`removeStock${productId}`).value) || 0;
            const setQty = document.getElementById(`setStock${productId}`).value;

            if (setQty !== '' && setQty !== null) {
                const newQty = parseInt(setQty);
                if (newQty >= 0) {
                    product.qty = newQty;
                    alert(`‚úÖ Stock set to ${newQty} for ${product.name}`);
                }
            } else if (addQty > 0) {
                product.qty += addQty;
                alert(`‚úÖ Added ${addQty} units to ${product.name}\nNew stock: ${product.qty}`);
            } else if (removeQty > 0) {
                if (product.qty >= removeQty) {
                    product.qty -= removeQty;
                    alert(`‚úÖ Removed ${removeQty} units from ${product.name}\nNew stock: ${product.qty}`);
                } else {
                    alert(`‚ö†Ô∏è Cannot remove ${removeQty} units. Only ${product.qty} available.`);
                    return;
                }
            } else {
                alert('‚ö†Ô∏è Please enter a value in one of the fields');
                return;
            }

            saveData();
            renderAdminPanel();
            renderProducts();
            renderInventory();
        }

        function openChangePinModal() {
            document.getElementById('changePinModal').classList.add('active');
            document.getElementById('currentPin').value = '';
            document.getElementById('newPin').value = '';
            document.getElementById('confirmNewPin').value = '';
        }

        function closeChangePinModal() {
            document.getElementById('changePinModal').classList.remove('active');
        }

        function saveNewPin() {
            const currentPinInput = document.getElementById('currentPin').value;
            const newPinInput = document.getElementById('newPin').value;
            const confirmPinInput = document.getElementById('confirmNewPin').value;

            if (currentPinInput !== adminPin) {
                alert('‚ùå Current PIN is incorrect!');
                return;
            }

            if (newPinInput.length !== 4 || !/^\d{4}$/.test(newPinInput)) {
                alert('‚ö†Ô∏è New PIN must be exactly 4 digits!');
                return;
            }

            if (newPinInput !== confirmPinInput) {
                alert('‚ö†Ô∏è New PIN and confirmation do not match!');
                return;
            }

            adminPin = newPinInput;
            localStorage.setItem(STORAGE_KEYS.ADMIN_PIN, adminPin);
            closeChangePinModal();
            alert('‚úÖ Admin PIN changed successfully!\nPlease remember your new PIN.');
        }

        function showBulkStockUpdate() {
            alert('üì¶ Bulk Stock Update\n\nUse the Import CSV feature in the Inventory section to bulk update product stock.\n\nOr use the Advanced Stock Management table below to update multiple products individually.');
        }

        function exportAllData() {
            const data = {
                products: products,
                transactions: transactions,
                categories: categories,
                shopDetails: shopDetails,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `supermarket_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ All data exported successfully!');
        }

        // ===== EXCHANGE & REFUND MANAGEMENT =====
        function openExchangeRefundModal(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) {
                alert('‚ùå Transaction not found!');
                return;
            }

            // Check if transaction is within 5 days
            const transactionDate = new Date(transaction.date);
            const currentDate = new Date();
            const daysDifference = Math.floor((currentDate - transactionDate) / (1000 * 60 * 60 * 24));

            if (daysDifference > 5) {
                alert(`‚ùå Exchange/Refund validity expired!\n\nThis transaction is ${daysDifference} days old.\nExchange/Refund is only valid for 5 days from purchase date.`);
                return;
            }

            if (transaction.isExchanged) {
                alert('‚ö†Ô∏è This transaction has already been exchanged!');
                return;
            }

            if (transaction.isRefunded) {
                alert('‚ö†Ô∏è This transaction has already been refunded!');
                return;
            }

            const daysRemaining = 5 - daysDifference;
            const content = document.getElementById('exchangeRefundContent');
            const footer = document.getElementById('exchangeRefundFooter');

            content.innerHTML = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">‚è∞ Validity: ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} remaining</div>
                    <div style="font-size: 0.9rem; color: var(--gray);">Valid until ${new Date(transactionDate.getTime() + 5 * 24 * 60 * 60 * 1000).toLocaleDateString()}</div>
                </div>

                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: 600;">Transaction #${transaction.id.toString().slice(-8)}</div>
                            <div style="font-size: 0.9rem; color: var(--gray);">${formatDate(transaction.date)}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: var(--primary); font-size: 1.2rem;">${formatCurrency(transaction.total)}</div>
                            <div style="font-size: 0.9rem; color: var(--gray);">${transaction.paymentMethod}</div>
                        </div>
                    </div>
                    
                    <div style="font-weight: 600; margin-top: 15px; margin-bottom: 10px;">Items:</div>
                    ${transaction.items.map(item => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--light-gray);">
                            <div>${item.name} √ó ${item.qty}</div>
                            <div style="font-weight: 600;">${formatCurrency(item.price * item.qty)}</div>
                        </div>
                    `).join('')}
                    
                    ${transaction.discount > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; color: var(--success);">
                            <div>Discount</div>
                            <div>-${formatCurrency(transaction.discount)}</div>
                        </div>
                    ` : ''}
                    ${transaction.tax > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <div>Tax (${transaction.taxPercent}%)</div>
                            <div>${formatCurrency(transaction.tax)}</div>
                        </div>
                    ` : ''}
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 0.9rem; color: var(--gray); line-height: 1.6;">
                        <strong>üìã Exchange/Refund Policy:</strong><br>
                        ‚Ä¢ Items will be returned to inventory<br>
                        ‚Ä¢ Exchange: Select new products of equal or greater value<br>
                        ‚Ä¢ Refund: Amount will be credited via ${transaction.paymentMethod}<br>
                        ‚Ä¢ Valid for 5 days from purchase date
                    </div>
                </div>
            `;

            footer.innerHTML = `
                <button class="modal-btn modal-btn-cancel" onclick="closeExchangeRefundModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="processExchange(${transactionId})" style="background: var(--primary);">
                    üîÑ Exchange
                </button>
                <button class="modal-btn modal-btn-confirm" onclick="processRefund(${transactionId})" style="background: var(--danger);">
                    üí∞ Refund
                </button>
            `;

            document.getElementById('exchangeRefundModal').classList.add('active');
        }

        function closeExchangeRefundModal() {
            document.getElementById('exchangeRefundModal').classList.remove('active');
        }

        function processExchange(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            if (!confirm('üîÑ Process Exchange?\n\nItems will be returned to inventory and you can select new products.')) {
                return;
            }

            // Return items to inventory
            transaction.items.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (product) {
                    product.qty += item.qty;
                }
            });

            // Mark transaction as exchanged
            transaction.isExchanged = true;
            transaction.exchangedDate = new Date().toISOString();
            
            // Save updates
            localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
            localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));

            // Clear cart and prepare for new selection
            cart = [];
            updateCart();
            
            closeExchangeRefundModal();
            switchTab('pos');
            
            alert(`‚úÖ Exchange Processed!\n\nItems returned to inventory: ${transaction.items.map(i => i.name).join(', ')}\n\nTotal value: ${formatCurrency(transaction.total)}\n\nPlease select new items for the customer.`);
            
            renderDashboard();
            renderInventory();
        }

        function processRefund(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            if (!confirm(`üí∞ Process Refund?\n\nAmount: ${formatCurrency(transaction.total)}\nMethod: ${transaction.paymentMethod}\n\nItems will be returned to inventory.`)) {
                return;
            }

            // Return items to inventory
            transaction.items.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (product) {
                    product.qty += item.qty;
                }
            });

            // Mark transaction as refunded
            transaction.isRefunded = true;
            transaction.refundedDate = new Date().toISOString();
            
            // Save updates
            localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
            localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));

            closeExchangeRefundModal();
            
            alert(`‚úÖ Refund Processed!\n\nAmount refunded: ${formatCurrency(transaction.total)}\nPayment method: ${transaction.paymentMethod}\n\nItems returned to inventory: ${transaction.items.map(i => i.name).join(', ')}`);
            
            renderDashboard();
            renderInventory();
        }

        function showQuickExchangeRefund(type) {
            const title = type === 'exchange' ? 'üîÑ Select Transaction for Exchange' : 'üí∞ Select Transaction for Refund';
            document.getElementById('quickExchangeRefundTitle').textContent = title;
            
            // Get recent transactions (last 30 days, not already exchanged/refunded)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const recentTransactions = transactions
                .filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= thirtyDaysAgo && !t.isExchanged && !t.isRefunded;
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 20); // Show last 20 transactions
            
            const listContainer = document.getElementById('quickTransactionsList');
            
            if (recentTransactions.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray);">
                        <div style="font-size: 3rem; margin-bottom: 10px;">üì≠</div>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px;">No Recent Transactions</div>
                        <div style="font-size: 0.9rem;">No eligible transactions found for ${type}</div>
                    </div>
                `;
            } else {
                listContainer.innerHTML = recentTransactions.map(t => {
                    const transactionDate = new Date(t.date);
                    const daysSince = Math.floor((new Date() - transactionDate) / (1000 * 60 * 60 * 24));
                    const isExpired = daysSince > 5;
                    const daysRemaining = 5 - daysSince;
                    
                    const borderColor = isExpired ? '#ff6b6b' : 'var(--light-gray)';
                    const cursorStyle = isExpired ? 'not-allowed' : 'pointer';
                    const opacity = isExpired ? '0.6' : '1';
                    const onclickAttr = isExpired ? '' : 'onclick="selectTransactionForExchangeRefund(' + t.id + ', \'' + type + '\')"';
                    const timeAgo = daysSince === 0 ? 'Today' : daysSince === 1 ? 'Yesterday' : daysSince + ' days ago';
                    const validityBadge = isExpired 
                        ? '<div style="color: #ff6b6b; font-size: 0.85rem; font-weight: 600; margin-top: 5px;">‚ö†Ô∏è Expired (5-day limit)</div>'
                        : '<div style="color: var(--success); font-size: 0.85rem; font-weight: 600; margin-top: 5px;">‚úì Valid for ' + daysRemaining + ' more day' + (daysRemaining !== 1 ? 's' : '') + '</div>';
                    const itemsPreview = t.items.slice(0, 3).map(item => item.name + ' (' + item.qty + ')').join(', ') + (t.items.length > 3 ? ' +' + (t.items.length - 3) + ' more' : '');
                    
                    return `
                        <div class="transaction-card" style="background: white; border: 2px solid ${borderColor}; border-radius: 8px; padding: 15px; margin-bottom: 12px; cursor: ${cursorStyle}; transition: var(--transition); opacity: ${opacity};" ${onclickAttr}>
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 1.05rem;">#${t.id.toString().slice(-8)}</div>
                                    <div style="font-size: 0.85rem; color: var(--gray); margin-top: 2px;">
                                        ${formatDate(t.date)} ‚Ä¢ ${timeAgo}
                                    </div>
                                    ${validityBadge}
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; font-size: 1.3rem; color: var(--primary);">${formatCurrency(t.total)}</div>
                                    <div style="font-size: 0.85rem; color: var(--gray); margin-top: 2px;">${t.paymentMethod}</div>
                                </div>
                            </div>
                            <div style="border-top: 1px solid var(--light-gray); padding-top: 10px; margin-top: 10px;">
                                <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 5px;">Items: ${t.items.length}</div>
                                <div style="font-size: 0.85rem; color: var(--gray);">
                                    ${itemsPreview}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('quickExchangeRefundModal').classList.add('active');
        }

        function closeQuickExchangeRefundModal() {
            document.getElementById('quickExchangeRefundModal').classList.remove('active');
        }

        function selectTransactionForExchangeRefund(transactionId, type) {
            closeQuickExchangeRefundModal();
            openExchangeRefundModal(transactionId);
        }

        function viewSystemLogs() {
            let logs = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìã SYSTEM LOGS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Total Products: ${products.length}
Total Transactions: ${transactions.length}
Total Categories: ${categories.length}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
RECENT ACTIVITY
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Last 5 Transactions:
`;

            const recentTransactions = transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            recentTransactions.forEach((t, i) => {
                logs += `\n${i + 1}. ${formatDate(t.date)}
   Customer: ${t.customerName || 'Walk-in'}
   Items: ${t.items.length}
   Total: ${formatCurrency(t.total)}
   Payment: ${t.paymentMethod}
`;
            });

            logs += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
STOCK ALERTS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Out of Stock: ${products.filter(p => p.qty === 0).length}
Low Stock: ${products.filter(p => p.qty > 0 && p.qty <= 10).length}
`;

            alert(logs);
        }

        // ===== PRODUCT MANAGEMENT =====
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            if (products.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div class="empty-state-text">No products available</div>
                        <div class="empty-state-subtext">Add products in the Inventory section</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = products.map(product => {
                const isOutOfStock = product.qty === 0;
                const isLowStock = product.qty > 0 && product.qty <= 10;
                
                let stockClass = '';
                let stockText = `${product.qty} in stock`;
                
                if (isOutOfStock) {
                    stockClass = 'out';
                    stockText = 'Out of stock';
                } else if (isLowStock) {
                    stockClass = 'low';
                    stockText = `${product.qty} left (Low stock)`;
                }

                return `
                    <div class="product-card ${isOutOfStock ? 'out-of-stock' : ''}" 
                         onclick="${isOutOfStock ? '' : `addToCart(${product.id})`}">
                        <div class="product-icon">${product.icon || 'üì¶'}</div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${formatCurrency(product.price)}</div>
                        <div class="product-stock ${stockClass}">${stockText}</div>
                        <button class="btn" 
                                onclick="event.stopPropagation(); addToCart(${product.id})"
                                ${isOutOfStock ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                            ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ===== CART MANAGEMENT =====
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.qty === 0) return;

            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                if (cartItem.qty < product.qty) {
                    cartItem.qty++;
                } else {
                    alert(`Only ${product.qty} items available in stock`);
                    return;
                }
            } else {
                cart.push({
                    ...product,
                    qty: 1
                });
            }

            // Add sparkle animation at cursor position
            createSparkles(event.clientX || window.innerWidth / 2, event.clientY || window.innerHeight / 2, 10);
            
            // Pulse the cart section
            const cartSection = document.querySelector('.cart-section');
            if (cartSection) {
                addPulseAnimation(cartSection);
            }

            updateCart();
        }

        function updateCart() {
            const cartContainer = document.getElementById('cartItems');
            const cartCount = document.getElementById('cartCount');
            const checkoutBtn = document.getElementById('checkoutBtn');

            if (cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üõí</div>
                        <div class="empty-state-text">Your cart is empty</div>
                        <div class="empty-state-subtext">Add products from the list</div>
                    </div>
                `;
                cartCount.textContent = '0 items';
                checkoutBtn.disabled = true;
            } else {
                cartContainer.innerHTML = cart.map(item => `
                    <div class="cart-item slide-in-right">
                        <div class="cart-item-icon">${item.icon || 'üì¶'}</div>
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">${formatCurrency(item.price)} each</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="qty-btn" onclick="updateCartQty(${item.id}, -1)">‚àí</button>
                            <span class="qty-display">${item.qty}</span>
                            <button class="qty-btn" onclick="updateCartQty(${item.id}, 1)">+</button>
                            <button class="remove-btn" onclick="removeFromCart(${item.id})">Remove</button>
                        </div>
                    </div>
                `).join('');

                const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
                cartCount.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
                checkoutBtn.disabled = false;
            }

            updateSummary();
        }

        function updateCartQty(productId, change) {
            const cartItem = cart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);
            
            if (!cartItem || !product) return;

            const newQty = cartItem.qty + change;
            
            if (newQty <= 0) {
                removeFromCart(productId);
                return;
            }

            if (newQty > product.qty) {
                alert(`Only ${product.qty} items available in stock`);
                return;
            }

            cartItem.qty = newQty;
            updateCart();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }

        function updateSummary() {
            calculateBill();
        }

        function calculateBill() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);

            // Calculate discount
            const discountType = document.getElementById('discountType').value;
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            let discount = 0;

            if (discountType === 'percentage') {
                discount = (subtotal * discountValue) / 100;
            } else if (discountType === 'fixed') {
                discount = discountValue;
            }

            // Show/hide discount row
            const discountRow = document.getElementById('discountRow');
            if (discount > 0) {
                discountRow.style.display = 'flex';
                document.getElementById('discountAmount').textContent = '-' + formatCurrency(discount);
            } else {
                discountRow.style.display = 'none';
            }

            // Calculate automatic promotions
            let promotionDiscount = 0;
            const activePromotions = checkActivePromotions();
            
            // Show/hide promotion row
            const promotionRow = document.getElementById('promotionRow');
            if (promotionDiscount > 0) {
                promotionRow.style.display = 'flex';
                document.getElementById('promotionAmount').textContent = '-' + formatCurrency(promotionDiscount);
            } else {
                promotionRow.style.display = 'none';
            }

            // Calculate coupon discount
            let couponDiscount = 0;
            const couponRow = document.getElementById('couponRow');
            if (appliedCoupon) {
                const amountForCoupon = subtotal - discount - promotionDiscount;
                if (appliedCoupon.discountType === 'percentage') {
                    couponDiscount = (amountForCoupon * appliedCoupon.discountValue) / 100;
                } else {
                    couponDiscount = appliedCoupon.discountValue;
                }
                
                couponRow.style.display = 'flex';
                document.getElementById('appliedCouponCode').textContent = `(${appliedCoupon.couponCode})`;
                document.getElementById('couponAmount').textContent = '-' + formatCurrency(couponDiscount);
            } else {
                couponRow.style.display = 'none';
            }

            // Calculate tax
            const taxType = document.getElementById('taxType').value;
            const taxRate = parseFloat(taxType) || 0;
            const amountAfterDiscount = subtotal - discount - promotionDiscount - couponDiscount;
            const tax = (amountAfterDiscount * taxRate) / 100;

            // Show/hide tax row
            const taxRow = document.getElementById('taxRow');
            if (taxRate > 0) {
                taxRow.style.display = 'flex';
                document.getElementById('taxRate').textContent = taxRate;
                document.getElementById('taxAmount').textContent = formatCurrency(tax);
            } else {
                taxRow.style.display = 'none';
            }

            // Calculate total
            const total = amountAfterDiscount + tax;
            document.getElementById('total').textContent = formatCurrency(total);
        }

        function checkActivePromotions() {
            if (cart.length === 0) return [];
            
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            return promotions.filter(promo => {
                if (!promo.active || promo.type === 'coupon') return false;
                
                const start = new Date(promo.startDate);
                const end = new Date(promo.endDate);
                end.setHours(23, 59, 59, 999);
                
                if (now < start || now > end) return false;
                
                // Check time-based promotions
                if (promo.type === 'timebased' && promo.timeRange) {
                    const [startH, startM] = promo.timeRange.start.split(':').map(Number);
                    const [endH, endM] = promo.timeRange.end.split(':').map(Number);
                    const startMinutes = startH * 60 + startM;
                    const endMinutes = endH * 60 + endM;
                    if (currentTime < startMinutes || currentTime > endMinutes) return false;
                }
                
                // Check if promotion applies to cart items
                if (promo.type === 'bogo') {
                    return cart.some(item => item.id === promo.productId && item.qty >= 2);
                } else if (promo.type === 'bundle') {
                    return promo.bundleProducts.every(pid => cart.some(item => item.id === pid));
                } else if (promo.type === 'timebased' || promo.type === 'seasonal') {
                    if (promo.applyTo === 'all') return true;
                    if (promo.applyTo === 'category') {
                        return cart.some(item => {
                            const product = products.find(p => p.id === item.id);
                            return product && product.category === promo.category;
                        });
                    }
                }
                
                return false;
            });
        }

        function applyQuickDiscount(percentage) {
            document.getElementById('discountType').value = 'percentage';
            document.getElementById('discountValue').value = percentage;
            calculateBill();
        }

        function applyCustomTax() {
            const customTax = parseFloat(document.getElementById('customTax').value) || 0;
            if (customTax > 0) {
                document.getElementById('taxType').value = '0';
                // Create custom option if needed
                const taxSelect = document.getElementById('taxType');
                const customOption = Array.from(taxSelect.options).find(opt => opt.value === customTax.toString());
                if (!customOption) {
                    const option = document.createElement('option');
                    option.value = customTax;
                    option.text = `Custom ${customTax}%`;
                    option.selected = true;
                    taxSelect.add(option);
                }
            }
            calculateBill();
        }

        // ===== POS SEARCH & FILTER =====
        let filteredPOSProducts = [];

        function filterPOSProducts() {
            const searchTerm = document.getElementById('posSearch').value.toLowerCase();
            
            if (!searchTerm) {
                renderProducts();
                return;
            }

            filteredPOSProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm) ||
                product.id.toString().includes(searchTerm)
            );

            renderFilteredPOSProducts();
        }

        function renderFilteredPOSProducts() {
            const grid = document.getElementById('productsGrid');
            
            if (filteredPOSProducts.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">No products found</div>
                        <div class="empty-state-subtext">Try a different search term</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredPOSProducts.map(product => {
                const isOutOfStock = product.qty === 0;
                const isLowStock = product.qty > 0 && product.qty <= 10;
                
                let stockClass = '';
                let stockText = `${product.qty} in stock`;
                
                if (isOutOfStock) {
                    stockClass = 'out';
                    stockText = 'Out of stock';
                } else if (isLowStock) {
                    stockClass = 'low';
                    stockText = `${product.qty} left (Low stock)`;
                }

                return `
                    <div class="product-card ${isOutOfStock ? 'out-of-stock' : ''}" 
                         onclick="${isOutOfStock ? '' : `addToCart(${product.id})`}">
                        <div class="product-icon">${product.icon || 'üì¶'}</div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${formatCurrency(product.price)}</div>
                        <div class="product-stock ${stockClass}">${stockText}</div>
                        <button class="btn" 
                                onclick="event.stopPropagation(); addToCart(${product.id})"
                                ${isOutOfStock ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                            ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function handleBarcodeInput(event) {
            if (event.key === 'Enter') {
                const barcode = document.getElementById('barcodeInput').value.trim();
                if (!barcode) return;

                // Ensure all products have barcodes
                let needsUpdate = false;
                products.forEach(p => {
                    if (!p.barcode || p.barcode.length !== 13 || !/^\d+$/.test(p.barcode)) {
                        p.barcode = generateBarcode(p.id);
                        needsUpdate = true;
                    }
                });
                if (needsUpdate) {
                    localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
                }

                // Try to find product by barcode or ID
                const product = products.find(p => 
                    p.barcode === barcode || 
                    String(p.id) === barcode
                );

                if (product && product.qty > 0) {
                    addToCart(product.id);
                    document.getElementById('barcodeInput').value = '';
                    document.getElementById('barcodeInput').focus();
                } else if (product && product.qty === 0) {
                    alert('‚ö†Ô∏è Product is out of stock!');
                    document.getElementById('barcodeInput').value = '';
                } else {
                    alert('‚ùå Product not found with barcode: ' + barcode);
                    document.getElementById('barcodeInput').value = '';
                }
            }
        }

        function clearCart() {
            if (cart.length === 0) return;
            
            if (confirm('Are you sure you want to clear the cart?')) {
                cart = [];
                updateCart();
            }
        }

        // ===== CHECKOUT PROCESS =====
        function showPaymentModal() {
            if (cart.length === 0) return;
            document.getElementById('paymentModal').classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        function completeCheckout(paymentMethod) {
            selectedPaymentMethod = paymentMethod;
            closePaymentModal();
            processCheckout();
        }

        function processCheckout() {
            // Validate stock availability
            for (const cartItem of cart) {
                const product = products.find(p => p.id === cartItem.id);
                if (!product || product.qty < cartItem.qty) {
                    alert(`Insufficient stock for ${cartItem.name}. Available: ${product ? product.qty : 0}`);
                    updateCart();
                    return;
                }
            }

            // Get customer info
            const customerName = document.getElementById('customerName').value.trim() || 'Walk-in Customer';
            const customerPhone = document.getElementById('customerPhone').value.trim() || 'N/A';

            // Calculate amounts
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            
            const discountType = document.getElementById('discountType').value;
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            let discount = 0;
            
            if (discountType === 'percentage') {
                discount = (subtotal * discountValue) / 100;
            } else if (discountType === 'fixed') {
                discount = discountValue;
            }
            
            // Calculate promotion discount (simplified for transaction recording)
            let promotionDiscount = 0;
            const activePromotions = checkActivePromotions();
            
            // Calculate coupon discount
            let couponDiscount = 0;
            if (appliedCoupon) {
                const amountForCoupon = subtotal - discount - promotionDiscount;
                if (appliedCoupon.discountType === 'percentage') {
                    couponDiscount = (amountForCoupon * appliedCoupon.discountValue) / 100;
                } else {
                    couponDiscount = appliedCoupon.discountValue;
                }
                
                // Increment coupon usage
                const couponIndex = promotions.findIndex(p => p.id === appliedCoupon.id);
                if (couponIndex !== -1) {
                    promotions[couponIndex].usedCount = (promotions[couponIndex].usedCount || 0) + 1;
                    localStorage.setItem(STORAGE_KEYS.PROMOTIONS, JSON.stringify(promotions));
                }
            }
            
            const taxRate = parseFloat(document.getElementById('taxType').value) || 0;
            const amountAfterDiscount = subtotal - discount - promotionDiscount - couponDiscount;
            const tax = (amountAfterDiscount * taxRate) / 100;
            const total = amountAfterDiscount + tax;

            // Update inventory
            cart.forEach(cartItem => {
                const product = products.find(p => p.id === cartItem.id);
                if (product) {
                    product.qty -= cartItem.qty;
                }
            });

            // Record transaction
            const transaction = {
                id: Date.now(),
                date: new Date().toISOString(),
                customerName: customerName,
                customerPhone: customerPhone,
                items: cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    qty: item.qty,
                    price: item.price
                })),
                subtotal: subtotal,
                discount: discount,
                discountType: discountType,
                discountValue: discountValue,
                promotionDiscount: promotionDiscount,
                couponDiscount: couponDiscount,
                couponCode: appliedCoupon ? appliedCoupon.couponCode : null,
                tax: tax,
                taxRate: taxRate,
                total: total,
                paymentMethod: selectedPaymentMethod,
                timestamp: Date.now()
            };

            transactions.push(transaction);
            saveData();

            // Show receipt
            showReceipt(transaction);

            // Reset form
            cart = [];
            appliedCoupon = null;
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('discountType').value = 'none';
            document.getElementById('discountValue').value = '';
            document.getElementById('taxType').value = '0';
            document.getElementById('customTax').value = '';
            
            updateCart();
            renderProducts();
            renderDashboard();

            // üéâ CELEBRATION ANIMATION! üéâ
            celebrateSuccess('Transaction Successful!');

            // Show success toast with animation
            setTimeout(() => {
                showToast(`Transaction successful! Total: ${formatCurrency(total)} | Payment: ${selectedPaymentMethod}`, 'success', 5000);
            }, 300);
        }

        // ===== RECEIPT MANAGEMENT =====
        function showReceipt(transaction) {
            const subtotal = transaction.subtotal;
            const discount = transaction.discount || 0;
            const promotionDiscount = transaction.promotionDiscount || 0;
            const couponDiscount = transaction.couponDiscount || 0;
            const tax = transaction.tax || 0;
            const total = transaction.total;
            const customerName = transaction.customerName || 'Walk-in Customer';
            const customerPhone = transaction.customerPhone || 'N/A';

            const receiptContent = `
                <div class="receipt-header">
                    <div class="receipt-title">${shopDetails.shopName}</div>
                    <div class="receipt-shop-info">
                        ${shopDetails.shopAddress}<br>
                        ${shopDetails.shopPhone}
                        ${shopDetails.shopEmail ? '<br>' + shopDetails.shopEmail : ''}
                        ${shopDetails.shopGST ? '<br>GST: ' + shopDetails.shopGST : ''}
                    </div>
                    <div class="receipt-date">${formatDate(new Date())}</div>
                    <div class="receipt-date">Receipt #${Date.now().toString().slice(-8)}</div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd;">
                        <strong>Customer:</strong> ${customerName}<br>
                        <strong>Phone:</strong> ${customerPhone}
                    </div>
                </div>
                
                <div class="receipt-items">
                    ${cart.map(item => `
                        <div class="receipt-item">
                            <div class="receipt-item-name">${item.name}</div>
                            <div class="receipt-item-qty">√ó${item.qty}</div>
                            <div class="receipt-item-price">${formatCurrency(item.price * item.qty)}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="receipt-totals">
                    <div class="receipt-total-row">
                        <span>Subtotal:</span>
                        <span>${formatCurrency(subtotal)}</span>
                    </div>
                    ${discount > 0 ? `
                        <div class="receipt-total-row" style="color: var(--success);">
                            <span>Discount:</span>
                            <span>-${formatCurrency(discount)}</span>
                        </div>
                    ` : ''}
                    ${promotionDiscount > 0 ? `
                        <div class="receipt-total-row" style="color: var(--success);">
                            <span>üéÅ Promotion:</span>
                            <span>-${formatCurrency(promotionDiscount)}</span>
                        </div>
                    ` : ''}
                    ${couponDiscount > 0 ? `
                        <div class="receipt-total-row" style="color: var(--success);">
                            <span>üé´ Coupon (${transaction.couponCode}):</span>
                            <span>-${formatCurrency(couponDiscount)}</span>
                        </div>
                    ` : ''}
                    ${tax > 0 ? `
                        <div class="receipt-total-row">
                            <span>Tax (${transaction.taxRate}%):</span>
                            <span>${formatCurrency(tax)}</span>
                        </div>
                    ` : ''}
                    <div class="receipt-total-row grand-total">
                        <span>Total:</span>
                        <span>${formatCurrency(total)}</span>
                    </div>
                </div>
                
                <div class="receipt-payment">
                    <strong>Payment Method:</strong> ${selectedPaymentMethod}<br>
                    <strong>Transaction ID:</strong> ${Date.now().toString().slice(-8)}
                </div>
                
                <div class="receipt-footer">
                    ${shopDetails.shopFooter}<br>
                    For queries, contact: ${shopDetails.shopPhone}
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn" onclick="printReceipt()" style="flex: 1; padding: 12px;">
                        üñ®Ô∏è Print Receipt
                    </button>
                    <button class="btn" onclick="closeReceipt()" style="flex: 1; padding: 12px; background: var(--light-gray);">
                        ‚úï Close
                    </button>
                </div>
            `;

            document.getElementById('receipt').innerHTML = receiptContent;
            document.getElementById('receiptModal').classList.add('active');
        }

        function printReceipt() {
            window.print();
        }

        function closeReceipt() {
            document.getElementById('receiptModal').classList.remove('active');
        }

        // ===== BILL REPRINT FUNCTIONS =====
        function reprintReceipt(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) {
                alert('‚ùå Transaction not found!');
                return;
            }

            // Generate receipt from transaction data
            const subtotal = transaction.subtotal || transaction.total;
            const discount = transaction.discount || 0;
            const tax = transaction.tax || 0;
            const total = transaction.total;
            const customerName = transaction.customerName || 'Walk-in Customer';
            const customerPhone = transaction.customerPhone || 'N/A';

            const receiptContent = `
                <div class="receipt-header">
                    <div class="receipt-title">${shopDetails.shopName}</div>
                    <div class="receipt-shop-info">
                        ${shopDetails.shopAddress}<br>
                        ${shopDetails.shopPhone}
                        ${shopDetails.shopEmail ? '<br>' + shopDetails.shopEmail : ''}
                        ${shopDetails.shopGST ? '<br>GST: ' + shopDetails.shopGST : ''}
                    </div>
                    <div class="receipt-date">${formatDate(transaction.date)}</div>
                    <div class="receipt-date">Receipt #${transaction.id.toString().slice(-8)}</div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd; color: var(--danger); font-weight: 600; text-align: center;">
                        ‚ö†Ô∏è DUPLICATE COPY
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd;">
                        <strong>Customer:</strong> ${customerName}<br>
                        <strong>Phone:</strong> ${customerPhone}
                    </div>
                </div>
                
                <div class="receipt-items">
                    ${transaction.items.map(item => `
                        <div class="receipt-item">
                            <div class="receipt-item-name">${item.name}</div>
                            <div class="receipt-item-qty">√ó${item.qty}</div>
                            <div class="receipt-item-price">${formatCurrency(item.price * item.qty)}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="receipt-totals">
                    <div class="receipt-total-row">
                        <span>Subtotal:</span>
                        <span>${formatCurrency(subtotal)}</span>
                    </div>
                    ${discount > 0 ? `
                        <div class="receipt-total-row" style="color: var(--success);">
                            <span>Discount:</span>
                            <span>-${formatCurrency(discount)}</span>
                        </div>
                    ` : ''}
                    ${tax > 0 ? `
                        <div class="receipt-total-row">
                            <span>Tax (${transaction.taxRate || 0}%):</span>
                            <span>${formatCurrency(tax)}</span>
                        </div>
                    ` : ''}
                    <div class="receipt-total-row grand-total">
                        <span>Total:</span>
                        <span>${formatCurrency(total)}</span>
                    </div>
                </div>
                
                <div class="receipt-payment">
                    <strong>Payment Method:</strong> ${transaction.paymentMethod}<br>
                    <strong>Transaction ID:</strong> ${transaction.id.toString().slice(-8)}<br>
                    <strong>Original Date:</strong> ${formatDate(transaction.date)}
                </div>
                
                <div class="receipt-footer">
                    ${shopDetails.shopFooter}<br>
                    For queries, contact: ${shopDetails.shopPhone}
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn" onclick="printReceipt()" style="flex: 1; padding: 12px;">
                        üñ®Ô∏è Print Receipt
                    </button>
                    <button class="btn" onclick="closeReceipt()" style="flex: 1; padding: 12px; background: var(--light-gray);">
                        ‚úï Close
                    </button>
                </div>
            `;

            document.getElementById('receipt').innerHTML = receiptContent;
            document.getElementById('receiptModal').classList.add('active');
        }

        function viewTransactionDetails(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) {
                alert('‚ùå Transaction not found!');
                return;
            }

            const subtotal = transaction.subtotal || transaction.total;
            const discount = transaction.discount || 0;
            const tax = transaction.tax || 0;
            const total = transaction.total;

            let details = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìã TRANSACTION DETAILS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üÜî Transaction ID: ${transaction.id.toString().slice(-8)}
üìÖ Date: ${formatDate(transaction.date)}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ CUSTOMER INFORMATION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Name: ${transaction.customerName || 'Walk-in Customer'}
Phone: ${transaction.customerPhone || 'N/A'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üõí ITEMS (${transaction.items.length})
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

`;

            transaction.items.forEach((item, index) => {
                details += `${index + 1}. ${item.name}
   Qty: ${item.qty} √ó ${formatCurrency(item.price)}
   Amount: ${formatCurrency(item.qty * item.price)}

`;
            });

            details += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ PAYMENT SUMMARY
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Subtotal: ${formatCurrency(subtotal)}`;

            if (discount > 0) {
                details += `
Discount (${transaction.discountType === 'percentage' ? transaction.discountValue + '%' : 'Fixed'}): -${formatCurrency(discount)}`;
            }

            if (tax > 0) {
                details += `
Tax (${transaction.taxRate || 0}%): ${formatCurrency(tax)}`;
            }

            details += `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
TOTAL PAID: ${formatCurrency(total)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí≥ Payment Method: ${transaction.paymentMethod}
`;

            alert(details);
        }

        // ===== INVENTORY MANAGEMENT =====
        function renderInventory() {
            // Update quick stats
            updateInventoryStats();

            // Update category dropdown in add form
            const categorySelect = document.getElementById('productCategory');
            if (categorySelect) {
                categorySelect.innerHTML = categories.map(cat => 
                    `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`
                ).join('');
            }

            // Reset filters and render table
            filteredProducts = [...products];
            renderFilteredInventory();
        }

        function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const icon = document.getElementById('productIcon').value.trim();
            const category = document.getElementById('productCategory').value;
            const mrp = parseFloat(document.getElementById('productMRP').value);
            const costPrice = parseFloat(document.getElementById('productCostPrice').value);
            const price = parseFloat(document.getElementById('productPrice').value);
            const qty = parseInt(document.getElementById('productQty').value);

            // Validation
            if (!name) {
                alert('Please enter product name');
                return;
            }
            
            if (!icon) {
                alert('Please enter product icon');
                return;
            }
            
            if (!category) {
                alert('Please select a category');
                return;
            }
            
            if (isNaN(mrp) || mrp < 0) {
                alert('Please enter a valid MRP');
                return;
            }
            
            if (isNaN(costPrice) || costPrice < 0) {
                alert('Please enter a valid cost price');
                return;
            }
            
            if (isNaN(price) || price < 0) {
                alert('Please enter a valid selling price');
                return;
            }
            
            if (isNaN(qty) || qty < 0) {
                alert('Please enter a valid quantity');
                return;
            }

            // Generate unique barcode
            const barcode = generateBarcode(nextProductId);
            const minStock = parseInt(document.getElementById('productMinStock').value) || 10;
            const supplierId = document.getElementById('productSupplier').value ? parseInt(document.getElementById('productSupplier').value) : null;

            // Add product
            products.push({
                id: nextProductId++,
                name,
                category,
                mrp,
                costPrice,
                price,
                qty,
                icon,
                barcode,
                minStock,
                supplierId,
                createdAt: new Date().toISOString()
            });

            saveData();
            clearProductForm();
            renderProducts();
            renderInventory();
            checkLowStock();
            alert('‚úÖ Product added successfully!');
        }

        function clearProductForm() {
            document.getElementById('productName').value = '';
            const iconField = document.getElementById('productIcon');
            if (iconField) iconField.value = '';
            const barcodeField = document.getElementById('productBarcode');
            if (barcodeField) barcodeField.value = '';
            document.getElementById('productMRP').value = '';
            document.getElementById('productCostPrice').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productQty').value = '';
            const profitDisplay = document.getElementById('profitMarginDisplay');
            if (profitDisplay) profitDisplay.textContent = '-';
        }

        function openEditModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            editingProductId = productId;
            
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductMRP').value = product.mrp || 0;
            document.getElementById('editProductCostPrice').value = product.costPrice || 0;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductQty').value = product.qty;
            
            // Populate category dropdown
            const categorySelect = document.getElementById('editProductCategory');
            categorySelect.innerHTML = categories.map(cat => 
                `<option value="${cat.name}" ${cat.name === product.category ? 'selected' : ''}>
                    ${cat.icon} ${cat.name}
                </option>`
            ).join('');
            
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingProductId = null;
        }

        function saveProduct() {
            const product = products.find(p => p.id === editingProductId);
            if (!product) return;

            product.name = document.getElementById('editProductName').value.trim();
            product.mrp = parseFloat(document.getElementById('editProductMRP').value);
            product.costPrice = parseFloat(document.getElementById('editProductCostPrice').value);
            product.price = parseFloat(document.getElementById('editProductPrice').value);
            product.qty = parseInt(document.getElementById('editProductQty').value);
            product.category = document.getElementById('editProductCategory').value;
            
            // Update icon based on new category
            const categoryObj = categories.find(c => c.name === product.category);
            if (categoryObj) {
                product.icon = categoryObj.icon;
            }

            saveData();
            renderProducts();
            renderInventory();
            closeEditModal();
            alert('‚úÖ Product updated successfully!');
        }

        function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            // Remove from products
            products = products.filter(p => p.id !== productId);
            
            // Remove from cart
            cart = cart.filter(item => item.id !== productId);

            saveData();
            renderProducts();
            renderInventory();
            updateCart();
            alert('‚úÖ Product deleted successfully!');
        }

        // ===== ENHANCED INVENTORY FEATURES =====
        let inventorySort = { field: null, order: 'asc' };
        let filteredProducts = [];

        function updateInventoryStats() {
            const totalProducts = products.length;
            const totalUnits = products.reduce((sum, p) => sum + p.qty, 0);
            const lowStockCount = products.filter(p => p.qty > 0 && p.qty <= 10).length;
            const outOfStockCount = products.filter(p => p.qty === 0).length;
            const totalValue = products.reduce((sum, p) => sum + (p.price * p.qty), 0);

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalUnits').textContent = totalUnits.toLocaleString();
            document.getElementById('lowStockCount').textContent = lowStockCount;
            document.getElementById('outOfStockCount').textContent = outOfStockCount;
            document.getElementById('totalInventoryValue').textContent = formatCurrency(totalValue);

            // Update category filter
            const categoryFilter = document.getElementById('categoryFilter');
            const currentValue = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="">All Categories</option>' + 
                categories.map(cat => `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`).join('');
            categoryFilter.value = currentValue;
        }

        function toggleAddProductForm() {
            const form = document.getElementById('addProductForm');
            if (form.style.display === 'none') {
                form.style.display = 'grid';
                // Pre-generate barcode for preview
                const newBarcode = generateBarcode(nextProductId);
                document.getElementById('productBarcode').value = newBarcode;
            } else {
                form.style.display = 'none';
                clearProductForm();
            }
        }

        function calculateProfitMargin() {
            const costPrice = parseFloat(document.getElementById('productCostPrice').value) || 0;
            const sellingPrice = parseFloat(document.getElementById('productPrice').value) || 0;
            
            if (costPrice > 0 && sellingPrice > 0) {
                const profit = sellingPrice - costPrice;
                const margin = (profit / costPrice * 100).toFixed(2);
                const display = document.getElementById('profitMarginDisplay');
                
                if (profit > 0) {
                    display.textContent = `Profit: ${formatCurrency(profit)} (${margin}% margin)`;
                    display.style.color = 'var(--success)';
                } else if (profit < 0) {
                    display.textContent = `Loss: ${formatCurrency(Math.abs(profit))} (${margin}% margin)`;
                    display.style.color = 'var(--danger)';
                } else {
                    display.textContent = 'No profit, no loss';
                    display.style.color = 'var(--gray)';
                }
            } else {
                document.getElementById('profitMarginDisplay').textContent = '-';
            }
        }

        function filterInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            
            // Show/hide clear button
            const clearBtn = document.querySelector('.clear-search');
            if (searchTerm) {
                clearBtn.classList.add('active');
            } else {
                clearBtn.classList.remove('active');
            }

            filteredProducts = products.filter(product => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm);
                
                // Category filter
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                
                // Stock filter
                let matchesStock = true;
                if (stockFilter === 'in-stock') {
                    matchesStock = product.qty > 10;
                } else if (stockFilter === 'low-stock') {
                    matchesStock = product.qty > 0 && product.qty <= 10;
                } else if (stockFilter === 'out-of-stock') {
                    matchesStock = product.qty === 0;
                }
                
                return matchesSearch && matchesCategory && matchesStock;
            });

            renderFilteredInventory();
        }

        function clearInventorySearch() {
            document.getElementById('inventorySearch').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('stockFilter').value = '';
            document.querySelector('.clear-search').classList.remove('active');
            filterInventory();
        }

        function sortInventory(field) {
            // Update sort state
            if (inventorySort.field === field) {
                inventorySort.order = inventorySort.order === 'asc' ? 'desc' : 'asc';
            } else {
                inventorySort.field = field;
                inventorySort.order = 'asc';
            }

            // Update header classes
            document.querySelectorAll('.table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const activeHeader = event.target;
            activeHeader.classList.add(inventorySort.order === 'asc' ? 'sort-asc' : 'sort-desc');

            // Sort products
            const productsToSort = filteredProducts.length > 0 || 
                document.getElementById('inventorySearch').value || 
                document.getElementById('categoryFilter').value || 
                document.getElementById('stockFilter').value
                ? filteredProducts 
                : [...products];

            productsToSort.sort((a, b) => {
                let valA, valB;

                switch(field) {
                    case 'name':
                    case 'category':
                        valA = a[field].toLowerCase();
                        valB = b[field].toLowerCase();
                        break;
                    case 'profit':
                        valA = (a.price - a.costPrice) * a.qty;
                        valB = (b.price - b.costPrice) * b.qty;
                        break;
                    case 'status':
                        valA = a.qty === 0 ? 0 : (a.qty <= 10 ? 1 : 2);
                        valB = b.qty === 0 ? 0 : (b.qty <= 10 ? 1 : 2);
                        break;
                    default:
                        valA = a[field];
                        valB = b[field];
                }

                if (valA < valB) return inventorySort.order === 'asc' ? -1 : 1;
                if (valA > valB) return inventorySort.order === 'asc' ? 1 : -1;
                return 0;
            });

            filteredProducts = productsToSort;
            renderFilteredInventory();
        }

        function renderFilteredInventory() {
            const table = document.getElementById('inventoryTable');
            const displayProducts = filteredProducts.length > 0 || 
                document.getElementById('inventorySearch').value || 
                document.getElementById('categoryFilter').value || 
                document.getElementById('stockFilter').value
                ? filteredProducts 
                : products;

            if (displayProducts.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="10">
                            <div class="empty-state" style="padding: 30px;">
                                <div class="empty-state-icon">üîç</div>
                                <div class="empty-state-text">No products found</div>
                                <div class="empty-state-subtext">Try adjusting your filters or search term</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            table.innerHTML = displayProducts.map(product => {
                const isOutOfStock = product.qty === 0;
                const isLowStock = product.qty > 0 && product.qty <= 10;
                
                let status = '‚úÖ In Stock';
                let statusClass = 'success';
                
                if (isOutOfStock) {
                    status = '‚ùå Out of Stock';
                    statusClass = 'danger';
                } else if (isLowStock) {
                    status = '‚ö†Ô∏è Low Stock';
                    statusClass = 'warning';
                }

                const profit = (product.price - product.costPrice) * product.qty;
                const profitPercentage = product.costPrice > 0 ? ((product.price - product.costPrice) / product.costPrice * 100).toFixed(1) : 0;
                
                // Generate barcode if not exists
                if (!product.barcode) {
                    product.barcode = generateBarcode(product.id);
                }
                
                // Ensure icon exists
                const productIcon = product.icon || 'üì¶';
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px; min-width: 180px;">
                                <span style="font-size: 1.1rem; flex-shrink: 0;">${productIcon}</span>
                                <div style="min-width: 0; flex: 1;">
                                    <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;">${product.name}</div>
                                    <div style="font-size: 0.75rem; color: var(--gray); white-space: nowrap;">ID: ${product.id}</div>
                                </div>
                            </div>
                        </td>
                        <td style="min-width: 100px;">${product.category}</td>
                        <td style="min-width: 130px;">
                            <div style="font-size: 0.75rem; color: var(--gray);">${product.barcode}</div>
                            <button class="btn btn-edit" onclick="showBarcode(${product.id})" style="margin-top: 4px; font-size: 0.75rem; padding: 4px 8px;">
                                üìä View
                            </button>
                        </td>
                        <td style="font-weight: 600; min-width: 110px;" title="MRP">${formatCurrency(product.mrp || 0)}</td>
                        <td style="color: #ff6b6b; min-width: 110px;" title="Cost Price">${formatCurrency(product.costPrice || 0)}</td>
                        <td style="font-weight: 600; color: #51cf66; min-width: 110px;" title="Selling Price">${formatCurrency(product.price)}</td>
                        <td style="color: ${profit > 0 ? '#51cf66' : '#ff6b6b'}; font-weight: 600; min-width: 110px;" title="Profit">
                            ${formatCurrency(profit)}<br><span style="font-size: 0.75rem;">(${profitPercentage}%)</span>
                        </td>
                        <td style="min-width: 70px; text-align: center;">
                            <span style="font-weight: 600; ${isLowStock ? 'color: var(--warning);' : ''} ${isOutOfStock ? 'color: var(--danger);' : ''}">
                                ${product.qty}
                            </span>
                        </td>
                        <td style="min-width: 110px;">
                            <span class="${statusClass}" style="font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; display: inline-block; white-space: nowrap; background: ${statusClass === 'success' ? '#e8f5e9' : statusClass === 'warning' ? '#fff3cd' : '#ffebee'};">
                                ${status}
                            </span>
                        </td>
                        <td style="min-width: 150px;">
                            <div class="action-buttons" style="flex-wrap: wrap; justify-content: center;">
                                <button class="btn btn-edit" onclick="openEditModal(${product.id})" style="flex: 1; min-width: 60px;">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-delete" onclick="deleteProduct(${product.id})" style="flex: 1; min-width: 60px;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function exportInventoryCSV() {
            const headers = ['ID', 'Product Name', 'Category', 'MRP', 'Cost Price', 'Selling Price', 'Stock', 'Status'];
            const rows = products.map(p => {
                const status = p.qty === 0 ? 'Out of Stock' : (p.qty <= 10 ? 'Low Stock' : 'In Stock');
                return [
                    p.id,
                    p.name,
                    p.category,
                    p.mrp || 0,
                    p.costPrice || 0,
                    p.price,
                    p.qty,
                    status
                ];
            });

            let csvContent = headers.join(',') + '\\n';
            rows.forEach(row => {
                csvContent += row.map(cell => `"${cell}"`).join(',') + '\\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ Inventory exported successfully!');
        }

        function importInventoryCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\\n');
                    let imported = 0;
                    
                    // Skip header line
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const values = line.match(/(".*?"|[^,]+)(?=\\s*,|\\s*$)/g).map(v => v.replace(/^"|"$/g, ''));
                        
                        if (values.length >= 7) {
                            const [id, name, category, mrp, costPrice, price, qty] = values;
                            
                            // Check if category exists
                            const categoryObj = categories.find(c => c.name === category);
                            if (!categoryObj) continue;

                            products.push({
                                id: nextProductId,
                                name: name,
                                category: category,
                                mrp: parseFloat(mrp) || 0,
                                costPrice: parseFloat(costPrice) || 0,
                                price: parseFloat(price),
                                qty: parseInt(qty),
                                icon: categoryObj.icon,
                                barcode: generateBarcode(nextProductId),
                                createdAt: new Date().toISOString()
                            });
                            nextProductId++;
                            imported++;
                        }
                    }

                    if (imported > 0) {
                        saveData();
                        renderProducts();
                        renderInventory();
                        alert(`‚úÖ Successfully imported ${imported} product(s)!`);
                    } else {
                        alert('‚ö†Ô∏è No valid products found in the CSV file.');
                    }
                } catch (error) {
                    alert('‚ùå Error importing CSV: ' + error.message);
                }
                
                // Reset file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function printInventoryReport() {
            const printWindow = window.open('', '', 'width=800,height=600');
            const reportContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Inventory Report - ${shopDetails.shopName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #667eea; color: white; }
                        .summary { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>${shopDetails.shopName} - Inventory Report</h1>
                    <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
                    
                    <div class="summary">
                        <h3>Summary</h3>
                        <p><strong>Total Products:</strong> ${products.length}</p>
                        <p><strong>Total Stock Units:</strong> ${products.reduce((s, p) => s + p.qty, 0)}</p>
                        <p><strong>Total Inventory Value:</strong> ${formatCurrency(products.reduce((s, p) => s + (p.price * p.qty), 0))}</p>
                        <p><strong>Low Stock Items:</strong> ${products.filter(p => p.qty > 0 && p.qty <= 10).length}</p>
                        <p><strong>Out of Stock:</strong> ${products.filter(p => p.qty === 0).length}</p>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Cost Price</th>
                                <th>Selling Price</th>
                                <th>Stock</th>
                                <th>Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(p => {
                                const status = p.qty === 0 ? 'Out of Stock' : (p.qty <= 10 ? 'Low Stock' : 'In Stock');
                                return `
                                    <tr>
                                        <td>${p.name}</td>
                                        <td>${p.category}</td>
                                        <td>${formatCurrency(p.costPrice || 0)}</td>
                                        <td>${formatCurrency(p.price)}</td>
                                        <td>${p.qty}</td>
                                        <td>${formatCurrency(p.price * p.qty)}</td>
                                        <td>${status}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Print Report
                    </button>
                </body>
                </html>
            `;
            
            printWindow.document.write(reportContent);
            printWindow.document.close();
        }

        // ===== DASHBOARD =====
        function renderDashboard() {
            // Calculate statistics
            const totalSales = transactions.reduce((sum, t) => sum + t.total, 0);
            const totalTransactions = transactions.length;
            const totalStockValue = products.reduce((sum, p) => sum + (p.price * p.qty), 0);
            const totalStock = products.reduce((sum, p) => sum + p.qty, 0);

            // Update stat cards
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
            document.getElementById('stockValue').textContent = formatCurrency(totalStockValue);
            document.getElementById('totalStock').textContent = totalStock.toLocaleString();

            // Low Stock Alert
            const lowStockItems = products
                .filter(p => p.qty > 0 && p.qty <= 10)
                .sort((a, b) => a.qty - b.qty);
            
            const lowStockList = document.getElementById('lowStockList');
            lowStockList.innerHTML = lowStockItems.length > 0
                ? lowStockItems.map(p => `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${p.icon || 'üì¶'}
                                <span>${p.name}</span>
                            </div>
                        </td>
                        <td style="font-weight: 600; color: var(--warning);">${p.qty}</td>
                        <td>
                            <span style="padding: 4px 8px; background: #fff3cd; border-radius: 4px; font-size: 0.85rem;">
                                ‚ö†Ô∏è Low Stock
                            </span>
                        </td>
                    </tr>
                `).join('')
                : '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--gray);">No low stock items</td></tr>';

            // Stock by Category
            const categoryStats = {};
            products.forEach(p => {
                if (!categoryStats[p.category]) {
                    categoryStats[p.category] = { qty: 0, value: 0 };
                }
                categoryStats[p.category].qty += p.qty;
                categoryStats[p.category].value += p.price * p.qty;
            });

            const stockByCategory = document.getElementById('stockByCategory');
            stockByCategory.innerHTML = Object.entries(categoryStats).length > 0
                ? Object.entries(categoryStats).map(([category, stats]) => {
                    const catObj = categories.find(c => c.name === category);
                    return `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    ${catObj ? catObj.icon : 'üì¶'}
                                    <span>${category}</span>
                                </div>
                            </td>
                            <td style="font-weight: 600;">${stats.qty.toLocaleString()}</td>
                            <td style="font-weight: 600; color: var(--primary);">
                                ${formatCurrency(stats.value)}
                            </td>
                        </tr>
                    `;
                }).join('')
                : '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--gray);">No stock data</td></tr>';

            // Sales by Product
            const productSales = {};
            
            // Initialize with all products
            products.forEach(p => {
                productSales[p.id] = {
                    name: p.name,
                    icon: p.icon || 'üì¶',
                    unitsSold: 0,
                    revenue: 0,
                    currentStock: p.qty
                };
            });

            // Calculate sales from transactions
            transactions.forEach(t => {
                t.items.forEach(item => {
                    if (productSales[item.id]) {
                        productSales[item.id].unitsSold += item.qty;
                        productSales[item.id].revenue += item.price * item.qty;
                    }
                });
            });

            const salesByProduct = document.getElementById('salesByProduct');
            const sortedProductSales = Object.values(productSales)
                .filter(p => p.unitsSold > 0)
                .sort((a, b) => b.revenue - a.revenue);

            salesByProduct.innerHTML = sortedProductSales.length > 0
                ? sortedProductSales.map(p => `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${p.icon}
                                <span>${p.name}</span>
                            </div>
                        </td>
                        <td style="font-weight: 600;">${p.unitsSold.toLocaleString()}</td>
                        <td style="font-weight: 600; color: var(--primary);">
                            ${formatCurrency(p.revenue)}
                        </td>
                        <td>${p.currentStock.toLocaleString()}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--gray);">No sales data yet</td></tr>';

            // Recent Transactions
            const transactionsList = document.getElementById('transactionsList');
            const recentTransactions = transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);

            transactionsList.innerHTML = recentTransactions.length > 0
                ? recentTransactions.map(t => {
                    let statusBadge = '';
                    if (t.isExchanged) {
                        statusBadge = '<br><span style="padding: 2px 6px; background: var(--warning); color: white; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üîÑ EXCHANGED</span>';
                    } else if (t.isRefunded) {
                        statusBadge = '<br><span style="padding: 2px 6px; background: var(--danger); color: white; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üí∞ REFUNDED</span>';
                    }
                    
                    return `
                    <tr style="${t.isExchanged || t.isRefunded ? 'opacity: 0.7; background: #f8f9fa;' : ''}">
                        <td>
                            ${formatDate(t.date)}<br>
                            <small style="color: var(--gray);">#${t.id.toString().slice(-8)}</small>
                            ${statusBadge}
                        </td>
                        <td>
                            <strong>${t.customerName || 'Walk-in'}</strong><br>
                            <small style="color: var(--gray);">${t.customerPhone || 'N/A'}</small>
                        </td>
                        <td>${t.items.length} item${t.items.length !== 1 ? 's' : ''}</td>
                        <td style="font-weight: 600;">
                            ${formatCurrency(t.total)}
                            ${t.discount > 0 ? `<br><small style="color: var(--success);">-${formatCurrency(t.discount)} disc.</small>` : ''}
                        </td>
                        <td>
                            <span style="padding: 4px 8px; background: var(--light-gray); border-radius: 4px; font-size: 0.85rem;">
                                ${t.paymentMethod}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons" style="gap: 5px;">
                                <button class="btn btn-edit" onclick="reprintReceipt(${t.id})" title="Reprint Receipt" style="min-width: auto; padding: 8px 12px;">
                                    üñ®Ô∏è
                                </button>
                                <button class="btn btn-edit" onclick="viewTransactionDetails(${t.id})" title="View Details" style="min-width: auto; padding: 8px 12px;">
                                    üëÅÔ∏è
                                </button>
                                ${!t.isExchanged && !t.isRefunded ? `
                                <button class="btn btn-edit" onclick="openExchangeRefundModal(${t.id})" title="Exchange/Refund" style="min-width: auto; padding: 8px 12px; background: var(--warning);">
                                    üîÑ
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                    `;
                }).join('')
                : '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">No transactions yet</td></tr>';
        }

        // ===== INVOICE MANAGEMENT =====
        let filteredInvoices = [];
        let currentInvoiceId = null;

        function renderInvoices() {
            filteredInvoices = [...transactions].reverse(); // Show newest first
            updateInvoiceStats();
            displayInvoices();
        }

        function updateInvoiceStats() {
            const totalCount = filteredInvoices.length;
            const totalAmount = filteredInvoices.reduce((sum, inv) => sum + inv.total, 0);
            const completedCount = filteredInvoices.filter(inv => !inv.isExchanged && !inv.isRefunded).length;
            const exchangedCount = filteredInvoices.filter(inv => inv.isExchanged).length;
            const refundedCount = filteredInvoices.filter(inv => inv.isRefunded).length;

            document.getElementById('totalInvoicesCount').textContent = totalCount;
            document.getElementById('totalInvoicesAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('completedInvoicesCount').textContent = completedCount;
            document.getElementById('exchangedInvoicesCount').textContent = exchangedCount;
            document.getElementById('refundedInvoicesCount').textContent = refundedCount;
        }

        function displayInvoices() {
            const container = document.getElementById('invoicesList');
            
            if (filteredInvoices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
                        <div style="font-size: 4rem; margin-bottom: 15px;">üì≠</div>
                        <div style="font-size: 1.3rem; font-weight: 600; color: var(--gray); margin-bottom: 8px;">No Invoices Found</div>
                        <div style="color: var(--gray);">Try adjusting your filters or make a sale to create invoices</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredInvoices.map(invoice => {
                const statusBadge = invoice.isRefunded 
                    ? '<span class="invoice-badge refunded">üî¥ Refunded</span>'
                    : invoice.isExchanged 
                    ? '<span class="invoice-badge exchanged">üîÑ Exchanged</span>'
                    : '<span class="invoice-badge completed">‚úÖ Completed</span>';
                
                const cardClass = invoice.isRefunded ? 'refunded' : invoice.isExchanged ? 'exchanged' : '';
                
                return `
                    <div class="invoice-card ${cardClass}" onclick="viewInvoiceDetail(${invoice.id})">
                        <div style="display: grid; grid-template-columns: 1fr 2fr 1fr 1fr auto; gap: 20px; align-items: center;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 4px;">INVOICE #</div>
                                <div style="font-weight: 700; font-size: 1.2rem; color: var(--primary);">${invoice.id.toString().padStart(8, '0')}</div>
                                <div style="font-size: 0.8rem; color: var(--gray); margin-top: 4px;">${formatDate(invoice.date)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 4px;">ITEMS</div>
                                <div style="font-weight: 600; margin-bottom: 5px;">${invoice.items.length} item${invoice.items.length > 1 ? 's' : ''}</div>
                                <div style="font-size: 0.85rem; color: var(--gray);">
                                    ${invoice.items.slice(0, 2).map(item => item.name).join(', ')}${invoice.items.length > 2 ? ' +' + (invoice.items.length - 2) + ' more' : ''}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 4px;">PAYMENT</div>
                                <div style="font-weight: 600;">${invoice.paymentMethod}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 4px;">TOTAL AMOUNT</div>
                                <div style="font-weight: 700; font-size: 1.4rem; color: var(--success);">${formatCurrency(invoice.total)}</div>
                            </div>
                            <div>
                                ${statusBadge}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterInvoices() {
            const searchTerm = document.getElementById('invoiceSearch').value.toLowerCase().trim();
            const dateFrom = document.getElementById('invoiceDateFrom').value;
            const dateTo = document.getElementById('invoiceDateTo').value;
            const paymentFilter = document.getElementById('invoicePaymentFilter').value;

            filteredInvoices = transactions.filter(invoice => {
                // Search filter
                const invoiceNumber = invoice.id.toString().padStart(8, '0');
                const matchesSearch = !searchTerm || 
                    invoiceNumber.includes(searchTerm) ||
                    invoice.total.toString().includes(searchTerm) ||
                    invoice.items.some(item => item.name.toLowerCase().includes(searchTerm));

                // Date filters
                const invoiceDate = new Date(invoice.date).toISOString().split('T')[0];
                const matchesDateFrom = !dateFrom || invoiceDate >= dateFrom;
                const matchesDateTo = !dateTo || invoiceDate <= dateTo;

                // Payment filter
                const matchesPayment = paymentFilter === 'all' || invoice.paymentMethod === paymentFilter;

                return matchesSearch && matchesDateFrom && matchesDateTo && matchesPayment;
            }).reverse();

            updateInvoiceStats();
            displayInvoices();
        }

        function filterInvoicesByPeriod(period) {
            const today = new Date();
            const dateFromInput = document.getElementById('invoiceDateFrom');
            const dateToInput = document.getElementById('invoiceDateTo');

            switch(period) {
                case 'today':
                    const todayStr = today.toISOString().split('T')[0];
                    dateFromInput.value = todayStr;
                    dateToInput.value = todayStr;
                    break;
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    dateFromInput.value = weekAgo.toISOString().split('T')[0];
                    dateToInput.value = today.toISOString().split('T')[0];
                    break;
                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    dateFromInput.value = monthAgo.toISOString().split('T')[0];
                    dateToInput.value = today.toISOString().split('T')[0];
                    break;
                case 'all':
                    dateFromInput.value = '';
                    dateToInput.value = '';
                    break;
            }
            filterInvoices();
        }

        function clearInvoiceFilters() {
            document.getElementById('invoiceSearch').value = '';
            document.getElementById('invoiceDateFrom').value = '';
            document.getElementById('invoiceDateTo').value = '';
            document.getElementById('invoicePaymentFilter').value = 'all';
            renderInvoices();
        }

        function viewInvoiceDetail(invoiceId) {
            const invoice = transactions.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            currentInvoiceId = invoiceId;

            const statusInfo = invoice.isRefunded 
                ? '<div style="background: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-weight: 600;">üî¥ This invoice has been refunded on ' + formatDate(invoice.refundedDate) + '</div>'
                : invoice.isExchanged 
                ? '<div style="background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-weight: 600;">üîÑ This invoice has been exchanged on ' + formatDate(invoice.exchangedDate) + '</div>'
                : '';

            document.getElementById('invoiceDetailContent').innerHTML = `
                ${statusInfo}
                <div style="border: 2px solid var(--light-gray); border-radius: 12px; padding: 25px; background: white;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--light-gray); padding-bottom: 20px;">
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--primary); margin-bottom: 5px;">INVOICE</div>
                        <div style="font-size: 1.2rem; color: var(--gray);">#${invoice.id.toString().padStart(8, '0')}</div>
                    </div>

                    <!-- Shop Details -->
                    <div style="margin-bottom: 25px;">
                        <div style="font-weight: 700; font-size: 1.2rem; margin-bottom: 8px;">${shopDetails.shopName}</div>
                        <div style="color: var(--gray); line-height: 1.6;">
                            ${shopDetails.shopAddress}<br>
                            Phone: ${shopDetails.shopPhone}<br>
                            ${shopDetails.shopEmail ? 'Email: ' + shopDetails.shopEmail + '<br>' : ''}
                            ${shopDetails.shopGST ? 'GST: ' + shopDetails.shopGST : ''}
                        </div>
                    </div>

                    <!-- Invoice Details -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; padding: 15px; background: var(--light); border-radius: 8px;">
                        <div>
                            <div style="font-size: 0.8rem; color: var(--gray); margin-bottom: 5px;">DATE & TIME</div>
                            <div style="font-weight: 600;">${formatDate(invoice.date)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--gray); margin-bottom: 5px;">PAYMENT METHOD</div>
                            <div style="font-weight: 600;">${invoice.paymentMethod}</div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--light-gray);">
                                <th style="padding: 12px; text-align: left; font-size: 0.85rem; color: var(--gray);">ITEM</th>
                                <th style="padding: 12px; text-align: center; font-size: 0.85rem; color: var(--gray);">QTY</th>
                                <th style="padding: 12px; text-align: right; font-size: 0.85rem; color: var(--gray);">PRICE</th>
                                <th style="padding: 12px; text-align: right; font-size: 0.85rem; color: var(--gray);">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr style="border-bottom: 1px solid var(--light-gray);">
                                    <td style="padding: 12px; font-weight: 600;">${item.name}</td>
                                    <td style="padding: 12px; text-align: center;">${item.qty}</td>
                                    <td style="padding: 12px; text-align: right;">${formatCurrency(item.price)}</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 600;">${formatCurrency(item.price * item.qty)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <!-- Totals -->
                    <div style="border-top: 2px solid var(--light-gray); padding-top: 15px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 1rem;">
                            <span>Subtotal:</span>
                            <span style="font-weight: 600;">${formatCurrency(invoice.subtotal)}</span>
                        </div>
                        ${invoice.discount > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; color: var(--success); font-size: 1rem;">
                                <span>Discount:</span>
                                <span style="font-weight: 600;">-${formatCurrency(invoice.discount)}</span>
                            </div>
                        ` : ''}
                        ${invoice.tax > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 1rem;">
                                <span>Tax (${invoice.taxPercent}%):</span>
                                <span style="font-weight: 600;">${formatCurrency(invoice.tax)}</span>
                            </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; padding: 15px 0; border-top: 2px solid var(--dark); margin-top: 10px; font-size: 1.3rem;">
                            <span style="font-weight: 700;">TOTAL:</span>
                            <span style="font-weight: 700; color: var(--primary);">${formatCurrency(invoice.total)}</span>
                        </div>
                    </div>

                    <!-- Footer -->
                    ${shopDetails.shopFooter ? `
                        <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--light-gray); color: var(--gray); font-size: 0.9rem;">
                            ${shopDetails.shopFooter}
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('invoiceDetailModal').classList.add('active');
        }

        function closeInvoiceDetailModal() {
            document.getElementById('invoiceDetailModal').classList.remove('active');
            currentInvoiceId = null;
        }

        function reprintInvoice() {
            if (!currentInvoiceId) return;
            const invoice = transactions.find(inv => inv.id === currentInvoiceId);
            if (!invoice) return;

            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice #${invoice.id.toString().padStart(8, '0')}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .shop-info { margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #f5f5f5; }
                        .totals { margin-top: 20px; }
                        .total-row { display: flex; justify-content: space-between; padding: 5px 0; }
                        .grand-total { font-size: 1.2em; font-weight: bold; border-top: 2px solid #000; margin-top: 10px; padding-top: 10px; }
                        .footer { text-align: center; margin-top: 30px; font-size: 0.9em; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>INVOICE</h1>
                        <h2>#${invoice.id.toString().padStart(8, '0')}</h2>
                    </div>
                    <div class="shop-info">
                        <strong>${shopDetails.shopName}</strong><br>
                        ${shopDetails.shopAddress}<br>
                        Phone: ${shopDetails.shopPhone}<br>
                        ${shopDetails.shopEmail ? 'Email: ' + shopDetails.shopEmail + '<br>' : ''}
                        ${shopDetails.shopGST ? 'GST: ' + shopDetails.shopGST : ''}
                    </div>
                    <div>
                        <strong>Date:</strong> ${formatDate(invoice.date)}<br>
                        <strong>Payment Method:</strong> ${invoice.paymentMethod}
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.qty}</td>
                                    <td>${formatCurrency(item.price)}</td>
                                    <td>${formatCurrency(item.price * item.qty)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="totals">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span>${formatCurrency(invoice.subtotal)}</span>
                        </div>
                        ${invoice.discount > 0 ? `
                            <div class="total-row">
                                <span>Discount:</span>
                                <span>-${formatCurrency(invoice.discount)}</span>
                            </div>
                        ` : ''}
                        ${invoice.tax > 0 ? `
                            <div class="total-row">
                                <span>Tax (${invoice.taxPercent}%):</span>
                                <span>${formatCurrency(invoice.tax)}</span>
                            </div>
                        ` : ''}
                        <div class="total-row grand-total">
                            <span>TOTAL:</span>
                            <span>${formatCurrency(invoice.total)}</span>
                        </div>
                    </div>
                    ${shopDetails.shopFooter ? `<div class="footer">${shopDetails.shopFooter}</div>` : ''}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function emailInvoice() {
            if (!currentInvoiceId) return;
            const invoice = transactions.find(inv => inv.id === currentInvoiceId);
            if (!invoice) return;

            const email = prompt('üìß Enter customer email address:', '');
            if (!email) return;

            if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                alert('‚ùå Invalid email address!');
                return;
            }

            // Simulate email sending (in real app, this would be a backend API call)
            const loading = document.createElement('div');
            loading.innerHTML = '<div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10000; text-align: center;"><div style="font-size: 2rem; margin-bottom: 10px;">üìß</div><div>Sending invoice...</div></div>';
            document.body.appendChild(loading);

            setTimeout(() => {
                document.body.removeChild(loading);
                alert(`‚úÖ Invoice #${invoice.id.toString().padStart(8, '0')} sent successfully to ${email}!\n\n(Note: This is a demo. In production, you would integrate with an email service like SendGrid, Mailgun, or AWS SES)`);
            }, 1500);
        }

        function smsInvoice() {
            if (!currentInvoiceId) return;
            const invoice = transactions.find(inv => inv.id === currentInvoiceId);
            if (!invoice) return;

            const phone = prompt('üì± Enter customer phone number:', '');
            if (!phone) return;

            if (!phone.match(/^\d{10}$/)) {
                alert('‚ùå Invalid phone number! Please enter 10 digits.');
                return;
            }

            // Simulate SMS sending (in real app, this would be a backend API call)
            const loading = document.createElement('div');
            loading.innerHTML = '<div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10000; text-align: center;"><div style="font-size: 2rem; margin-bottom: 10px;">üì±</div><div>Sending SMS...</div></div>';
            document.body.appendChild(loading);

            setTimeout(() => {
                document.body.removeChild(loading);
                alert(`‚úÖ Invoice details sent via SMS to ${phone}!\n\n(Note: This is a demo. In production, you would integrate with an SMS service like Twilio, AWS SNS, or MSG91)`);
            }, 1500);
        }

        // ===== EXPENSE MANAGEMENT =====
        function renderExpenses() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
            
            filterExpensesByPeriod('month');
        }

        function addExpense() {
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const description = document.getElementById('expenseDescription').value.trim();

            if (!date || !amount || amount <= 0) {
                alert('‚ùå Please fill in all required fields!');
                return;
            }

            const expense = {
                id: nextExpenseId++,
                date: new Date(date).toISOString(),
                category,
                amount,
                description,
                createdAt: new Date().toISOString()
            };

            expenses.push(expense);
            localStorage.setItem(STORAGE_KEYS.EXPENSES, JSON.stringify(expenses));

            // Clear form
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDescription').value = '';

            alert('‚úÖ Expense recorded successfully!');
            filterExpensesByPeriod('month');
        }

        function filterExpensesByPeriod(period) {
            const today = new Date();
            let startDate = new Date();

            switch(period) {
                case 'today':
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    startDate.setMonth(today.getMonth() - 1);
                    break;
                case 'all':
                    startDate = new Date(0);
                    break;
            }

            const filteredExpenses = expenses.filter(exp => new Date(exp.date) >= startDate);
            displayExpenses(filteredExpenses);
            updateExpenseStats(filteredExpenses);
        }

        function displayExpenses(expensesToShow) {
            const container = document.getElementById('expensesList');

            if (expensesToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; background: white; border-radius: 12px;">
                        <div style="font-size: 4rem; margin-bottom: 15px;">üí∏</div>
                        <div style="font-size: 1.3rem; font-weight: 600; color: var(--gray); margin-bottom: 8px;">No Expenses Found</div>
                        <div style="color: var(--gray);">Record your first expense to start tracking</div>
                    </div>
                `;
                return;
            }

            // Group by category
            const groupedExpenses = {};
            expensesToShow.forEach(exp => {
                if (!groupedExpenses[exp.category]) {
                    groupedExpenses[exp.category] = [];
                }
                groupedExpenses[exp.category].push(exp);
            });

            container.innerHTML = Object.keys(groupedExpenses).map(category => {
                const categoryExpenses = groupedExpenses[category];
                const categoryTotal = categoryExpenses.reduce((sum, exp) => sum + exp.amount, 0);

                return `
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid var(--light-gray);">
                            <h3 style="margin: 0; color: var(--dark);">${category}</h3>
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--danger);">${formatCurrency(categoryTotal)}</div>
                        </div>
                        ${categoryExpenses.map(exp => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--light-gray);">
                                <div>
                                    <div style="font-weight: 600;">${exp.description || 'No description'}</div>
                                    <div style="font-size: 0.85rem; color: var(--gray);">${formatDate(exp.date)}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--danger);">${formatCurrency(exp.amount)}</div>
                                    <button onclick="deleteExpense(${exp.id})" class="btn btn-delete" style="padding: 6px 12px; font-size: 0.85rem;">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        function updateExpenseStats(expensesToShow) {
            const today = new Date();
            const todayStart = new Date(today.setHours(0, 0, 0, 0));
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            const todayExpenses = expenses.filter(exp => new Date(exp.date) >= todayStart);
            const monthExpenses = expenses.filter(exp => new Date(exp.date) >= monthStart);

            const todayTotal = todayExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const monthTotal = monthExpenses.reduce((sum, exp) => sum + exp.amount, 0);

            // Calculate month revenue
            const monthTransactions = transactions.filter(t => new Date(t.date) >= monthStart && !t.isRefunded);
            const monthRevenue = monthTransactions.reduce((sum, t) => sum + t.total, 0);
            const monthProfit = monthRevenue - monthTotal;
            const cashFlow = monthProfit;

            document.getElementById('totalExpensesToday').textContent = formatCurrency(todayTotal);
            document.getElementById('totalExpensesMonth').textContent = formatCurrency(monthTotal);
            document.getElementById('profitThisMonth').textContent = formatCurrency(monthProfit);
            document.getElementById('cashFlow').textContent = formatCurrency(cashFlow);
        }

        function deleteExpense(expenseId) {
            if (!confirm('üóëÔ∏è Are you sure you want to delete this expense?')) return;

            expenses = expenses.filter(exp => exp.id !== expenseId);
            localStorage.setItem(STORAGE_KEYS.EXPENSES, JSON.stringify(expenses));
            filterExpensesByPeriod('month');
            alert('‚úÖ Expense deleted successfully!');
        }

        // ===== PROMOTION MANAGEMENT =====
        function renderPromotions() {
            updatePromotionStats();
            displayPromotions();
        }

        function updatePromotionStats() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const activePromotions = promotions.filter(promo => {
                if (!promo.active) return false;
                const start = new Date(promo.startDate);
                const end = new Date(promo.endDate);
                end.setHours(23, 59, 59, 999);
                
                if (now < start || now > end) return false;
                
                // Check time-based promotions
                if (promo.type === 'timebased' && promo.timeRange) {
                    const [startH, startM] = promo.timeRange.start.split(':').map(Number);
                    const [endH, endM] = promo.timeRange.end.split(':').map(Number);
                    const startMinutes = startH * 60 + startM;
                    const endMinutes = endH * 60 + endM;
                    if (currentTime < startMinutes || currentTime > endMinutes) return false;
                }
                
                return true;
            }).length;
            
            const upcomingPromotions = promotions.filter(promo => {
                const start = new Date(promo.startDate);
                return promo.active && start > now;
            }).length;
            
            const expiredPromotions = promotions.filter(promo => {
                const end = new Date(promo.endDate);
                end.setHours(23, 59, 59, 999);
                return end < now;
            }).length;
            
            const totalDiscountGiven = transactions.reduce((sum, trans) => {
                return sum + (trans.promotionDiscount || 0) + (trans.couponDiscount || 0);
            }, 0);
            
            document.getElementById('totalPromotionsCount').textContent = promotions.length;
            document.getElementById('activePromotionsCount').textContent = activePromotions;
            document.getElementById('upcomingPromotionsCount').textContent = upcomingPromotions;
            document.getElementById('totalDiscountGiven').textContent = formatCurrency(totalDiscountGiven);
        }

        function displayPromotions() {
            const container = document.getElementById('promotionsList');
            if (promotions.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray);">üì≠ No promotions yet. Create one to get started!</div>';
                return;
            }
            
            const now = new Date();
            
            const sortedPromotions = [...promotions].sort((a, b) => {
                const aStart = new Date(a.startDate);
                const bStart = new Date(b.startDate);
                return bStart - aStart;
            });
            
            container.innerHTML = sortedPromotions.map(promo => {
                const start = new Date(promo.startDate);
                const end = new Date(promo.endDate);
                end.setHours(23, 59, 59, 999);
                
                let status = '';
                let statusClass = '';
                if (now < start) {
                    status = 'Upcoming';
                    statusClass = 'upcoming';
                } else if (now > end) {
                    status = 'Expired';
                    statusClass = 'expired';
                } else {
                    status = promo.active ? 'Active' : 'Inactive';
                    statusClass = promo.active ? 'active' : 'inactive';
                }
                
                let typeIcon = '';
                let typeName = '';
                switch(promo.type) {
                    case 'bogo': typeIcon = 'üéÅ'; typeName = 'BOGO'; break;
                    case 'bundle': typeIcon = 'üì¶'; typeName = 'Bundle'; break;
                    case 'timebased': typeIcon = '‚è∞'; typeName = 'Time-Based'; break;
                    case 'seasonal': typeIcon = 'üéâ'; typeName = 'Seasonal'; break;
                    case 'coupon': typeIcon = 'üé´'; typeName = 'Coupon'; break;
                }
                
                return `
                    <div class="promo-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 1.3rem;">${typeIcon}</span>
                                    <h3 style="margin: 0; font-size: 1.1rem;">${promo.name}</h3>
                                </div>
                                <span class="promo-badge promo-badge-${statusClass}">${status}</span>
                                <span class="promo-badge" style="background: var(--light-gray); color: var(--dark);">${typeName}</span>
                            </div>
                            <div style="text-align: right;">
                                <button onclick="editPromotion(${promo.id})" style="padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 6px;">‚úèÔ∏è Edit</button>
                                <button onclick="deletePromotion(${promo.id})" style="padding: 6px 12px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer;">üóëÔ∏è</button>
                            </div>
                        </div>
                        ${promo.description ? `<p style="margin: 8px 0; color: var(--gray); font-size: 0.9rem;">${promo.description}</p>` : ''}
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 12px; font-size: 0.9rem;">
                            <div><strong>üìÖ Start:</strong> ${formatDate(promo.startDate)}</div>
                            <div><strong>üìÖ End:</strong> ${formatDate(promo.endDate)}</div>
                            ${promo.type === 'coupon' ? `
                                <div><strong>üé´ Code:</strong> <code style="background: var(--light-gray); padding: 2px 8px; border-radius: 4px; font-weight: 600;">${promo.couponCode}</code></div>
                                <div><strong>üìä Uses:</strong> ${promo.usedCount || 0}${promo.maxUses > 0 ? ` / ${promo.maxUses}` : ' (unlimited)'}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showPromotionModal(type) {
            const modal = document.getElementById('promotionModal');
            const titleMap = {
                'bogo': 'üéÅ Create BOGO Offer',
                'bundle': 'üì¶ Create Bundle Deal',
                'timebased': '‚è∞ Create Happy Hour',
                'seasonal': 'üéâ Create Seasonal Sale',
                'coupon': 'üé´ Create Coupon Code'
            };
            
            document.getElementById('promotionModalTitle').textContent = titleMap[type] || 'üéÅ Create Promotion';
            document.getElementById('promotionId').value = '';
            document.getElementById('promotionType').value = type;
            
            // Reset form
            document.getElementById('promotionName').value = '';
            document.getElementById('promotionStartDate').value = new Date().toISOString().split('T')[0];
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 7);
            document.getElementById('promotionEndDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('promotionDescription').value = '';
            
            // Hide all type-specific fields
            document.getElementById('bogoFields').style.display = 'none';
            document.getElementById('bundleFields').style.display = 'none';
            document.getElementById('timebasedFields').style.display = 'none';
            document.getElementById('seasonalFields').style.display = 'none';
            document.getElementById('couponFields').style.display = 'none';
            
            // Show relevant fields and populate
            switch(type) {
                case 'bogo':
                    document.getElementById('bogoFields').style.display = 'block';
                    populateProductSelect('bogoProduct');
                    document.getElementById('bogoType').value = 'free';
                    break;
                case 'bundle':
                    document.getElementById('bundleFields').style.display = 'block';
                    populateBundleProducts();
                    document.getElementById('bundleDiscount').value = '';
                    document.getElementById('bundlePrice').value = '';
                    break;
                case 'timebased':
                    document.getElementById('timebasedFields').style.display = 'block';
                    document.getElementById('timebasedStartTime').value = '17:00';
                    document.getElementById('timebasedEndTime').value = '20:00';
                    document.getElementById('timebasedDiscount').value = '';
                    document.getElementById('timebasedApplyTo').value = 'all';
                    document.getElementById('timebasedCategoryDiv').style.display = 'none';
                    populateCategorySelect('timebasedCategory');
                    break;
                case 'seasonal':
                    document.getElementById('seasonalFields').style.display = 'block';
                    document.getElementById('seasonalEvent').value = 'summer';
                    document.getElementById('seasonalDiscount').value = '';
                    document.getElementById('seasonalApplyTo').value = 'all';
                    document.getElementById('seasonalCategoryDiv').style.display = 'none';
                    document.getElementById('customEventDiv').style.display = 'none';
                    populateCategorySelect('seasonalCategory');
                    break;
                case 'coupon':
                    document.getElementById('couponFields').style.display = 'block';
                    document.getElementById('couponCode').value = '';
                    document.getElementById('couponDiscountType').value = 'percentage';
                    document.getElementById('couponDiscountValue').value = '';
                    document.getElementById('couponMinPurchase').value = '0';
                    document.getElementById('couponMaxUses').value = '0';
                    break;
            }
            
            modal.style.display = 'flex';
        }

        function closePromotionModal() {
            document.getElementById('promotionModal').style.display = 'none';
        }

        function populateProductSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- Select Product --</option>' + 
                products.map(p => `<option value="${p.id}">${p.name} - ${formatCurrency(p.price)}</option>`).join('');
        }

        function populateBundleProducts() {
            const container = document.getElementById('bundleProductsList');
            container.innerHTML = products.map(p => `
                <label style="display: block; padding: 8px; cursor: pointer; border-radius: 6px; margin-bottom: 6px;" onmouseover="this.style.background='var(--light-gray)'" onmouseout="this.style.background='white'">
                    <input type="checkbox" name="bundleProducts" value="${p.id}" style="margin-right: 8px;">
                    <span>${p.icon} ${p.name} - ${formatCurrency(p.price)}</span>
                </label>
            `).join('');
        }

        function populateCategorySelect(selectId) {
            const select = document.getElementById(selectId);
            const categories = JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES)) || ['Groceries', 'Beverages', 'Snacks', 'Personal Care', 'Household'];
            select.innerHTML = '<option value="">-- Select Category --</option>' + 
                categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // Event listeners for dynamic fields
        document.getElementById('timebasedApplyTo')?.addEventListener('change', function() {
            document.getElementById('timebasedCategoryDiv').style.display = this.value === 'category' ? 'block' : 'none';
        });

        document.getElementById('seasonalApplyTo')?.addEventListener('change', function() {
            document.getElementById('seasonalCategoryDiv').style.display = this.value === 'category' ? 'block' : 'none';
        });

        document.getElementById('seasonalEvent')?.addEventListener('change', function() {
            document.getElementById('customEventDiv').style.display = this.value === 'custom' ? 'block' : 'none';
        });

        function generateCouponCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('couponCode').value = code;
        }

        function savePromotion() {
            const id = document.getElementById('promotionId').value;
            const type = document.getElementById('promotionType').value;
            const name = document.getElementById('promotionName').value.trim();
            const startDate = document.getElementById('promotionStartDate').value;
            const endDate = document.getElementById('promotionEndDate').value;
            const description = document.getElementById('promotionDescription').value.trim();
            
            if (!name || !startDate || !endDate) {
                alert('‚ùå Please fill in all required fields!');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('‚ùå Start date must be before end date!');
                return;
            }
            
            const promotion = {
                id: id ? parseInt(id) : Date.now(),
                type,
                name,
                startDate,
                endDate,
                description,
                active: true,
                createdAt: id ? (promotions.find(p => p.id === parseInt(id))?.createdAt || new Date().toISOString()) : new Date().toISOString()
            };
            
            // Type-specific data
            switch(type) {
                case 'bogo':
                    const bogoProductId = document.getElementById('bogoProduct').value;
                    const bogoType = document.getElementById('bogoType').value;
                    if (!bogoProductId) {
                        alert('‚ùå Please select a product!');
                        return;
                    }
                    promotion.productId = parseInt(bogoProductId);
                    promotion.bogoType = bogoType;
                    break;
                    
                case 'bundle':
                    const bundleProducts = Array.from(document.querySelectorAll('input[name="bundleProducts"]:checked')).map(cb => parseInt(cb.value));
                    const bundleDiscount = parseFloat(document.getElementById('bundleDiscount').value);
                    const bundlePrice = parseFloat(document.getElementById('bundlePrice').value);
                    
                    if (bundleProducts.length < 2) {
                        alert('‚ùå Please select at least 2 products for a bundle!');
                        return;
                    }
                    if (!bundlePrice && (!bundleDiscount || bundleDiscount <= 0)) {
                        alert('‚ùå Please enter a valid discount or bundle price!');
                        return;
                    }
                    
                    promotion.bundleProducts = bundleProducts;
                    if (bundlePrice > 0) {
                        promotion.bundlePrice = bundlePrice;
                    } else {
                        promotion.bundleDiscount = bundleDiscount;
                    }
                    break;
                    
                case 'timebased':
                    const timeStart = document.getElementById('timebasedStartTime').value;
                    const timeEnd = document.getElementById('timebasedEndTime').value;
                    const timeDiscount = parseFloat(document.getElementById('timebasedDiscount').value);
                    const timeApplyTo = document.getElementById('timebasedApplyTo').value;
                    
                    if (!timeStart || !timeEnd || !timeDiscount || timeDiscount <= 0) {
                        alert('‚ùå Please fill in all time-based fields!');
                        return;
                    }
                    
                    promotion.timeRange = { start: timeStart, end: timeEnd };
                    promotion.discount = timeDiscount;
                    promotion.applyTo = timeApplyTo;
                    if (timeApplyTo === 'category') {
                        const category = document.getElementById('timebasedCategory').value;
                        if (!category) {
                            alert('‚ùå Please select a category!');
                            return;
                        }
                        promotion.category = category;
                    }
                    break;
                    
                case 'seasonal':
                    const seasonalEvent = document.getElementById('seasonalEvent').value;
                    const seasonalDiscount = parseFloat(document.getElementById('seasonalDiscount').value);
                    const seasonalApplyTo = document.getElementById('seasonalApplyTo').value;
                    
                    if (!seasonalDiscount || seasonalDiscount <= 0) {
                        alert('‚ùå Please enter a valid discount!');
                        return;
                    }
                    
                    promotion.event = seasonalEvent === 'custom' ? document.getElementById('customEventName').value.trim() : seasonalEvent;
                    promotion.discount = seasonalDiscount;
                    promotion.applyTo = seasonalApplyTo;
                    if (seasonalApplyTo === 'category') {
                        const category = document.getElementById('seasonalCategory').value;
                        if (!category) {
                            alert('‚ùå Please select a category!');
                            return;
                        }
                        promotion.category = category;
                    }
                    break;
                    
                case 'coupon':
                    const couponCode = document.getElementById('couponCode').value.trim().toUpperCase();
                    const couponDiscountType = document.getElementById('couponDiscountType').value;
                    const couponDiscountValue = parseFloat(document.getElementById('couponDiscountValue').value);
                    const couponMinPurchase = parseFloat(document.getElementById('couponMinPurchase').value) || 0;
                    const couponMaxUses = parseInt(document.getElementById('couponMaxUses').value) || 0;
                    
                    if (!couponCode || !couponDiscountValue || couponDiscountValue <= 0) {
                        alert('‚ùå Please fill in all coupon fields!');
                        return;
                    }
                    
                    // Check for duplicate coupon code
                    const existingCoupon = promotions.find(p => 
                        p.type === 'coupon' && 
                        p.couponCode === couponCode && 
                        p.id !== promotion.id
                    );
                    if (existingCoupon) {
                        alert('‚ùå This coupon code already exists!');
                        return;
                    }
                    
                    promotion.couponCode = couponCode;
                    promotion.discountType = couponDiscountType;
                    promotion.discountValue = couponDiscountValue;
                    promotion.minPurchase = couponMinPurchase;
                    promotion.maxUses = couponMaxUses;
                    promotion.usedCount = id ? (promotions.find(p => p.id === parseInt(id))?.usedCount || 0) : 0;
                    break;
            }
            
            // Save promotion
            if (id) {
                const index = promotions.findIndex(p => p.id === parseInt(id));
                promotions[index] = promotion;
            } else {
                promotions.push(promotion);
            }
            
            localStorage.setItem(STORAGE_KEYS.PROMOTIONS, JSON.stringify(promotions));
            closePromotionModal();
            renderPromotions();
            alert('‚úÖ Promotion saved successfully!');
        }

        function editPromotion(id) {
            const promo = promotions.find(p => p.id === id);
            if (!promo) return;
            
            showPromotionModal(promo.type);
            
            document.getElementById('promotionId').value = promo.id;
            document.getElementById('promotionName').value = promo.name;
            document.getElementById('promotionStartDate').value = promo.startDate;
            document.getElementById('promotionEndDate').value = promo.endDate;
            document.getElementById('promotionDescription').value = promo.description || '';
            
            // Load type-specific data
            switch(promo.type) {
                case 'bogo':
                    document.getElementById('bogoProduct').value = promo.productId;
                    document.getElementById('bogoType').value = promo.bogoType;
                    break;
                case 'bundle':
                    promo.bundleProducts.forEach(pid => {
                        const checkbox = document.querySelector(`input[name="bundleProducts"][value="${pid}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                    document.getElementById('bundleDiscount').value = promo.bundleDiscount || '';
                    document.getElementById('bundlePrice').value = promo.bundlePrice || '';
                    break;
                case 'timebased':
                    document.getElementById('timebasedStartTime').value = promo.timeRange.start;
                    document.getElementById('timebasedEndTime').value = promo.timeRange.end;
                    document.getElementById('timebasedDiscount').value = promo.discount;
                    document.getElementById('timebasedApplyTo').value = promo.applyTo;
                    if (promo.applyTo === 'category') {
                        document.getElementById('timebasedCategoryDiv').style.display = 'block';
                        document.getElementById('timebasedCategory').value = promo.category;
                    }
                    break;
                case 'seasonal':
                    document.getElementById('seasonalEvent').value = promo.event;
                    document.getElementById('seasonalDiscount').value = promo.discount;
                    document.getElementById('seasonalApplyTo').value = promo.applyTo;
                    if (promo.applyTo === 'category') {
                        document.getElementById('seasonalCategoryDiv').style.display = 'block';
                        document.getElementById('seasonalCategory').value = promo.category;
                    }
                    break;
                case 'coupon':
                    document.getElementById('couponCode').value = promo.couponCode;
                    document.getElementById('couponDiscountType').value = promo.discountType;
                    document.getElementById('couponDiscountValue').value = promo.discountValue;
                    document.getElementById('couponMinPurchase').value = promo.minPurchase;
                    document.getElementById('couponMaxUses').value = promo.maxUses;
                    break;
            }
        }

        function deletePromotion(id) {
            if (!confirm('Are you sure you want to delete this promotion?')) return;
            
            promotions = promotions.filter(p => p.id !== id);
            localStorage.setItem(STORAGE_KEYS.PROMOTIONS, JSON.stringify(promotions));
            renderPromotions();
            alert('‚úÖ Promotion deleted successfully!');
        }

        // ===== COUPON APPLICATION =====
        function showApplyCouponModal() {
            if (cart.length === 0) {
                alert('‚ùå Cart is empty! Add products first.');
                return;
            }
            document.getElementById('applyCouponModal').style.display = 'flex';
            document.getElementById('applyCouponCode').value = '';
            document.getElementById('couponMessage').style.display = 'none';
            document.getElementById('applyCouponCode').focus();
        }

        function closeApplyCouponModal() {
            document.getElementById('applyCouponModal').style.display = 'none';
        }

        function applyCouponCode() {
            const code = document.getElementById('applyCouponCode').value.trim().toUpperCase();
            const messageDiv = document.getElementById('couponMessage');
            
            if (!code) {
                messageDiv.textContent = '‚ùå Please enter a coupon code!';
                messageDiv.style.display = 'block';
                messageDiv.style.background = '#fee';
                messageDiv.style.color = 'var(--danger)';
                return;
            }
            
            // Find coupon
            const now = new Date();
            const coupon = promotions.find(p => {
                if (p.type !== 'coupon' || !p.active || p.couponCode !== code) return false;
                
                const start = new Date(p.startDate);
                const end = new Date(p.endDate);
                end.setHours(23, 59, 59, 999);
                
                if (now < start || now > end) return false;
                
                // Check max uses
                if (p.maxUses > 0 && p.usedCount >= p.maxUses) return false;
                
                return true;
            });
            
            if (!coupon) {
                messageDiv.textContent = '‚ùå Invalid or expired coupon code!';
                messageDiv.style.display = 'block';
                messageDiv.style.background = '#fee';
                messageDiv.style.color = 'var(--danger)';
                return;
            }
            
            // Check minimum purchase
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            if (coupon.minPurchase > 0 && subtotal < coupon.minPurchase) {
                messageDiv.textContent = `‚ùå Minimum purchase of ${formatCurrency(coupon.minPurchase)} required!`;
                messageDiv.style.display = 'block';
                messageDiv.style.background = '#fee';
                messageDiv.style.color = 'var(--danger)';
                return;
            }
            
            // Apply coupon
            appliedCoupon = coupon;
            messageDiv.textContent = `‚úÖ Coupon "${code}" applied successfully!`;
            messageDiv.style.display = 'block';
            messageDiv.style.background = '#efe';
            messageDiv.style.color = 'var(--success)';
            
            calculateBill();
            
            setTimeout(() => {
                closeApplyCouponModal();
            }, 1500);
        }

        function removeCoupon() {
            if (!appliedCoupon) return;
            
            if (confirm('Remove applied coupon?')) {
                appliedCoupon = null;
                calculateBill();
            }
        }

        // ===== SUPPLIER MANAGEMENT =====
        function renderSuppliers() {
            updateSupplierStats();
            displaySuppliers();
            populateSupplierDropdowns();
        }

        function updateSupplierStats() {
            const totalSuppliers = suppliers.length;
            const totalPOs = purchaseOrders.length;
            const pendingPOs = purchaseOrders.filter(po => po.status === 'pending').length;
            const totalPayable = purchaseOrders
                .filter(po => po.status === 'pending')
                .reduce((sum, po) => sum + po.total, 0);

            document.getElementById('totalSuppliersCount').textContent = totalSuppliers;
            document.getElementById('totalPurchaseOrders').textContent = totalPOs;
            document.getElementById('pendingPayments').textContent = pendingPOs;
            document.getElementById('totalPayableAmount').textContent = formatCurrency(totalPayable);
        }

        function displaySuppliers() {
            const container = document.getElementById('suppliersList');

            if (suppliers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; background: white; border-radius: 12px;">
                        <div style="font-size: 4rem; margin-bottom: 15px;">üè™</div>
                        <div style="font-size: 1.3rem; font-weight: 600; color: var(--gray); margin-bottom: 8px;">No Suppliers Added</div>
                        <div style="color: var(--gray);">Add your first supplier to start managing purchase orders</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = suppliers.map(supplier => {
                const supplierPOs = purchaseOrders.filter(po => po.supplierId === supplier.id);
                const pendingPOs = supplierPOs.filter(po => po.status === 'pending');
                const totalOrders = supplierPOs.length;
                const pendingAmount = pendingPOs.reduce((sum, po) => sum + po.total, 0);

                return `
                    <div style="background: white; border: 2px solid var(--light-gray); border-radius: 12px; padding: 20px; transition: var(--transition); cursor: pointer;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--light-gray)'">
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 20px; align-items: center;">
                            <div>
                                <div style="font-weight: 700; font-size: 1.2rem; color: var(--primary); margin-bottom: 5px;">${supplier.name}</div>
                                <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 3px;">üìû ${supplier.phone}</div>
                                ${supplier.email ? `<div style="font-size: 0.9rem; color: var(--gray);">üìß ${supplier.email}</div>` : ''}
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 4px;">TOTAL ORDERS</div>
                                <div style="font-weight: 700; font-size: 1.2rem;">${totalOrders}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 4px;">PENDING</div>
                                <div style="font-weight: 700; font-size: 1.2rem; color: var(--warning);">${pendingPOs.length}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 4px;">PAYABLE</div>
                                <div style="font-weight: 700; font-size: 1.2rem; color: var(--danger);">${formatCurrency(pendingAmount)}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="event.stopPropagation(); showPurchaseOrderModal(${supplier.id})" class="btn btn-primary" style="padding: 8px 12px;">üì¶ Order</button>
                                <button onclick="event.stopPropagation(); editSupplier(${supplier.id})" class="btn btn-edit" style="padding: 8px 12px;">‚úèÔ∏è</button>
                                <button onclick="event.stopPropagation(); deleteSupplier(${supplier.id})" class="btn btn-delete" style="padding: 8px 12px;">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAddSupplierModal() {
            editingSupplierId = null;
            document.getElementById('supplierModalTitle').textContent = '‚ûï Add Supplier';
            document.getElementById('supplierId').value = '';
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierContact').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierAddress').value = '';
            document.getElementById('supplierPaymentTerms').value = '30';
            document.getElementById('supplierGST').value = '';
            document.getElementById('supplierModal').classList.add('active');
        }

        function closeSupplierModal() {
            document.getElementById('supplierModal').classList.remove('active');
            editingSupplierId = null;
        }

        function saveSupplier() {
            const name = document.getElementById('supplierName').value.trim();
            const phone = document.getElementById('supplierPhone').value.trim();

            if (!name || !phone) {
                alert('‚ùå Please fill in required fields (Name and Phone)!');
                return;
            }

            const supplierData = {
                name,
                contactPerson: document.getElementById('supplierContact').value.trim(),
                phone,
                email: document.getElementById('supplierEmail').value.trim(),
                address: document.getElementById('supplierAddress').value.trim(),
                paymentTerms: parseInt(document.getElementById('supplierPaymentTerms').value) || 30,
                gst: document.getElementById('supplierGST').value.trim(),
                createdAt: new Date().toISOString()
            };

            if (editingSupplierId) {
                const supplier = suppliers.find(s => s.id === editingSupplierId);
                Object.assign(supplier, supplierData);
                alert('‚úÖ Supplier updated successfully!');
            } else {
                supplierData.id = nextSupplierId++;
                suppliers.push(supplierData);
                alert('‚úÖ Supplier added successfully!');
            }

            localStorage.setItem(STORAGE_KEYS.SUPPLIERS, JSON.stringify(suppliers));
            closeSupplierModal();
            renderSuppliers();
        }

        function editSupplier(supplierId) {
            const supplier = suppliers.find(s => s.id === supplierId);
            if (!supplier) return;

            editingSupplierId = supplierId;
            document.getElementById('supplierModalTitle').textContent = '‚úèÔ∏è Edit Supplier';
            document.getElementById('supplierId').value = supplier.id;
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierContact').value = supplier.contactPerson || '';
            document.getElementById('supplierPhone').value = supplier.phone;
            document.getElementById('supplierEmail').value = supplier.email || '';
            document.getElementById('supplierAddress').value = supplier.address || '';
            document.getElementById('supplierPaymentTerms').value = supplier.paymentTerms;
            document.getElementById('supplierGST').value = supplier.gst || '';
            document.getElementById('supplierModal').classList.add('active');
        }

        function deleteSupplier(supplierId) {
            if (!confirm('üóëÔ∏è Are you sure you want to delete this supplier?')) return;

            suppliers = suppliers.filter(s => s.id !== supplierId);
            localStorage.setItem(STORAGE_KEYS.SUPPLIERS, JSON.stringify(suppliers));
            renderSuppliers();
            populateSupplierDropdowns();
            alert('‚úÖ Supplier deleted successfully!');
        }

        function populateSupplierDropdowns() {
            const supplierSelects = [
                document.getElementById('productSupplier'),
                document.getElementById('poSupplier')
            ];

            supplierSelects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select Supplier --</option>' +
                    suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                select.value = currentValue;
            });
        }

        // ===== PURCHASE ORDER MANAGEMENT =====
        function showPurchaseOrderModal(supplierId) {
            currentPOItems = [];
            populateSupplierDropdowns();
            populatePOProducts();
            
            if (supplierId) {
                document.getElementById('poSupplier').value = supplierId;
            }

            // Set default delivery date (7 days from now)
            const deliveryDate = new Date();
            deliveryDate.setDate(deliveryDate.getDate() + 7);
            document.getElementById('poDeliveryDate').value = deliveryDate.toISOString().split('T')[0];

            updatePOItemsList();
            document.getElementById('purchaseOrderModal').classList.add('active');
        }

        function closePurchaseOrderModal() {
            document.getElementById('purchaseOrderModal').classList.remove('active');
            currentPOItems = [];
        }

        function populatePOProducts() {
            const select = document.getElementById('poProduct');
            select.innerHTML = '<option value="">-- Select Product --</option>' +
                products.map(p => `<option value="${p.id}">${p.name} (Current Stock: ${p.qty})</option>`).join('');
        }

        function addProductToPO() {
            const productId = parseInt(document.getElementById('poProduct').value);
            const quantity = parseInt(document.getElementById('poQuantity').value);
            const unitPrice = parseFloat(document.getElementById('poUnitPrice').value);

            if (!productId || !quantity || quantity <= 0 || !unitPrice || unitPrice <= 0) {
                alert('‚ùå Please fill in all fields!');
                return;
            }

            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Check if product already in list
            const existingItem = currentPOItems.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity += quantity;
                existingItem.total = existingItem.quantity * existingItem.unitPrice;
            } else {
                currentPOItems.push({
                    productId,
                    productName: product.name,
                    quantity,
                    unitPrice,
                    total: quantity * unitPrice
                });
            }

            // Clear inputs
            document.getElementById('poProduct').value = '';
            document.getElementById('poQuantity').value = '1';
            document.getElementById('poUnitPrice').value = '';

            updatePOItemsList();
        }

        function updatePOItemsList() {
            const container = document.getElementById('poItemsList');
            
            if (currentPOItems.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray);">No products added yet</div>';
                document.getElementById('poTotalAmount').textContent = '‚Çπ0.00';
                return;
            }

            const total = currentPOItems.reduce((sum, item) => sum + item.total, 0);

            container.innerHTML = `
                <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                    ${currentPOItems.map((item, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--light-gray);">
                            <div style="flex: 2;">
                                <div style="font-weight: 600;">${item.productName}</div>
                                <div style="font-size: 0.85rem; color: var(--gray);">${item.quantity} √ó ${formatCurrency(item.unitPrice)}</div>
                            </div>
                            <div style="font-weight: 700; font-size: 1.1rem; margin-right: 15px;">${formatCurrency(item.total)}</div>
                            <button onclick="removeProductFromPO(${index})" class="btn btn-delete" style="padding: 6px 10px; font-size: 0.85rem;">‚úñ</button>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('poTotalAmount').textContent = formatCurrency(total);
        }

        function removeProductFromPO(index) {
            currentPOItems.splice(index, 1);
            updatePOItemsList();
        }

        function savePurchaseOrder() {
            const supplierId = parseInt(document.getElementById('poSupplier').value);
            const deliveryDate = document.getElementById('poDeliveryDate').value;

            if (!supplierId) {
                alert('‚ùå Please select a supplier!');
                return;
            }

            if (currentPOItems.length === 0) {
                alert('‚ùå Please add at least one product!');
                return;
            }

            const supplier = suppliers.find(s => s.id === supplierId);
            const total = currentPOItems.reduce((sum, item) => sum + item.total, 0);

            const purchaseOrder = {
                id: nextPOId++,
                supplierId,
                supplierName: supplier.name,
                items: currentPOItems,
                total,
                deliveryDate: deliveryDate ? new Date(deliveryDate).toISOString() : null,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            purchaseOrders.push(purchaseOrder);
            localStorage.setItem(STORAGE_KEYS.PURCHASE_ORDERS, JSON.stringify(purchaseOrders));

            alert(`‚úÖ Purchase Order #${purchaseOrder.id} created successfully!\n\nSupplier: ${supplier.name}\nTotal: ${formatCurrency(total)}\nItems: ${currentPOItems.length}`);
            
            closePurchaseOrderModal();
            renderSuppliers();
        }

        // ===== LOW STOCK ALERTS =====
        function checkLowStock() {
            const lowStockProducts = products.filter(p => {
                const minStock = p.minStock || 10;
                return p.qty <= minStock && p.qty > 0;
            });

            const outOfStockProducts = products.filter(p => p.qty === 0);

            if (lowStockProducts.length === 0 && outOfStockProducts.length === 0) {
                return;
            }

            let alertMessage = '';
            
            if (lowStockProducts.length > 0) {
                alertMessage += `<div style="margin-bottom: 10px;"><strong>‚ö†Ô∏è Low Stock (${lowStockProducts.length}):</strong></div>`;
                alertMessage += lowStockProducts.slice(0, 5).map(p => 
                    `<div style="padding: 5px 0; font-size: 0.85rem;">‚Ä¢ ${p.name}: ${p.qty} left (min: ${p.minStock || 10})</div>`
                ).join('');
                if (lowStockProducts.length > 5) {
                    alertMessage += `<div style="padding: 5px 0; font-size: 0.85rem;">‚Ä¢ +${lowStockProducts.length - 5} more products</div>`;
                }
            }

            if (outOfStockProducts.length > 0) {
                alertMessage += `<div style="margin-top: 10px; margin-bottom: 10px;"><strong>üî¥ Out of Stock (${outOfStockProducts.length}):</strong></div>`;
                alertMessage += outOfStockProducts.slice(0, 3).map(p => 
                    `<div style="padding: 5px 0; font-size: 0.85rem;">‚Ä¢ ${p.name}</div>`
                ).join('');
                if (outOfStockProducts.length > 3) {
                    alertMessage += `<div style="padding: 5px 0; font-size: 0.85rem;">‚Ä¢ +${outOfStockProducts.length - 3} more products</div>`;
                }
            }

            alertMessage += `<div style="margin-top: 15px;"><button onclick="switchTab('suppliers')" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">üì¶ Reorder from Suppliers</button></div>`;

            document.getElementById('lowStockAlertContent').innerHTML = alertMessage;
            document.getElementById('lowStockAlert').style.display = 'block';

            // Auto-hide after 10 seconds
            setTimeout(() => {
                closeLowStockAlert();
            }, 10000);
        }

        function closeLowStockAlert() {
            document.getElementById('lowStockAlert').style.display = 'none';
        }

        // ===== SETTINGS MANAGEMENT =====
        function loadShopSettings() {
            document.getElementById('shopName').value = shopDetails.shopName;
            document.getElementById('shopAddress').value = shopDetails.shopAddress;
            document.getElementById('shopPhone').value = shopDetails.shopPhone;
            document.getElementById('shopEmail').value = shopDetails.shopEmail;
            document.getElementById('shopGST').value = shopDetails.shopGST;
            document.getElementById('shopFooter').value = shopDetails.shopFooter;
            renderCategoriesList();
        }

        function renderCategoriesList() {
            const list = document.getElementById('categoriesList');
            list.innerHTML = categories.map((cat, index) => `
                <div class="category-item">
                    <div class="category-info">
                        <span style="font-size: 1.2rem;">${cat.icon}</span>
                        <span style="font-weight: 600;">${cat.name}</span>
                    </div>
                    <button class="btn btn-delete" onclick="deleteCategory(${index})" 
                            style="padding: 6px 12px; font-size: 0.85rem;">
                        Delete
                    </button>
                </div>
            `).join('');
        }

        function addCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const icon = document.getElementById('newCategoryIcon').value.trim();

            if (!name) {
                alert('Please enter category name');
                return;
            }

            if (!icon) {
                alert('Please enter category icon (emoji)');
                return;
            }

            // Check for duplicates
            if (categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                alert('Category already exists');
                return;
            }

            categories.push({ name, icon });
            saveData();
            
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryIcon').value = '';
            
            renderCategoriesList();
            renderInventory();
            alert('‚úÖ Category added successfully!');
        }

        function deleteCategory(index) {
            const category = categories[index];
            
            // Check if any products use this category
            const productsInCategory = products.filter(p => p.category === category.name);
            if (productsInCategory.length > 0) {
                alert(`Cannot delete category "${category.name}". ${productsInCategory.length} product(s) use this category. Please change their category first.`);
                return;
            }

            if (!confirm(`Delete category "${category.name}"?`)) return;

            categories.splice(index, 1);
            saveData();
            renderCategoriesList();
            renderInventory();
            alert('‚úÖ Category deleted!');
        }

        function saveShopSettings() {
            shopDetails.shopName = document.getElementById('shopName').value.trim();
            shopDetails.shopAddress = document.getElementById('shopAddress').value.trim();
            shopDetails.shopPhone = document.getElementById('shopPhone').value.trim();
            shopDetails.shopEmail = document.getElementById('shopEmail').value.trim();
            shopDetails.shopGST = document.getElementById('shopGST').value.trim();
            shopDetails.shopFooter = document.getElementById('shopFooter').value.trim();

            if (!shopDetails.shopName) {
                alert('Please enter shop name');
                return;
            }

            saveData();
            alert('‚úÖ Shop settings saved successfully!');
        }

        // ===== ANIMATION FUNCTIONS =====
        function showToast(message, type = 'info', duration = 3000) {
            // Create toast container if it doesn't exist
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container';
                document.body.appendChild(toastContainer);
            }

            // Icon based on type
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.closest('.toast').remove()">√ó</button>
            `;

            toastContainer.appendChild(toast);

            // Auto remove after duration
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function createConfetti() {
            const confettiContainer = document.createElement('div');
            confettiContainer.className = 'confetti-container';
            document.body.appendChild(confettiContainer);

            const colors = ['#667eea', '#764ba2', '#4caf50', '#ff9800', '#ff6b6b', '#00bcd4', '#e91e63', '#ffd700'];
            const shapes = ['‚óè', '‚òÖ', '‚ñ†', '‚ñ≤', '‚ô¶'];
            const confettiCount = 100;

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.textContent = shapes[Math.floor(Math.random() * shapes.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = 'transparent';
                confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.fontSize = (Math.random() * 15 + 10) + 'px';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                confettiContainer.appendChild(confetti);
            }

            setTimeout(() => {
                confettiContainer.remove();
            }, 4000);
        }

        function createSparkles(x, y, count = 20) {
            const sparkleEmojis = ['‚ú®', '‚≠ê', 'üí´', 'üåü', 'üí•', 'üéâ'];
            
            for (let i = 0; i < count; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.textContent = sparkleEmojis[Math.floor(Math.random() * sparkleEmojis.length)];
                sparkle.style.left = x + 'px';
                sparkle.style.top = y + 'px';
                
                const angle = (Math.PI * 2 * i) / count;
                const distance = 50 + Math.random() * 50;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                sparkle.style.setProperty('--tx', tx + 'px');
                sparkle.style.setProperty('--ty', ty + 'px');
                
                document.body.appendChild(sparkle);
                
                sparkle.animate([
                    { transform: 'translate(0, 0) scale(0) rotate(0deg)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(1.5) rotate(180deg)`, opacity: 1, offset: 0.5 },
                    { transform: `translate(${tx * 1.5}px, ${ty * 1.5}px) scale(0) rotate(360deg)`, opacity: 0 }
                ], {
                    duration: 1000,
                    easing: 'ease-out'
                });
                
                setTimeout(() => sparkle.remove(), 1000);
            }
        }

        function createSuccessRipple(x, y) {
            const ripple = document.createElement('div');
            ripple.className = 'success-ripple';
            ripple.style.left = (x - 250) + 'px';
            ripple.style.top = (y - 250) + 'px';
            document.body.appendChild(ripple);
            
            setTimeout(() => ripple.remove(), 800);
        }

        function addShakeAnimation(element) {
            element.classList.add('shake-animation');
            setTimeout(() => element.classList.remove('shake-animation'), 500);
        }

        function addPulseAnimation(element) {
            element.classList.add('pulse-animation');
            setTimeout(() => element.classList.remove('pulse-animation'), 600);
        }

        function addBounceAnimation(element) {
            element.classList.add('bounce-in');
            setTimeout(() => element.classList.remove('bounce-in'), 600);
        }

        function addSlideInAnimation(element) {
            element.classList.add('slide-in-right');
            setTimeout(() => element.classList.remove('slide-in-right'), 400);
        }

        function celebrateSuccess(message) {
            // Create confetti
            createConfetti();
            
            // Create sparkles at center
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            createSparkles(centerX, centerY, 30);
            
            // Create success ripple
            createSuccessRipple(centerX, centerY);
            
            // Play success sound (optional - you can add sound files)
            // new Audio('success.mp3').play();
        }

        // ===== DATA RESET FUNCTIONS =====
        function confirmReset() {
            document.getElementById('confirmModal').classList.add('active');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        // ===== APP INSTALLATION FUNCTIONS =====
        function installAppForAllDevices() {
            const deferredPrompt = window.deferredPrompt;
            
            if (!deferredPrompt) {
                // If browser doesn't support installation, show manual instructions
                showInstallationGuide();
                return;
            }

            // Show the installation prompt
            deferredPrompt.prompt();
            
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    alert('‚úÖ App installation started! You can now access Supermarket Management System from your app drawer or home screen.');
                    window.deferredPrompt = null;
                } else {
                    showInstallationGuide();
                }
            });
        }

        function showInstallationGuide() {
            const guide = `
                <div class="modal active" style="z-index: 10000;">
                    <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <span>üì± Installation Guide</span>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <h3 style="margin-bottom: 15px; color: var(--primary);">How to Install on Different Devices:</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--dark); margin-bottom: 10px;">üì± Android Phone/Tablet:</h4>
                                <ol style="margin-left: 20px; line-height: 1.8;">
                                    <li>Open this website in Chrome or Firefox browser</li>
                                    <li>Tap the three dots menu (‚ãÆ) in the top right</li>
                                    <li>Select "Install app" or "Add to Home screen"</li>
                                    <li>Follow the on-screen prompts</li>
                                    <li>The app will now appear on your home screen</li>
                                </ol>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--dark); margin-bottom: 10px;">üçé iPhone/iPad:</h4>
                                <ol style="margin-left: 20px; line-height: 1.8;">
                                    <li>Open this website in Safari browser</li>
                                    <li>Tap the Share button (square with arrow)</li>
                                    <li>Scroll down and tap "Add to Home Screen"</li>
                                    <li>Choose an app name and tap Add</li>
                                    <li>The app will now appear on your home screen</li>
                                </ol>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--dark); margin-bottom: 10px;">üíª Windows/Mac (Desktop):</h4>
                                <ol style="margin-left: 20px; line-height: 1.8;">
                                    <li>Open this website in Chrome, Edge, or Brave</li>
                                    <li>Look for the install icon (usually next to the address bar)</li>
                                    <li>Click "Install" when prompted</li>
                                    <li>The app will open in its own window like a desktop app</li>
                                </ol>
                            </div>

                            <div style="background: var(--light); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success);">
                                <strong>üí° Tips:</strong>
                                <ul style="margin-top: 10px; margin-left: 20px;">
                                    <li>After installation, you can use the app offline</li>
                                    <li>Your data syncs across all installed devices automatically</li>
                                    <li>No need to download from app stores</li>
                                    <li>Updates happen automatically in the background</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="modal-btn modal-btn-confirm" onclick="this.closest('.modal').remove()" style="background: var(--primary);">
                                Got it, thanks!
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', guide);
        }

        // ===== DATA RESET FUNCTIONS =====
        function confirmReset() {
            document.getElementById('confirmModal').classList.add('active');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        function forceResetSystem() {
            localStorage.clear();
            location.reload();
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è This will delete ALL data including products, transactions, and settings. This action cannot be undone. Are you sure?')) {
                return;
            }

            products = [];
            cart = [];
            transactions = [];
            categories = [
                { name: 'Vegetables', icon: 'ü•¨' },
                { name: 'Fruits', icon: 'üçé' },
                { name: 'Dairy', icon: 'ü•õ' },
                { name: 'Meat', icon: 'üçñ' },
                { name: 'Bakery', icon: 'üçû' },
                { name: 'Beverages', icon: 'ü•§' }
            ];
            shopDetails = {
                shopName: 'Supermarket Store',
                shopAddress: '123 Market Street, City Center',
                shopPhone: '+91 9876543210',
                shopEmail: 'shop@example.com',
                shopGST: '',
                shopFooter: 'Thank you for your purchase! Visit us again.'
            };
            nextProductId = 1;

            saveData();
            
            if (document.getElementById('pos').classList.contains('active')) {
                renderProducts();
            } else if (document.getElementById('inventory').classList.contains('active')) {
                renderInventory();
            } else if (document.getElementById('dashboard').classList.contains('active')) {
                renderDashboard();
            } else if (document.getElementById('settings').classList.contains('active')) {
                loadShopSettings();
            }
            
            updateCart();
            alert('‚úÖ All data cleared! Starting fresh.');
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize all sections
            loadShopSettings();
            renderProducts();
            renderInventory();
            renderDashboard();
            updateCart();
            populateSupplierDropdowns();
            checkLowStock();

            // Register service worker for offline support
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js').then(registration => {
                    console.log('‚úÖ Service Worker registered:', registration);
                }).catch(error => {
                    console.log('‚ö†Ô∏è Service Worker registration failed:', error);
                });
            }

            // Listen for beforeinstallprompt event globally
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                window.deferredPrompt = e;
                console.log('‚úÖ Install prompt ready!');
            });

            // Track app installation
            window.addEventListener('appinstalled', () => {
                console.log('‚úÖ App successfully installed!');
                window.deferredPrompt = null;
            });

            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            // Close modals with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });

            // Initialize navigation visibility based on user role
            updateNavigationVisibility();

            console.log('üöÄ Supermarket Management System Ready!');
            console.log(`üì¶ Products: ${products.length}`);
            console.log(`üí∞ Transactions: ${transactions.length}`);
            console.log(`üè™ Shop: ${shopDetails.shopName}`);
        });
    </script>
</body>
</html>