<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supermarket Management System - POS</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --danger: #ff6b6b;
            --success: #4caf50;
            --warning: #ff9800;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 12px;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }

        /* ===== CONTAINER & LAYOUT ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            min-height: calc(100vh - 40px);
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
            max-width: 600px;
            margin: 0 auto;
        }



        /* ===== NAVIGATION ===== */
        .nav-tabs {
            display: flex;
            background: var(--light);
            border-bottom: 2px solid var(--light-gray);
        }

        .nav-tab {
            flex: 1;
            padding: 16px 20px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--gray);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.05);
            color: var(--primary);
        }

        .nav-tab.active {
            color: var(--primary);
            background: white;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 3px 3px 0 0;
        }

        /* ===== CONTENT SECTIONS ===== */
        .content {
            padding: 30px;
        }

        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== POS SECTION ===== */
        .pos-header {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .pos-search {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .pos-search input {
            width: 100%;
            padding: 12px 45px 12px 45px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .pos-search input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .pos-search::before {
            content: 'üîç';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .barcode-input {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .barcode-input input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .barcode-input::before {
            content: 'üì∑';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .customer-info-card {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .customer-info-card h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .customer-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .customer-form input {
            padding: 10px 12px;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .customer-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .discount-tax-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 2px solid var(--light-gray);
        }

        .discount-tax-section h4 {
            font-size: 0.9rem;
            margin-bottom: 12px;
            color: var(--dark);
        }

        .discount-tax-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .discount-tax-controls input,
        .discount-tax-controls select {
            padding: 8px 10px;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .quick-discount-btns {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .quick-discount-btn {
            padding: 6px 12px;
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .quick-discount-btn:hover {
            background: var(--primary);
            color: white;
        }

        .pos-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .product-card:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            transform: translateY(-5px);
        }

        .product-card.out-of-stock {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .product-card.out-of-stock:hover {
            transform: none;
            border-color: var(--light-gray);
            box-shadow: none;
        }

        .product-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .product-price {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .product-stock {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 15px;
        }

        .product-stock.low {
            color: var(--warning);
            font-weight: 600;
        }

        .product-stock.out {
            color: var(--danger);
            font-weight: 600;
        }

        /* ===== CART SECTION ===== */
        .cart-section {
            background: var(--light);
            border-radius: 12px;
            padding: 25px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .cart-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
        }

        .cart-count {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .cart-items {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
        }

        .cart-items::-webkit-scrollbar {
            width: 6px;
        }

        .cart-items::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 3px;
        }

        .cart-items::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .cart-item {
            background: white;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .cart-item-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .cart-item-info {
            flex: 1;
            min-width: 0;
        }

        .cart-item-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--dark);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cart-item-price {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid var(--light-gray);
            background: white;
            color: var(--dark);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .qty-btn:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .qty-display {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
        }

        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .remove-btn:hover {
            background: #ff5252;
            transform: scale(1.05);
        }

        /* ===== CART SUMMARY ===== */
        .cart-summary {
            border-top: 2px solid var(--light-gray);
            padding-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .summary-row.total {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--light-gray);
        }

        .checkout-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 15px;
        }

        .checkout-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .checkout-btn:disabled {
            background: var(--light-gray);
            color: var(--gray);
            cursor: not-allowed;
            transform: none !important;
        }

        .clear-cart-btn {
            width: 100%;
            padding: 12px;
            background: var(--light-gray);
            color: var(--gray);
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: var(--transition);
        }

        .clear-cart-btn:hover {
            background: white;
            border-color: var(--danger);
            color: var(--danger);
        }

        .exchange-refund-btn {
            transition: var(--transition);
        }

        .exchange-refund-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .exchange-refund-btn:active {
            transform: translateY(0) !important;
        }

        .transaction-card:not([style*="cursor: not-allowed"]):hover {
            border-color: var(--primary) !important;
            transform: translateX(5px);
        }

        /* ===== ADMIN PANEL STYLES ===== */
        .admin-login {
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
        }

        .admin-login-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .admin-login-card h2 {
            margin-bottom: 10px;
            color: var(--dark);
        }

        .admin-login-card p {
            color: var(--gray);
            margin-bottom: 30px;
        }

        .pin-input-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .pin-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            transition: var(--transition);
        }

        .pin-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .admin-content {
            display: none;
        }

        .admin-content.authenticated {
            display: block;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .admin-header h2 {
            margin: 0;
            font-size: 1.8rem;
        }

        .admin-logout-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .admin-logout-btn:hover {
            background: white;
            color: var(--primary);
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
        }

        .admin-card h3 {
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-stock-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .quick-stock-info {
            flex: 1;
        }

        .quick-stock-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .quick-stock-current {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .quick-stock-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .quick-stock-input {
            width: 70px;
            padding: 6px;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        .quick-stock-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .quick-stock-btn.add {
            background: var(--success);
            color: white;
        }

        .quick-stock-btn.remove {
            background: var(--danger);
            color: white;
        }

        .quick-stock-btn:hover {
            transform: scale(1.05);
        }

        .admin-action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .admin-action-btn {
            padding: 20px;
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            font-weight: 600;
        }

        .admin-action-btn:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .admin-action-btn .icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
        }

        .pin-change-form {
            display: grid;
            gap: 15px;
        }

        /* ===== INVENTORY SECTION ===== */
        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .inventory-search-bar {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .inventory-search-bar input {
            width: 100%;
            padding: 12px 45px 12px 45px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .inventory-search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .inventory-search-bar::before {
            content: 'üîç';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .inventory-search-bar .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--gray);
            display: none;
        }

        .inventory-search-bar .clear-search.active {
            display: block;
        }

        .inventory-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: var(--transition);
            color: var(--gray);
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .inventory-quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-stat {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .quick-stat-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 5px;
        }

        .quick-stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .bulk-action-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bulk-action-btn:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .inventory-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            background: var(--light);
            padding: 25px;
            border-radius: 12px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark);
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            padding: 12px 15px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-product-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: var(--transition);
            align-self: flex-end;
        }

        .add-product-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        /* ===== TABLES ===== */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            -webkit-overflow-scrolling: touch;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 1300px;
            table-layout: fixed;
        }

        .table th {
            background: var(--light);
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--light-gray);
            border-right: 1px solid var(--light-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }

        .table th:hover {
            background: var(--light-gray);
        }

        .table th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.3;
            font-size: 0.8rem;
        }

        .table th.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
            color: var(--primary);
        }

        .table th.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
            color: var(--primary);
        }
        
        .table th:last-child {
            border-right: none;
        }

        .table td {
            padding: 15px 12px;
            border-bottom: 1px solid var(--light-gray);
            border-right: 1px solid #f0f0f0;
            vertical-align: middle;
            overflow: hidden;
            word-wrap: break-word;
        }
        
        .table td:last-child {
            border-right: none;
        }
        
        /* Set exact column widths */
        .table th:nth-child(1),
        .table td:nth-child(1) {
            width: 200px;
        }
        
        .table th:nth-child(2),
        .table td:nth-child(2) {
            width: 110px;
        }
        
        .table th:nth-child(3),
        .table td:nth-child(3) {
            width: 120px;
        }
        
        .table th:nth-child(4),
        .table td:nth-child(4) {
            width: 120px;
        }
        
        .table th:nth-child(5),
        .table td:nth-child(5) {
            width: 120px;
        }
        
        .table th:nth-child(6),
        .table td:nth-child(6) {
            width: 130px;
        }
        
        .table th:nth-child(7),
        .table td:nth-child(7) {
            width: 80px;
            text-align: center;
        }
        
        .table th:nth-child(8),
        .table td:nth-child(8) {
            width: 120px;
        }
        
        .table th:nth-child(9),
        .table td:nth-child(9) {
            width: 160px;
        }

        .table tr:hover {
            background: rgba(102, 126, 234, 0.03);
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: var(--transition);
            white-space: nowrap;
        }

        .btn-edit {
            background: var(--primary);
            color: white;
        }

        .btn-edit:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .btn-delete:hover {
            background: #ff5252;
            transform: translateY(-1px);
        }

        /* ===== DASHBOARD ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .dashboard-card h3 {
            font-size: 1.2rem;
            color: var(--dark);
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ===== SETTINGS ===== */
        .settings-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }

        .settings-card h3 {
            font-size: 1.3rem;
            color: var(--dark);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .categories-list {
            display: grid;
            gap: 12px;
            margin-top: 20px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--light);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--light-gray);
            color: var(--dark);
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            min-width: 100px;
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .modal-btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .modal-btn-cancel {
            background: var(--light-gray);
            color: var(--dark);
        }

        .modal-btn-cancel:hover {
            background: #d1d9e6;
        }

        /* ===== PAYMENT METHODS ===== */
        .payment-methods {
            display: grid;
            gap: 12px;
        }

        .payment-method-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
            transition: var(--transition);
            text-align: left;
        }

        .payment-method-btn:hover {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
            transform: translateX(5px);
        }
        
        @media (max-width: 768px) {
            .payment-method-btn {
                padding: 15px 15px;
                gap: 12px;
                font-size: 0.95rem;
            }
        }
        
        @media (max-width: 480px) {
            .payment-method-btn {
                padding: 12px 12px;
                gap: 10px;
                font-size: 0.9rem;
            }
        }

        .payment-method-icon {
            font-size: 1.8rem;
            width: 40px;
            text-align: center;
        }

        /* ===== RECEIPT ===== */
        .receipt {
            width: 100%;
            max-width: 400px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        
        @media (max-width: 768px) {
            .receipt {
                max-width: 95vw;
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .receipt {
                max-width: 100%;
                padding: 15px;
                border-radius: 8px;
            }
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed var(--dark);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .receipt-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .receipt-shop-info {
            font-size: 0.85rem;
            color: var(--gray);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .receipt-date {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .receipt-items {
            margin-bottom: 20px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
            padding-bottom: 8px;
            border-bottom: 1px dashed var(--light-gray);
        }

        .receipt-item-name {
            flex: 1;
        }

        .receipt-item-qty {
            width: 40px;
            text-align: center;
        }

        .receipt-item-price {
            width: 80px;
            text-align: right;
            font-weight: 600;
        }

        .receipt-totals {
            border-top: 2px dashed var(--dark);
            padding-top: 15px;
            margin-top: 15px;
        }

        .receipt-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .receipt-total-row.grand-total {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--light-gray);
        }

        .receipt-payment {
            margin: 15px 0;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .receipt-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed var(--light-gray);
            font-size: 0.85rem;
            color: var(--gray);
            line-height: 1.5;
        }

        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .empty-state-subtext {
            font-size: 0.95rem;
            opacity: 0.7;
        }
        
        @media (max-width: 768px) {
            .empty-state {
                padding: 40px 15px;
            }
            
            .empty-state-icon {
                font-size: 2.5rem;
                margin-bottom: 15px;
            }
            
            .empty-state-text {
                font-size: 1rem;
            }
            
            .empty-state-subtext {
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            .empty-state {
                padding: 30px 12px;
            }
            
            .empty-state-icon {
                font-size: 2rem;
                margin-bottom: 12px;
            }
            
            .empty-state-text {
                font-size: 0.95rem;
                margin-bottom: 8px;
            }
            
            .empty-state-subtext {
                font-size: 0.85rem;
            }
        }

        /* ===== ALERT CARDS ===== */
        .alert-card {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #e8f5e9;
            border-left-color: var(--success);
        }

        .alert-warning {
            background: #fff3cd;
            border-left-color: var(--warning);
        }

        .alert-danger {
            background: #ffebee;
            border-left-color: var(--danger);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        
        /* ===== TABLETS & SMALL SCREENS (768px - 1024px) ===== */
        @media (max-width: 1024px) {
            body {
                padding: 15px;
            }
            
            .container {
                min-height: calc(100vh - 30px);
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .reset-btn {
                top: 15px;
                right: 15px;
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .content {
                padding: 25px;
            }
            
            .pos-container {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .cart-section {
                position: relative;
                top: 0;
                height: auto;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 15px;
            }
            
            .product-card {
                padding: 15px;
            }
            
            .product-icon {
                font-size: 2rem;
                height: 50px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .inventory-controls {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                padding: 20px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .table-container {
                font-size: 0.9rem;
            }
            
            .table th,
            .table td {
                padding: 12px 10px;
            }
        }
        
        /* ===== MOBILE SCREENS (481px - 768px) ===== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                min-height: calc(100vh - 20px);
                border-radius: 8px;
            }
            
            .header {
                padding: 15px 12px;
            }
            
            .header h1 {
                font-size: 1.4rem;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            .reset-btn {
                top: 10px;
                right: 10px;
                padding: 5px 10px;
                font-size: 0.75rem;
            }
            
            .nav-tabs {
                flex-direction: column;
                border-bottom: 1px solid var(--light-gray);
            }
            
            .nav-tab {
                text-align: left;
                padding: 12px 15px;
                font-size: 0.9rem;
                border-bottom: 1px solid var(--light-gray);
            }
            
            .nav-tab.active {
                background: rgba(102, 126, 234, 0.1);
                border-left: 4px solid var(--primary);
                padding-left: calc(15px - 4px);
            }
            
            .nav-tab.active::after {
                display: none;
            }
            
            .content {
                padding: 15px;
            }
            
            .section-title {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }
            
            .pos-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 12px;
            }
            
            .product-card {
                padding: 12px;
                border-radius: 8px;
            }
            
            .product-icon {
                font-size: 1.8rem;
                height: 45px;
                margin-bottom: 8px;
            }
            
            .product-name {
                font-size: 0.85rem;
                margin-bottom: 5px;
            }
            
            .product-price {
                font-size: 0.95rem;
                margin-bottom: 3px;
            }
            
            .product-stock {
                font-size: 0.75rem;
                margin-bottom: 10px;
            }
            
            .add-btn {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            
            .cart-section {
                padding: 20px;
                border-radius: 8px;
            }
            
            .cart-title {
                font-size: 1.1rem;
            }
            
            .cart-count {
                font-size: 0.75rem;
                padding: 3px 10px;
            }
            
            .cart-items {
                max-height: 300px;
            }
            
            .cart-item {
                padding: 12px;
                margin-bottom: 10px;
                gap: 10px;
            }
            
            .cart-item-name {
                font-size: 0.85rem;
            }
            
            .cart-item-icon {
                font-size: 1.3rem;
            }
            
            .qty-btn {
                width: 24px;
                height: 24px;
                font-size: 0.9rem;
            }
            
            .qty-display {
                min-width: 25px;
                font-size: 0.9rem;
            }
            
            .remove-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
            }
            
            .checkout-btn,
            .clear-cart-btn {
                font-size: 0.9rem;
                padding: 12px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-label {
                font-size: 0.85rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .inventory-controls {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 15px;
            }
            
            .input-group input,
            .input-group select {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .input-group label {
                font-size: 0.85rem;
            }
            
            .add-product-btn {
                width: 100%;
                align-self: auto;
                padding: 10px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                font-size: 0.85rem;
            }
            
            .table th,
            .table td {
                padding: 10px 8px;
                font-size: 0.8rem;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 0.75rem;
                width: 100%;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .dashboard-card {
                padding: 20px;
            }
            
            .dashboard-card h3 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            
            .settings-card {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .settings-card h3 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            
            /* Modal responsive */
            .modal-content {
                width: 90%;
                max-width: 90%;
                max-height: 90vh;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-body {
                padding: 15px;
                max-height: calc(90vh - 100px);
                overflow-y: auto;
            }
            
            .modal-footer {
                padding: 15px;
                gap: 10px;
            }
            
            .modal-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
                flex: 1;
            }
        }
        
        /* ===== SMALL MOBILE (up to 480px) ===== */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                border-radius: 0;
                min-height: 100vh;
            }
            
            .header {
                padding: 12px 10px;
            }
            
            .header h1 {
                font-size: 1.2rem;
                margin-bottom: 4px;
            }
            
            .header p {
                font-size: 0.75rem;
            }
            
            .reset-btn {
                top: 8px;
                right: 8px;
                padding: 4px 8px;
                font-size: 0.7rem;
            }
            
            .nav-tab {
                padding: 10px 12px;
                font-size: 0.8rem;
            }
            
            .content {
                padding: 10px;
            }
            
            .section-title {
                font-size: 1.1rem;
                margin-bottom: 12px;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 10px;
            }
            
            .product-card {
                padding: 10px;
            }
            
            .product-icon {
                font-size: 1.5rem;
                height: 40px;
            }
            
            .product-name {
                font-size: 0.75rem;
            }
            
            .product-price {
                font-size: 0.85rem;
            }
            
            .product-stock {
                font-size: 0.7rem;
            }
            
            .add-btn {
                font-size: 0.7rem;
                padding: 6px 8px;
            }
            
            .cart-section {
                padding: 15px;
            }
            
            .cart-item {
                padding: 10px;
            }
            
            .qty-btn {
                width: 20px;
                height: 20px;
                font-size: 0.8rem;
            }
            
            .stats-grid {
                gap: 12px;
            }
            
            .stat-card {
                padding: 12px;
                border-left-width: 3px;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
            
            .stat-value {
                font-size: 1.3rem;
            }
            
            .inventory-controls {
                gap: 10px;
                padding: 12px;
            }
            
            .table th,
            .table td {
                padding: 8px 6px;
                font-size: 0.75rem;
            }
            
            .btn {
                padding: 5px 8px;
                font-size: 0.7rem;
            }
            
            .modal-content {
                width: 95%;
                max-width: 95%;
            }
            
            .input-group input,
            .input-group select {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            
            .action-buttons {
                gap: 3px;
            }
        }
        
        /* ===== HORIZONTAL SCROLL FOR TABLES ===== */
        @media (max-width: 768px) {
            .table {
                font-size: 0.8rem;
                min-width: 1100px;
            }
            
            .table th {
                white-space: nowrap;
                padding: 10px 8px;
                min-width: 70px;
                font-size: 0.8rem;
            }
            
            .table th:nth-child(1) {
                min-width: 140px;
            }
            
            .table th:nth-child(2) {
                min-width: 90px;
            }
            
            .table th:nth-child(3),
            .table th:nth-child(4),
            .table th:nth-child(5),
            .table th:nth-child(6) {
                min-width: 100px;
            }
            
            .table th:nth-child(9) {
                min-width: 140px;
            }
            
            .table td {
                padding: 10px 8px;
                white-space: nowrap;
                font-size: 0.8rem;
            }
            
            .action-buttons {
                gap: 5px;
            }
            
            .btn {
                padding: 6px 8px;
                font-size: 0.7rem;
            }
        }
        
        @media (max-width: 480px) {
            .table {
                font-size: 0.75rem;
                min-width: 1000px;
            }
            
            .table th {
                padding: 8px 6px;
                min-width: 60px;
                font-size: 0.75rem;
            }
            
            .table th:nth-child(1) {
                min-width: 120px;
            }
            
            .table th:nth-child(2) {
                min-width: 80px;
            }
            
            .table th:nth-child(3),
            .table th:nth-child(4),
            .table th:nth-child(5),
            .table th:nth-child(6) {
                min-width: 90px;
            }
            
            .table th:nth-child(9) {
                min-width: 130px;
            }
            
            .table td {
                padding: 8px 6px;
                font-size: 0.75rem;
            }
            
            .btn {
                padding: 5px 6px;
                font-size: 0.65rem;
            }
        }
        
        /* ===== STICKY HEADER FOR MOBILE ===== */
        @media (max-width: 768px) {
            .header {
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .nav-tabs {
                position: sticky;
                top: 70px;
                z-index: 99;
            }
        }
        
        /* ===== TOUCH-FRIENDLY BUTTONS ===== */
        @media (max-width: 768px) {
            .btn,
            .checkout-btn,
            .clear-cart-btn,
            .add-product-btn,
            .nav-tab {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            * {
                margin: 0;
                padding: 0;
            }
            
            html, body {
                background: white;
                margin: 0;
                padding: 0;
                width: 100%;
                height: auto;
            }
            
            .container,
            .modal:not(#receiptModal) {
                display: none !important;
            }
            
            #receiptModal {
                position: static !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                display: block !important;
                align-items: auto !important;
                justify-content: auto !important;
                z-index: 10000 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .receipt {
                width: 100%;
                max-width: 400px;
                margin: 0 auto;
                padding: 20px;
                box-shadow: none;
                border-radius: 0;
                page-break-after: avoid;
            }
            
            .receipt-buttons {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè™ Supermarket Management System</h1>
            <p>Point of Sale - Inventory Management - Analytics Dashboard</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="pos" onclick="switchTab('pos')">üõí POS</button>
            <button class="nav-tab" data-tab="inventory" onclick="switchTab('inventory')">üì¶ Inventory</button>
            <button class="nav-tab" data-tab="dashboard" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" data-tab="admin" onclick="switchTab('admin')">üîê Admin</button>
            <button class="nav-tab" data-tab="settings" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <div class="content">
            <!-- POS Section -->
            <div id="pos" class="section active">
                <h2 class="section-title">üí≥ Point of Sale</h2>
                
                <!-- Search and Barcode -->
                <div class="pos-header">
                    <div class="pos-search">
                        <input type="text" id="posSearch" placeholder="üîç Search products by name..." oninput="filterPOSProducts()">
                    </div>
                    <div class="barcode-input">
                        <input type="text" id="barcodeInput" placeholder="üì∑ Scan barcode or enter code" onkeypress="handleBarcodeInput(event)" autocomplete="off">
                        <button class="btn btn-edit" onclick="document.getElementById('barcodeInput').focus()" style="margin-left: 8px; padding: 10px 16px;" title="Focus barcode scanner">üì∑</button>
                    </div>
                </div>

                <div class="pos-container">
                    <div>
                        <div class="products-grid" id="productsGrid"></div>
                    </div>
                    <div class="cart-section">
                        <!-- Customer Information -->
                        <div class="customer-info-card">
                            <h3>üë§ Customer Details</h3>
                            <div class="customer-form">
                                <input type="text" id="customerName" placeholder="Customer Name (Optional)">
                                <input type="tel" id="customerPhone" placeholder="Phone Number">
                            </div>
                        </div>

                        <div class="cart-header">
                            <div class="cart-title">Shopping Cart</div>
                            <div class="cart-count" id="cartCount">0 items</div>
                        </div>
                        <div class="cart-items" id="cartItems"></div>
                        
                        <!-- Discount & Tax Section -->
                        <div class="discount-tax-section">
                            <h4>üè∑Ô∏è Discount & Tax</h4>
                            <div class="discount-tax-controls">
                                <select id="discountType" onchange="calculateBill()">
                                    <option value="none">No Discount</option>
                                    <option value="percentage">Percentage (%)</option>
                                    <option value="fixed">Fixed Amount (‚Çπ)</option>
                                </select>
                                <input type="number" id="discountValue" placeholder="0" min="0" step="0.01" oninput="calculateBill()">
                                <select id="taxType" onchange="calculateBill()">
                                    <option value="0">No Tax</option>
                                    <option value="5">GST 5%</option>
                                    <option value="12">GST 12%</option>
                                    <option value="18">GST 18%</option>
                                    <option value="28">GST 28%</option>
                                </select>
                                <input type="number" id="customTax" placeholder="Custom %" min="0" max="100" step="0.1" oninput="applyCustomTax()">
                            </div>
                            <div class="quick-discount-btns">
                                <button class="quick-discount-btn" onclick="applyQuickDiscount(5)">5% Off</button>
                                <button class="quick-discount-btn" onclick="applyQuickDiscount(10)">10% Off</button>
                                <button class="quick-discount-btn" onclick="applyQuickDiscount(15)">15% Off</button>
                                <button class="quick-discount-btn" onclick="applyQuickDiscount(20)">20% Off</button>
                            </div>
                        </div>

                        <div class="cart-summary">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="subtotal">‚Çπ0.00</span>
                            </div>
                            <div class="summary-row" id="discountRow" style="display: none; color: var(--success);">
                                <span>Discount:</span>
                                <span id="discountAmount">-‚Çπ0.00</span>
                            </div>
                            <div class="summary-row" id="taxRow" style="display: none;">
                                <span>Tax (<span id="taxRate">0</span>%):</span>
                                <span id="taxAmount">‚Çπ0.00</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total Amount:</span>
                                <span id="total">‚Çπ0.00</span>
                            </div>
                            <button class="checkout-btn" id="checkoutBtn" onclick="showPaymentModal()" disabled>
                                üí≥ Complete Purchase
                            </button>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <button class="exchange-refund-btn" onclick="showQuickExchangeRefund('exchange')" style="background: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: var(--transition);">
                                    üîÑ Exchange
                                </button>
                                <button class="exchange-refund-btn" onclick="showQuickExchangeRefund('refund')" style="background: var(--warning); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: var(--transition);">
                                    üí∞ Refund
                                </button>
                            </div>
                            
                            <button class="clear-cart-btn" onclick="clearCart()">
                                üóëÔ∏è Clear Cart
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Section -->
            <div id="inventory" class="section">
                <h2 class="section-title">Manage Inventory</h2>
                
                <!-- Quick Stats -->
                <div class="inventory-quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-label">Total Products</div>
                        <div class="quick-stat-value" id="totalProducts">0</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-label">Total Stock Units</div>
                        <div class="quick-stat-value" id="totalUnits">0</div>
                    </div>
                    <div class="quick-stat" style="border-left-color: var(--warning);">
                        <div class="quick-stat-label">Low Stock Items</div>
                        <div class="quick-stat-value" id="lowStockCount" style="color: var(--warning);">0</div>
                    </div>
                    <div class="quick-stat" style="border-left-color: var(--danger);">
                        <div class="quick-stat-label">Out of Stock</div>
                        <div class="quick-stat-value" id="outOfStockCount" style="color: var(--danger);">0</div>
                    </div>
                    <div class="quick-stat" style="border-left-color: var(--success);">
                        <div class="quick-stat-label">Total Inventory Value</div>
                        <div class="quick-stat-value" id="totalInventoryValue" style="color: var(--success);">‚Çπ0</div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="inventory-header">
                    <div class="inventory-search-bar">
                        <input type="text" id="inventorySearch" placeholder="Search products by name, category..." oninput="filterInventory()">
                        <button class="clear-search" onclick="clearInventorySearch()">‚úï</button>
                    </div>
                    <div class="inventory-filters">
                        <select id="categoryFilter" class="filter-btn" onchange="filterInventory()" style="padding: 8px 16px;">
                            <option value="">All Categories</option>
                        </select>
                        <select id="stockFilter" class="filter-btn" onchange="filterInventory()" style="padding: 8px 16px;">
                            <option value="">All Stock Levels</option>
                            <option value="in-stock">In Stock</option>
                            <option value="low-stock">Low Stock</option>
                            <option value="out-of-stock">Out of Stock</option>
                        </select>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="bulk-actions">
                    <button class="bulk-action-btn" onclick="exportInventoryCSV()">
                        <span>üì•</span> Export CSV
                    </button>
                    <button class="bulk-action-btn" onclick="document.getElementById('importCSV').click()">
                        <span>üì§</span> Import CSV
                    </button>
                    <input type="file" id="importCSV" accept=".csv" style="display: none;" onchange="importInventoryCSV(event)">
                    <button class="bulk-action-btn" onclick="printInventoryReport()">
                        <span>üñ®Ô∏è</span> Print Report
                    </button>
                    <button class="bulk-action-btn" onclick="toggleAddProductForm()">
                        <span>‚ûï</span> Add New Product
                    </button>
                </div>
                
                <!-- Add Product Form (Collapsible) -->
                <div class="inventory-controls" id="addProductForm" style="display: none;">
                    <div class="input-group">
                        <label>Product Name *</label>
                        <input type="text" id="productName" placeholder="Enter product name">
                    </div>
                    <div class="input-group">
                        <label>Product Icon *</label>
                        <input type="text" id="productIcon" placeholder="e.g., üçé">
                    </div>
                    <div class="input-group">
                        <label>Barcode <span style="font-size: 0.85rem; color: var(--gray);">(Auto-generated)</span></label>
                        <input type="text" id="productBarcode" placeholder="Auto-generated" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="input-group">
                        <label>Category *</label>
                        <select id="productCategory"></select>
                    </div>
                    <div class="input-group">
                        <label>MRP (‚Çπ) *</label>
                        <input type="number" id="productMRP" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="input-group">
                        <label>Cost Price (‚Çπ) *</label>
                        <input type="number" id="productCostPrice" placeholder="0.00" step="0.01" min="0" oninput="calculateProfitMargin()">
                    </div>
                    <div class="input-group">
                        <label>Selling Price (‚Çπ) *</label>
                        <input type="number" id="productPrice" placeholder="0.00" step="0.01" min="0" oninput="calculateProfitMargin()">
                    </div>
                    <div class="input-group">
                        <label>Initial Stock *</label>
                        <input type="number" id="productQty" placeholder="0" min="0">
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label>Profit Margin</label>
                        <div id="profitMarginDisplay" style="padding: 12px; background: white; border-radius: 8px; font-weight: 600; color: var(--success);">-</div>
                    </div>
                    <div style="display: flex; gap: 10px; grid-column: 1 / -1;">
                        <button class="add-product-btn" onclick="addProduct()" style="flex: 1;">
                            ‚úÖ Add Product
                        </button>
                        <button class="add-product-btn" onclick="toggleAddProductForm()" style="flex: 1; background: var(--light-gray); color: var(--gray);">
                            ‚úï Cancel
                        </button>
                    </div>
                </div>

                <!-- Inventory Table -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortInventory('name')">Product</th>
                                <th class="sortable" onclick="sortInventory('category')">Category</th>
                                <th>Barcode</th>
                                <th class="sortable" onclick="sortInventory('mrp')">MRP</th>
                                <th class="sortable" onclick="sortInventory('costPrice')">Cost Price</th>
                                <th class="sortable" onclick="sortInventory('price')">Selling Price</th>
                                <th class="sortable" onclick="sortInventory('profit')">Profit</th>
                                <th class="sortable" onclick="sortInventory('qty')">Stock</th>
                                <th class="sortable" onclick="sortInventory('status')">Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <h2 class="section-title">Sales Dashboard & Analytics</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-label">Total Sales Revenue</div>
                        <div class="stat-value" id="totalSales">‚Çπ0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-label">Total Transactions</div>
                        <div class="stat-value" id="totalTransactions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-label">Total Stock Value</div>
                        <div class="stat-value" id="stockValue">‚Çπ0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-label">Items in Stock</div>
                        <div class="stat-value" id="totalStock">0</div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>‚ö†Ô∏è Low Stock Alert</h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Current Stock</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="lowStockList"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <h3>üì¶ Stock by Category</h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody id="stockByCategory"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>üìä Sales by Product</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Units Sold</th>
                                    <th>Revenue</th>
                                    <th>Current Stock</th>
                                </tr>
                            </thead>
                            <tbody id="salesByProduct"></tbody>
                        </table>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>üìú Recent Transactions</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Amount</th>
                                    <th>Payment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Panel Section -->
            <div id="admin" class="section">
                <!-- Login Screen -->
                <div id="adminLogin" class="admin-login">
                    <div class="admin-login-card">
                        <h2>üîê Admin Access</h2>
                        <p>Enter your 4-digit PIN to access admin panel</p>
                        <div class="pin-input-container">
                            <input type="password" class="pin-input" maxlength="1" id="pin1" oninput="movePinFocus(1)" onkeydown="handlePinBackspace(event, 1)">
                            <input type="password" class="pin-input" maxlength="1" id="pin2" oninput="movePinFocus(2)" onkeydown="handlePinBackspace(event, 2)">
                            <input type="password" class="pin-input" maxlength="1" id="pin3" oninput="movePinFocus(3)" onkeydown="handlePinBackspace(event, 3)">
                            <input type="password" class="pin-input" maxlength="1" id="pin4" oninput="movePinFocus(4)" onkeydown="handlePinBackspace(event, 4)">
                        </div>
                        <button class="add-product-btn" onclick="verifyAdminPin()" style="width: 100%;">
                            üîì Unlock Admin Panel
                        </button>
                        <p style="margin-top: 20px; font-size: 0.85rem; color: var(--gray);">
                            Default PIN: 1234<br>
                            Change it after first login
                        </p>
                    </div>
                </div>

                <!-- Admin Content -->
                <div id="adminContent" class="admin-content">
                    <div class="admin-header">
                        <div>
                            <h2>üë®‚Äçüíº Admin Dashboard</h2>
                            <p style="margin: 0; opacity: 0.9;">Full system control and management</p>
                        </div>
                        <button class="admin-logout-btn" onclick="logoutAdmin()">
                            üö™ Logout
                        </button>
                    </div>

                    <!-- Quick Actions -->
                    <div class="admin-card">
                        <h3>‚ö° Quick Actions</h3>
                        <div class="admin-action-grid">
                            <button class="admin-action-btn" onclick="showBulkStockUpdate()">
                                <span class="icon">üì¶</span>
                                Bulk Stock Update
                            </button>
                            <button class="admin-action-btn" onclick="openChangePinModal()">
                                <span class="icon">üîë</span>
                                Change PIN
                            </button>
                            <button class="admin-action-btn" onclick="exportAllData()">
                                <span class="icon">üíæ</span>
                                Export All Data
                            </button>
                            <button class="admin-action-btn" onclick="viewSystemLogs()">
                                <span class="icon">üìã</span>
                                System Logs
                            </button>
                        </div>
                    </div>

                    <!-- Quick Stock Management -->
                    <div class="admin-grid">
                        <div class="admin-card">
                            <h3>üìä Quick Stock Adjustments</h3>
                            <div id="quickStockList" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>

                        <div class="admin-card">
                            <h3>‚ö†Ô∏è Stock Alerts</h3>
                            <div id="adminStockAlerts"></div>
                        </div>
                    </div>

                    <!-- Advanced Stock Management -->
                    <div class="admin-card">
                        <h3>üîß Advanced Stock Management</h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Current Stock</th>
                                        <th>Add Stock</th>
                                        <th>Remove Stock</th>
                                        <th>Set Stock</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminStockTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- System Statistics -->
                    <div class="admin-card">
                        <h3>üìà System Statistics</h3>
                        <div class="inventory-quick-stats">
                            <div class="quick-stat">
                                <div class="quick-stat-label">Total Revenue</div>
                                <div class="quick-stat-value" id="adminTotalRevenue">‚Çπ0</div>
                            </div>
                            <div class="quick-stat" style="border-left-color: var(--success);">
                                <div class="quick-stat-label">Total Profit</div>
                                <div class="quick-stat-value" id="adminTotalProfit" style="color: var(--success);">‚Çπ0</div>
                            </div>
                            <div class="quick-stat" style="border-left-color: var(--warning);">
                                <div class="quick-stat-label">Products Sold</div>
                                <div class="quick-stat-value" id="adminProductsSold">0</div>
                            </div>
                            <div class="quick-stat" style="border-left-color: var(--danger);">
                                <div class="quick-stat-label">Avg Order Value</div>
                                <div class="quick-stat-value" id="adminAvgOrder">‚Çπ0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section">
                <div class="settings-card">
                    <h3>Manage Categories</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="input-group">
                            <label>Category Name</label>
                            <input type="text" id="newCategoryName" placeholder="e.g., Snacks">
                        </div>
                        <div class="input-group">
                            <label>Category Icon/Emoji</label>
                            <input type="text" id="newCategoryIcon" placeholder="e.g., üçø" maxlength="2">
                        </div>
                    </div>
                    <button class="add-product-btn" onclick="addCategory()" style="width: 100%; margin-bottom: 20px;">
                        ‚ûï Add New Category
                    </button>
                    
                    <div class="categories-list" id="categoriesList"></div>
                </div>

                <div class="settings-card">
                    <h3>Shop Details</h3>
                    <div style="display: grid; gap: 20px;">
                        <div class="input-group">
                            <label>Shop Name</label>
                            <input type="text" id="shopName" placeholder="Enter your shop name">
                        </div>
                        <div class="input-group">
                            <label>Shop Address</label>
                            <textarea id="shopAddress" placeholder="Enter your shop address" rows="3"></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="input-group">
                                <label>Phone Number</label>
                                <input type="tel" id="shopPhone" placeholder="Enter your phone number">
                            </div>
                            <div class="input-group">
                                <label>Email Address</label>
                                <input type="email" id="shopEmail" placeholder="Enter your email address">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>GST Number (Optional)</label>
                            <input type="text" id="shopGST" placeholder="Enter your GST number">
                        </div>
                        <div class="input-group">
                            <label>Receipt Footer Message</label>
                            <textarea id="shopFooter" placeholder="Thank you for shopping with us!" rows="2"></textarea>
                        </div>
                    </div>
                    <button class="add-product-btn" onclick="saveShopSettings()" style="width: 100%; margin-top: 20px;">
                        üíæ Save Shop Settings
                    </button>
                </div>

                <div class="alert-card alert-info">
                    <h3 style="margin-bottom: 10px;">‚ÑπÔ∏è Information</h3>
                    <p>
                        The shop details you enter here will appear on all printed bills and receipts. 
                        This helps your customers identify your business and includes important contact information.
                    </p>
                </div>

                <div class="alert-card alert-danger">
                    <h3 style="margin-bottom: 10px;">‚ö†Ô∏è Danger Zone</h3>
                    <p style="margin-bottom: 15px;">
                        This will permanently delete all data including products, transactions, and settings.
                        This action cannot be undone.
                    </p>
                    <button class="btn btn-delete" onclick="clearAllData()" style="width: 100%; padding: 12px;">
                        üóëÔ∏è Clear All Data & Start Fresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="receipt" id="receipt"></div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Edit Product</span>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label>Product Name</label>
                    <input type="text" id="editProductName">
                </div>
                <div class="input-group">
                    <label>MRP (‚Çπ)</label>
                    <input type="number" id="editProductMRP" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Cost Price (‚Çπ)</label>
                    <input type="number" id="editProductCostPrice" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Selling Price (‚Çπ)</label>
                    <input type="number" id="editProductPrice" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Stock Quantity</label>
                    <input type="number" id="editProductQty" min="0">
                </div>
                <div class="input-group">
                    <label>Category</label>
                    <select id="editProductCategory"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveProduct()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Payment Method Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <span>Select Payment Method</span>
                <button class="modal-close" onclick="closePaymentModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="payment-methods">
                    <button class="payment-method-btn" onclick="completeCheckout('Cash')">
                        <span class="payment-method-icon">üíµ</span>
                        <span>Cash</span>
                    </button>
                    <button class="payment-method-btn" onclick="completeCheckout('Card')">
                        <span class="payment-method-icon">üí≥</span>
                        <span>Debit/Credit Card</span>
                    </button>
                    <button class="payment-method-btn" onclick="completeCheckout('UPI')">
                        <span class="payment-method-icon">üì±</span>
                        <span>UPI/Digital Wallet</span>
                    </button>
                    <button class="payment-method-btn" onclick="completeCheckout('Cheque')">
                        <span class="payment-method-icon">üìÑ</span>
                        <span>Cheque</span>
                    </button>
                    <button class="payment-method-btn" onclick="completeCheckout('Bank Transfer')">
                        <span class="payment-method-icon">üè¶</span>
                        <span>Bank Transfer</span>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closePaymentModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <span>Confirm Reset</span>
                <button class="modal-close" onclick="closeConfirmModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 10px;">‚ö†Ô∏è Are you sure you want to reset the system?</p>
                <p style="font-size: 0.9rem; color: var(--gray);">
                    This will clear all data and reload the page. Any unsaved changes will be lost.
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="forceResetSystem()">Reset System</button>
            </div>
        </div>
    </div>

    <!-- Change PIN Modal -->
    <div id="changePinModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <span>üîë Change Admin PIN</span>
                <button class="modal-close" onclick="closeChangePinModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="pin-change-form">
                    <div class="input-group">
                        <label>Current PIN</label>
                        <input type="password" id="currentPin" maxlength="4" placeholder="Enter current PIN">
                    </div>
                    <div class="input-group">
                        <label>New PIN</label>
                        <input type="password" id="newPin" maxlength="4" placeholder="Enter new 4-digit PIN">
                    </div>
                    <div class="input-group">
                        <label>Confirm New PIN</label>
                        <input type="password" id="confirmNewPin" maxlength="4" placeholder="Re-enter new PIN">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeChangePinModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveNewPin()">Change PIN</button>
            </div>
        </div>
    </div>

    <!-- Exchange/Refund Modal -->
    <div id="exchangeRefundModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <span id="exchangeRefundTitle">üîÑ Exchange / Refund</span>
                <button class="modal-close" onclick="closeExchangeRefundModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="exchangeRefundContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer" id="exchangeRefundFooter">
                <!-- Footer buttons will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Quick Exchange/Refund Selection Modal -->
    <div id="quickExchangeRefundModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <span id="quickExchangeRefundTitle">üîÑ Select Transaction</span>
                <button class="modal-close" onclick="closeQuickExchangeRefundModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div style="background: #e7f3ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; color: #0066cc;">
                    üí° <strong>Tip:</strong> Select a recent transaction to process exchange or refund
                </div>
                <div id="quickTransactionsList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Transactions will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeQuickExchangeRefundModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Barcode Modal -->
    <div id="barcodeModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <span>üìä Product Barcode</span>
                <button class="modal-close" onclick="closeBarcodeModal()">√ó</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div id="barcodeProductInfo" style="margin-bottom: 20px;">
                    <!-- Product info will be populated -->
                </div>
                <div style="background: white; padding: 20px; border-radius: 8px; display: inline-block;">
                    <svg id="barcodeDisplay"></svg>
                </div>
                <div id="barcodeValue" style="margin-top: 15px; font-weight: 600; font-size: 1.1rem; color: var(--primary);">
                    <!-- Barcode value will be shown -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeBarcodeModal()">Close</button>
                <button class="modal-btn modal-btn-confirm" onclick="printBarcode()">üñ®Ô∏è Print Barcode</button>
            </div>
        </div>
    </div>

    <script>
        // ===== DATA MANAGEMENT =====
        const STORAGE_KEYS = {
            PRODUCTS: 'supermarket_products',
            TRANSACTIONS: 'supermarket_transactions',
            CATEGORIES: 'supermarket_categories',
            SHOP_DETAILS: 'supermarket_shop_details',
            ADMIN_PIN: 'supermarket_admin_pin'
        };

        let products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS)) || [];
        let cart = [];
        let transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS)) || [];
        let editingProductId = null;
        let selectedPaymentMethod = null;
        let nextProductId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
        let adminAuthenticated = false;
        let adminPin = localStorage.getItem(STORAGE_KEYS.ADMIN_PIN) || '1234';
        let userRole = 'cashier'; // 'cashier' or 'admin'

        let categories = JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES)) || [
            { name: 'Vegetables', icon: 'ü•¨' },
            { name: 'Fruits', icon: 'üçé' },
            { name: 'Dairy', icon: 'ü•õ' },
            { name: 'Meat', icon: 'üçñ' },
            { name: 'Bakery', icon: 'üçû' },
            { name: 'Beverages', icon: 'ü•§' },
            { name: 'Snacks', icon: 'üçø' },
            { name: 'Cleaning', icon: 'üßπ' }
        ];

        let shopDetails = JSON.parse(localStorage.getItem(STORAGE_KEYS.SHOP_DETAILS)) || {
            shopName: 'Supermarket Store',
            shopAddress: '123 Market Street, City Center',
            shopPhone: '+91 9876543210',
            shopEmail: 'shop@example.com',
            shopGST: '',
            shopFooter: 'Thank you for your purchase! Visit us again.'
        };

        // ===== UTILITY FUNCTIONS =====
        function saveData() {
            localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
            localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));
            localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(categories));
            localStorage.setItem(STORAGE_KEYS.SHOP_DETAILS, JSON.stringify(shopDetails));
        }

        function formatCurrency(amount) {
            return '‚Çπ' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function formatDate(date) {
            return new Date(date).toLocaleString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        // ===== BARCODE MANAGEMENT =====
        function generateBarcode(productId) {
            // Generate EAN-13 style barcode (13 digits)
            // Format: 890 (country code) + 9-digit code + check digit
            const countryCode = '890';
            const paddedId = String(productId).padStart(9, '0');
            const baseCode = countryCode + paddedId;
            
            // Calculate EAN-13 check digit (proper algorithm)
            let sum = 0;
            for (let i = 0; i < 12; i++) {
                const digit = parseInt(baseCode[i]);
                sum += (i % 2 === 0) ? digit : digit * 3;
            }
            const checkDigit = (10 - (sum % 10)) % 10;
            
            return baseCode + checkDigit;
        }

        function handleBarcodeInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const barcode = document.getElementById('barcodeInput').value.trim();
                
                if (!barcode) {
                    return;
                }

                // Ensure all products have barcodes
                let needsUpdate = false;
                products.forEach(p => {
                    if (!p.barcode || p.barcode.length !== 13 || !/^\d+$/.test(p.barcode)) {
                        p.barcode = generateBarcode(p.id);
                        needsUpdate = true;
                    }
                });
                if (needsUpdate) {
                    localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
                }

                // Find product by barcode or ID
                const product = products.find(p => 
                    p.barcode === barcode || 
                    String(p.id) === barcode
                );

                if (product) {
                    if (product.qty > 0) {
                        addToCart(product.id);
                        document.getElementById('barcodeInput').value = '';
                        
                        // Visual feedback
                        const input = document.getElementById('barcodeInput');
                        input.style.background = '#d4edda';
                        setTimeout(() => {
                            input.style.background = '';
                        }, 300);
                    } else {
                        alert(`‚ùå ${product.name} is out of stock!`);
                        document.getElementById('barcodeInput').value = '';
                    }
                } else {
                    alert(`‚ùå Product not found with barcode: ${barcode}`);
                    document.getElementById('barcodeInput').value = '';
                }
            }
        }

        function showBarcode(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Check if JsBarcode is available
            if (typeof JsBarcode === 'undefined') {
                alert('‚ùå Barcode library not loaded. Please refresh the page.');
                return;
            }

            // Validate and regenerate barcode if needed (silently)
            if (!product.barcode || product.barcode.length !== 13 || !/^\d+$/.test(product.barcode)) {
                console.log('Regenerating barcode for product:', productId);
                product.barcode = generateBarcode(productId);
                localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
            }

            // Populate product info
            document.getElementById('barcodeProductInfo').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                    <span style="font-size: 2rem;">${product.icon || 'üì¶'}</span>
                    <div style="text-align: left;">
                        <div style="font-weight: 600; font-size: 1.2rem;">${product.name}</div>
                        <div style="color: var(--gray); font-size: 0.9rem;">${product.category}</div>
                        <div style="color: var(--primary); font-weight: 600; margin-top: 5px;">${formatCurrency(product.price)}</div>
                    </div>
                </div>
            `;

            // Clear previous barcode
            const barcodeElement = document.getElementById('barcodeDisplay');
            barcodeElement.innerHTML = '';

            // Generate barcode using JsBarcode
            try {
                JsBarcode(barcodeElement, product.barcode, {
                    format: "EAN13",
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontSize: 16,
                    margin: 10,
                    valid: function(valid) {
                        if (!valid) {
                            throw new Error('Invalid EAN13 barcode');
                        }
                    }
                });
                
                document.getElementById('barcodeValue').innerHTML = `Barcode: <strong>${product.barcode}</strong>`;
                document.getElementById('barcodeModal').classList.add('active');
            } catch (error) {
                console.error('Barcode generation error:', error, 'Barcode:', product.barcode);
                alert(`‚ùå Error: ${error.message}. Please contact support.`);
            }
        }

        function closeBarcodeModal() {
            document.getElementById('barcodeModal').classList.remove('active');
        }

        function printBarcode() {
            const productId = parseInt(document.getElementById('barcodeValue').textContent.match(/\d+/g).join(''));
            const product = products.find(p => p.barcode && document.getElementById('barcodeValue').textContent.includes(p.barcode));
            if (!product) return;

            const printWindow = window.open('', '', 'width=400,height=300');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Print Barcode - ${product.name}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            padding: 20px;
                        }
                        .product-info {
                            text-align: center;
                            margin-bottom: 20px;
                        }
                        .product-name {
                            font-size: 18px;
                            font-weight: bold;
                            margin-bottom: 5px;
                        }
                        .product-price {
                            font-size: 16px;
                            color: #667eea;
                            font-weight: 600;
                        }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
                </head>
                <body>
                    <div class="product-info">
                        <div class="product-name">${product.icon || 'üì¶'} ${product.name}</div>
                        <div class="product-price">${formatCurrency(product.price)}</div>
                    </div>
                    <svg id="printBarcode"></svg>
                    <script>
                        JsBarcode("#printBarcode", "${product.barcode}", {
                            format: "EAN13",
                            width: 2,
                            height: 80,
                            displayValue: true,
                            fontSize: 14,
                            margin: 5
                        });
                        window.onload = function() {
                            setTimeout(function() {
                                window.print();
                                window.close();
                            }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // ===== TAB MANAGEMENT =====
        function switchTab(tabName) {
            // Prevent cashier access to inventory
            if (tabName === 'inventory' && userRole === 'cashier') {
                alert('üîí Access Denied: Only administrators can access inventory.');
                return;
            }
            
            // Update tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Update sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.toggle('active', section.id === tabName);
            });

            // Load data for the tab
            switch(tabName) {
                case 'pos':
                    renderProducts();
                    break;
                case 'inventory':
                    renderInventory();
                    break;
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'admin':
                    if (adminAuthenticated) {
                        renderAdminPanel();
                    } else {
                        resetPinInputs();
                    }
                    break;
                case 'settings':
                    loadShopSettings();
                    break;
            }
        }

        // ===== ADMIN PANEL FUNCTIONS =====
        function movePinFocus(currentIndex) {
            const currentInput = document.getElementById(`pin${currentIndex}`);
            if (currentInput.value.length === 1 && currentIndex < 4) {
                document.getElementById(`pin${currentIndex + 1}`).focus();
            }
            if (currentIndex === 4 && currentInput.value.length === 1) {
                verifyAdminPin();
            }
        }

        function handlePinBackspace(event, currentIndex) {
            if (event.key === 'Backspace') {
                const currentInput = document.getElementById(`pin${currentIndex}`);
                if (currentInput.value.length === 0 && currentIndex > 1) {
                    document.getElementById(`pin${currentIndex - 1}`).focus();
                }
            }
        }

        function resetPinInputs() {
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(`pin${i}`);
                if (input) input.value = '';
            }
            const firstInput = document.getElementById('pin1');
            if (firstInput) firstInput.focus();
        }

        function verifyAdminPin() {
            const enteredPin = 
                document.getElementById('pin1').value +
                document.getElementById('pin2').value +
                document.getElementById('pin3').value +
                document.getElementById('pin4').value;

            if (enteredPin.length !== 4) {
                alert('‚ö†Ô∏è Please enter a 4-digit PIN');
                resetPinInputs();
                return;
            }

            if (enteredPin === adminPin) {
                adminAuthenticated = true;
                userRole = 'admin';
                updateNavigationVisibility();
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminContent').classList.add('authenticated');
                renderAdminPanel();
                alert('‚úÖ Access granted! Welcome to Admin Panel');
            } else {
                alert('‚ùå Incorrect PIN. Please try again.');
                resetPinInputs();
            }
        }

        function logoutAdmin() {
            if (confirm('üö™ Are you sure you want to logout from admin panel?')) {
                adminAuthenticated = false;
                userRole = 'cashier';
                updateNavigationVisibility();
                document.getElementById('adminLogin').style.display = 'block';
                document.getElementById('adminContent').classList.remove('authenticated');
                resetPinInputs();
                switchTab('pos');
            }
        }

        function updateNavigationVisibility() {
            const inventoryTab = document.querySelector('[data-tab="inventory"]');
            if (inventoryTab) {
                if (userRole === 'admin') {
                    inventoryTab.style.display = 'flex';
                } else {
                    inventoryTab.style.display = 'none';
                }
            }
        }

        function renderAdminPanel() {
            renderQuickStockList();
            renderAdminStockAlerts();
            renderAdminStockTable();
            renderAdminStatistics();
        }

        function renderQuickStockList() {
            const list = document.getElementById('quickStockList');
            const lowStockProducts = products.filter(p => p.qty <= 20).slice(0, 10);

            if (lowStockProducts.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">All products have sufficient stock</p>';
                return;
            }

            list.innerHTML = lowStockProducts.map(p => `
                <div class="quick-stock-item">
                    <div class="quick-stock-info">
                        <div class="quick-stock-name">${p.icon || 'üì¶'} ${p.name}</div>
                        <div class="quick-stock-current">Current: ${p.qty} units</div>
                    </div>
                    <div class="quick-stock-controls">
                        <input type="number" class="quick-stock-input" id="quickQty${p.id}" placeholder="Qty" min="1" value="10">
                        <button class="quick-stock-btn add" onclick="quickAdjustStock(${p.id}, 'add')">+</button>
                        <button class="quick-stock-btn remove" onclick="quickAdjustStock(${p.id}, 'remove')">‚àí</button>
                    </div>
                </div>
            `).join('');
        }

        function renderAdminStockAlerts() {
            const alerts = document.getElementById('adminStockAlerts');
            const outOfStock = products.filter(p => p.qty === 0);
            const lowStock = products.filter(p => p.qty > 0 && p.qty <= 10);

            let html = '';
            
            if (outOfStock.length > 0) {
                html += `<div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--danger);">
                    <strong style="color: var(--danger);">üö® ${outOfStock.length} Product(s) Out of Stock</strong><br>
                    <small>${outOfStock.map(p => p.name).join(', ')}</small>
                </div>`;
            }

            if (lowStock.length > 0) {
                html += `<div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning);">
                    <strong style="color: var(--warning);">‚ö†Ô∏è ${lowStock.length} Product(s) Low Stock</strong><br>
                    <small>${lowStock.map(p => `${p.name} (${p.qty})`).join(', ')}</small>
                </div>`;
            }

            if (html === '') {
                html = '<p style="text-align: center; color: var(--success); padding: 20px;">‚úÖ All products have healthy stock levels</p>';
            }

            alerts.innerHTML = html;
        }

        function renderAdminStockTable() {
            const table = document.getElementById('adminStockTable');
            
            if (products.length === 0) {
                table.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No products available</td></tr>';
                return;
            }

            table.innerHTML = products.map(p => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.2rem;">${p.icon || 'üì¶'}</span>
                            <strong>${p.name}</strong>
                        </div>
                    </td>
                    <td style="font-weight: 600; font-size: 1.1rem; ${p.qty === 0 ? 'color: var(--danger);' : p.qty <= 10 ? 'color: var(--warning);' : ''}">${p.qty}</td>
                    <td>
                        <input type="number" id="addStock${p.id}" style="width: 80px; padding: 8px; border: 2px solid var(--light-gray); border-radius: 6px;" min="1" placeholder="0">
                    </td>
                    <td>
                        <input type="number" id="removeStock${p.id}" style="width: 80px; padding: 8px; border: 2px solid var(--light-gray); border-radius: 6px;" min="1" placeholder="0">
                    </td>
                    <td>
                        <input type="number" id="setStock${p.id}" style="width: 80px; padding: 8px; border: 2px solid var(--light-gray); border-radius: 6px;" min="0" placeholder="${p.qty}">
                    </td>
                    <td>
                        <div class="action-buttons" style="gap: 8px;">
                            <button class="btn btn-edit" onclick="applyStockChanges(${p.id})" style="padding: 8px 16px;">
                                ‚úÖ Apply
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderAdminStatistics() {
            const totalRevenue = transactions.reduce((sum, t) => sum + t.total, 0);
            const totalProfit = transactions.reduce((sum, t) => {
                return sum + t.items.reduce((itemSum, item) => {
                    const product = products.find(p => p.id === item.id);
                    const costPrice = product ? product.costPrice || 0 : 0;
                    return itemSum + ((item.price - costPrice) * item.qty);
                }, 0);
            }, 0);
            const productsSold = transactions.reduce((sum, t) => sum + t.items.reduce((s, i) => s + i.qty, 0), 0);
            const avgOrder = transactions.length > 0 ? totalRevenue / transactions.length : 0;

            document.getElementById('adminTotalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('adminTotalProfit').textContent = formatCurrency(totalProfit);
            document.getElementById('adminProductsSold').textContent = productsSold.toLocaleString();
            document.getElementById('adminAvgOrder').textContent = formatCurrency(avgOrder);
        }

        function quickAdjustStock(productId, action) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const qtyInput = document.getElementById(`quickQty${productId}`);
            const qty = parseInt(qtyInput.value) || 0;

            if (qty <= 0) {
                alert('‚ö†Ô∏è Please enter a valid quantity');
                return;
            }

            if (action === 'add') {
                product.qty += qty;
                alert(`‚úÖ Added ${qty} units to ${product.name}\nNew stock: ${product.qty}`);
            } else if (action === 'remove') {
                if (product.qty >= qty) {
                    product.qty -= qty;
                    alert(`‚úÖ Removed ${qty} units from ${product.name}\nNew stock: ${product.qty}`);
                } else {
                    alert(`‚ö†Ô∏è Cannot remove ${qty} units. Only ${product.qty} available.`);
                    return;
                }
            }

            saveData();
            renderAdminPanel();
            renderProducts();
            renderInventory();
        }

        function applyStockChanges(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const addQty = parseInt(document.getElementById(`addStock${productId}`).value) || 0;
            const removeQty = parseInt(document.getElementById(`removeStock${productId}`).value) || 0;
            const setQty = document.getElementById(`setStock${productId}`).value;

            if (setQty !== '' && setQty !== null) {
                const newQty = parseInt(setQty);
                if (newQty >= 0) {
                    product.qty = newQty;
                    alert(`‚úÖ Stock set to ${newQty} for ${product.name}`);
                }
            } else if (addQty > 0) {
                product.qty += addQty;
                alert(`‚úÖ Added ${addQty} units to ${product.name}\nNew stock: ${product.qty}`);
            } else if (removeQty > 0) {
                if (product.qty >= removeQty) {
                    product.qty -= removeQty;
                    alert(`‚úÖ Removed ${removeQty} units from ${product.name}\nNew stock: ${product.qty}`);
                } else {
                    alert(`‚ö†Ô∏è Cannot remove ${removeQty} units. Only ${product.qty} available.`);
                    return;
                }
            } else {
                alert('‚ö†Ô∏è Please enter a value in one of the fields');
                return;
            }

            saveData();
            renderAdminPanel();
            renderProducts();
            renderInventory();
        }

        function openChangePinModal() {
            document.getElementById('changePinModal').classList.add('active');
            document.getElementById('currentPin').value = '';
            document.getElementById('newPin').value = '';
            document.getElementById('confirmNewPin').value = '';
        }

        function closeChangePinModal() {
            document.getElementById('changePinModal').classList.remove('active');
        }

        function saveNewPin() {
            const currentPinInput = document.getElementById('currentPin').value;
            const newPinInput = document.getElementById('newPin').value;
            const confirmPinInput = document.getElementById('confirmNewPin').value;

            if (currentPinInput !== adminPin) {
                alert('‚ùå Current PIN is incorrect!');
                return;
            }

            if (newPinInput.length !== 4 || !/^\d{4}$/.test(newPinInput)) {
                alert('‚ö†Ô∏è New PIN must be exactly 4 digits!');
                return;
            }

            if (newPinInput !== confirmPinInput) {
                alert('‚ö†Ô∏è New PIN and confirmation do not match!');
                return;
            }

            adminPin = newPinInput;
            localStorage.setItem(STORAGE_KEYS.ADMIN_PIN, adminPin);
            closeChangePinModal();
            alert('‚úÖ Admin PIN changed successfully!\nPlease remember your new PIN.');
        }

        function showBulkStockUpdate() {
            alert('üì¶ Bulk Stock Update\n\nUse the Import CSV feature in the Inventory section to bulk update product stock.\n\nOr use the Advanced Stock Management table below to update multiple products individually.');
        }

        function exportAllData() {
            const data = {
                products: products,
                transactions: transactions,
                categories: categories,
                shopDetails: shopDetails,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `supermarket_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ All data exported successfully!');
        }

        // ===== EXCHANGE & REFUND MANAGEMENT =====
        function openExchangeRefundModal(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) {
                alert('‚ùå Transaction not found!');
                return;
            }

            // Check if transaction is within 5 days
            const transactionDate = new Date(transaction.date);
            const currentDate = new Date();
            const daysDifference = Math.floor((currentDate - transactionDate) / (1000 * 60 * 60 * 24));

            if (daysDifference > 5) {
                alert(`‚ùå Exchange/Refund validity expired!\n\nThis transaction is ${daysDifference} days old.\nExchange/Refund is only valid for 5 days from purchase date.`);
                return;
            }

            if (transaction.isExchanged) {
                alert('‚ö†Ô∏è This transaction has already been exchanged!');
                return;
            }

            if (transaction.isRefunded) {
                alert('‚ö†Ô∏è This transaction has already been refunded!');
                return;
            }

            const daysRemaining = 5 - daysDifference;
            const content = document.getElementById('exchangeRefundContent');
            const footer = document.getElementById('exchangeRefundFooter');

            content.innerHTML = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">‚è∞ Validity: ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} remaining</div>
                    <div style="font-size: 0.9rem; color: var(--gray);">Valid until ${new Date(transactionDate.getTime() + 5 * 24 * 60 * 60 * 1000).toLocaleDateString()}</div>
                </div>

                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: 600;">Transaction #${transaction.id.toString().slice(-8)}</div>
                            <div style="font-size: 0.9rem; color: var(--gray);">${formatDate(transaction.date)}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: var(--primary); font-size: 1.2rem;">${formatCurrency(transaction.total)}</div>
                            <div style="font-size: 0.9rem; color: var(--gray);">${transaction.paymentMethod}</div>
                        </div>
                    </div>
                    
                    <div style="font-weight: 600; margin-top: 15px; margin-bottom: 10px;">Items:</div>
                    ${transaction.items.map(item => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--light-gray);">
                            <div>${item.name} √ó ${item.qty}</div>
                            <div style="font-weight: 600;">${formatCurrency(item.price * item.qty)}</div>
                        </div>
                    `).join('')}
                    
                    ${transaction.discount > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; color: var(--success);">
                            <div>Discount</div>
                            <div>-${formatCurrency(transaction.discount)}</div>
                        </div>
                    ` : ''}
                    ${transaction.tax > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <div>Tax (${transaction.taxPercent}%)</div>
                            <div>${formatCurrency(transaction.tax)}</div>
                        </div>
                    ` : ''}
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 0.9rem; color: var(--gray); line-height: 1.6;">
                        <strong>üìã Exchange/Refund Policy:</strong><br>
                        ‚Ä¢ Items will be returned to inventory<br>
                        ‚Ä¢ Exchange: Select new products of equal or greater value<br>
                        ‚Ä¢ Refund: Amount will be credited via ${transaction.paymentMethod}<br>
                        ‚Ä¢ Valid for 5 days from purchase date
                    </div>
                </div>
            `;

            footer.innerHTML = `
                <button class="modal-btn modal-btn-cancel" onclick="closeExchangeRefundModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="processExchange(${transactionId})" style="background: var(--primary);">
                    üîÑ Exchange
                </button>
                <button class="modal-btn modal-btn-confirm" onclick="processRefund(${transactionId})" style="background: var(--danger);">
                    üí∞ Refund
                </button>
            `;

            document.getElementById('exchangeRefundModal').classList.add('active');
        }

        function closeExchangeRefundModal() {
            document.getElementById('exchangeRefundModal').classList.remove('active');
        }

        function processExchange(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            if (!confirm('üîÑ Process Exchange?\n\nItems will be returned to inventory and you can select new products.')) {
                return;
            }

            // Return items to inventory
            transaction.items.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (product) {
                    product.qty += item.qty;
                }
            });

            // Mark transaction as exchanged
            transaction.isExchanged = true;
            transaction.exchangedDate = new Date().toISOString();
            
            // Save updates
            localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
            localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));

            // Clear cart and prepare for new selection
            cart = [];
            updateCart();
            
            closeExchangeRefundModal();
            switchTab('pos');
            
            alert(`‚úÖ Exchange Processed!\n\nItems returned to inventory: ${transaction.items.map(i => i.name).join(', ')}\n\nTotal value: ${formatCurrency(transaction.total)}\n\nPlease select new items for the customer.`);
            
            renderDashboard();
            renderInventory();
        }

        function processRefund(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            if (!confirm(`üí∞ Process Refund?\n\nAmount: ${formatCurrency(transaction.total)}\nMethod: ${transaction.paymentMethod}\n\nItems will be returned to inventory.`)) {
                return;
            }

            // Return items to inventory
            transaction.items.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (product) {
                    product.qty += item.qty;
                }
            });

            // Mark transaction as refunded
            transaction.isRefunded = true;
            transaction.refundedDate = new Date().toISOString();
            
            // Save updates
            localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
            localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));

            closeExchangeRefundModal();
            
            alert(`‚úÖ Refund Processed!\n\nAmount refunded: ${formatCurrency(transaction.total)}\nPayment method: ${transaction.paymentMethod}\n\nItems returned to inventory: ${transaction.items.map(i => i.name).join(', ')}`);
            
            renderDashboard();
            renderInventory();
        }

        function showQuickExchangeRefund(type) {
            const title = type === 'exchange' ? 'üîÑ Select Transaction for Exchange' : 'üí∞ Select Transaction for Refund';
            document.getElementById('quickExchangeRefundTitle').textContent = title;
            
            // Get recent transactions (last 30 days, not already exchanged/refunded)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const recentTransactions = transactions
                .filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate >= thirtyDaysAgo && !t.isExchanged && !t.isRefunded;
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 20); // Show last 20 transactions
            
            const listContainer = document.getElementById('quickTransactionsList');
            
            if (recentTransactions.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray);">
                        <div style="font-size: 3rem; margin-bottom: 10px;">üì≠</div>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px;">No Recent Transactions</div>
                        <div style="font-size: 0.9rem;">No eligible transactions found for ${type}</div>
                    </div>
                `;
            } else {
                listContainer.innerHTML = recentTransactions.map(t => {
                    const transactionDate = new Date(t.date);
                    const daysSince = Math.floor((new Date() - transactionDate) / (1000 * 60 * 60 * 24));
                    const isExpired = daysSince > 5;
                    const daysRemaining = 5 - daysSince;
                    
                    const borderColor = isExpired ? '#ff6b6b' : 'var(--light-gray)';
                    const cursorStyle = isExpired ? 'not-allowed' : 'pointer';
                    const opacity = isExpired ? '0.6' : '1';
                    const onclickAttr = isExpired ? '' : 'onclick="selectTransactionForExchangeRefund(' + t.id + ', \'' + type + '\')"';
                    const timeAgo = daysSince === 0 ? 'Today' : daysSince === 1 ? 'Yesterday' : daysSince + ' days ago';
                    const validityBadge = isExpired 
                        ? '<div style="color: #ff6b6b; font-size: 0.85rem; font-weight: 600; margin-top: 5px;">‚ö†Ô∏è Expired (5-day limit)</div>'
                        : '<div style="color: var(--success); font-size: 0.85rem; font-weight: 600; margin-top: 5px;">‚úì Valid for ' + daysRemaining + ' more day' + (daysRemaining !== 1 ? 's' : '') + '</div>';
                    const itemsPreview = t.items.slice(0, 3).map(item => item.name + ' (' + item.qty + ')').join(', ') + (t.items.length > 3 ? ' +' + (t.items.length - 3) + ' more' : '');
                    
                    return `
                        <div class="transaction-card" style="background: white; border: 2px solid ${borderColor}; border-radius: 8px; padding: 15px; margin-bottom: 12px; cursor: ${cursorStyle}; transition: var(--transition); opacity: ${opacity};" ${onclickAttr}>
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 1.05rem;">#${t.id.toString().slice(-8)}</div>
                                    <div style="font-size: 0.85rem; color: var(--gray); margin-top: 2px;">
                                        ${formatDate(t.date)} ‚Ä¢ ${timeAgo}
                                    </div>
                                    ${validityBadge}
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; font-size: 1.3rem; color: var(--primary);">${formatCurrency(t.total)}</div>
                                    <div style="font-size: 0.85rem; color: var(--gray); margin-top: 2px;">${t.paymentMethod}</div>
                                </div>
                            </div>
                            <div style="border-top: 1px solid var(--light-gray); padding-top: 10px; margin-top: 10px;">
                                <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 5px;">Items: ${t.items.length}</div>
                                <div style="font-size: 0.85rem; color: var(--gray);">
                                    ${itemsPreview}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('quickExchangeRefundModal').classList.add('active');
        }

        function closeQuickExchangeRefundModal() {
            document.getElementById('quickExchangeRefundModal').classList.remove('active');
        }

        function selectTransactionForExchangeRefund(transactionId, type) {
            closeQuickExchangeRefundModal();
            openExchangeRefundModal(transactionId);
        }

        function viewSystemLogs() {
            let logs = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìã SYSTEM LOGS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Total Products: ${products.length}
Total Transactions: ${transactions.length}
Total Categories: ${categories.length}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
RECENT ACTIVITY
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Last 5 Transactions:
`;

            const recentTransactions = transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            recentTransactions.forEach((t, i) => {
                logs += `\n${i + 1}. ${formatDate(t.date)}
   Customer: ${t.customerName || 'Walk-in'}
   Items: ${t.items.length}
   Total: ${formatCurrency(t.total)}
   Payment: ${t.paymentMethod}
`;
            });

            logs += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
STOCK ALERTS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Out of Stock: ${products.filter(p => p.qty === 0).length}
Low Stock: ${products.filter(p => p.qty > 0 && p.qty <= 10).length}
`;

            alert(logs);
        }

        // ===== PRODUCT MANAGEMENT =====
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            if (products.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div class="empty-state-text">No products available</div>
                        <div class="empty-state-subtext">Add products in the Inventory section</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = products.map(product => {
                const isOutOfStock = product.qty === 0;
                const isLowStock = product.qty > 0 && product.qty <= 10;
                
                let stockClass = '';
                let stockText = `${product.qty} in stock`;
                
                if (isOutOfStock) {
                    stockClass = 'out';
                    stockText = 'Out of stock';
                } else if (isLowStock) {
                    stockClass = 'low';
                    stockText = `${product.qty} left (Low stock)`;
                }

                return `
                    <div class="product-card ${isOutOfStock ? 'out-of-stock' : ''}" 
                         onclick="${isOutOfStock ? '' : `addToCart(${product.id})`}">
                        <div class="product-icon">${product.icon || 'üì¶'}</div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${formatCurrency(product.price)}</div>
                        <div class="product-stock ${stockClass}">${stockText}</div>
                        <button class="btn" 
                                onclick="event.stopPropagation(); addToCart(${product.id})"
                                ${isOutOfStock ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                            ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ===== CART MANAGEMENT =====
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.qty === 0) return;

            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                if (cartItem.qty < product.qty) {
                    cartItem.qty++;
                } else {
                    alert(`Only ${product.qty} items available in stock`);
                    return;
                }
            } else {
                cart.push({
                    ...product,
                    qty: 1
                });
            }

            updateCart();
        }

        function updateCart() {
            const cartContainer = document.getElementById('cartItems');
            const cartCount = document.getElementById('cartCount');
            const checkoutBtn = document.getElementById('checkoutBtn');

            if (cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üõí</div>
                        <div class="empty-state-text">Your cart is empty</div>
                        <div class="empty-state-subtext">Add products from the list</div>
                    </div>
                `;
                cartCount.textContent = '0 items';
                checkoutBtn.disabled = true;
            } else {
                cartContainer.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-icon">${item.icon || 'üì¶'}</div>
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">${formatCurrency(item.price)} each</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="qty-btn" onclick="updateCartQty(${item.id}, -1)">‚àí</button>
                            <span class="qty-display">${item.qty}</span>
                            <button class="qty-btn" onclick="updateCartQty(${item.id}, 1)">+</button>
                            <button class="remove-btn" onclick="removeFromCart(${item.id})">Remove</button>
                        </div>
                    </div>
                `).join('');

                const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
                cartCount.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
                checkoutBtn.disabled = false;
            }

            updateSummary();
        }

        function updateCartQty(productId, change) {
            const cartItem = cart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);
            
            if (!cartItem || !product) return;

            const newQty = cartItem.qty + change;
            
            if (newQty <= 0) {
                removeFromCart(productId);
                return;
            }

            if (newQty > product.qty) {
                alert(`Only ${product.qty} items available in stock`);
                return;
            }

            cartItem.qty = newQty;
            updateCart();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }

        function updateSummary() {
            calculateBill();
        }

        function calculateBill() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);

            // Calculate discount
            const discountType = document.getElementById('discountType').value;
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            let discount = 0;

            if (discountType === 'percentage') {
                discount = (subtotal * discountValue) / 100;
            } else if (discountType === 'fixed') {
                discount = discountValue;
            }

            // Show/hide discount row
            const discountRow = document.getElementById('discountRow');
            if (discount > 0) {
                discountRow.style.display = 'flex';
                document.getElementById('discountAmount').textContent = '-' + formatCurrency(discount);
            } else {
                discountRow.style.display = 'none';
            }

            // Calculate tax
            const taxType = document.getElementById('taxType').value;
            const taxRate = parseFloat(taxType) || 0;
            const amountAfterDiscount = subtotal - discount;
            const tax = (amountAfterDiscount * taxRate) / 100;

            // Show/hide tax row
            const taxRow = document.getElementById('taxRow');
            if (taxRate > 0) {
                taxRow.style.display = 'flex';
                document.getElementById('taxRate').textContent = taxRate;
                document.getElementById('taxAmount').textContent = formatCurrency(tax);
            } else {
                taxRow.style.display = 'none';
            }

            // Calculate total
            const total = amountAfterDiscount + tax;
            document.getElementById('total').textContent = formatCurrency(total);
        }

        function applyQuickDiscount(percentage) {
            document.getElementById('discountType').value = 'percentage';
            document.getElementById('discountValue').value = percentage;
            calculateBill();
        }

        function applyCustomTax() {
            const customTax = parseFloat(document.getElementById('customTax').value) || 0;
            if (customTax > 0) {
                document.getElementById('taxType').value = '0';
                // Create custom option if needed
                const taxSelect = document.getElementById('taxType');
                const customOption = Array.from(taxSelect.options).find(opt => opt.value === customTax.toString());
                if (!customOption) {
                    const option = document.createElement('option');
                    option.value = customTax;
                    option.text = `Custom ${customTax}%`;
                    option.selected = true;
                    taxSelect.add(option);
                }
            }
            calculateBill();
        }

        // ===== POS SEARCH & FILTER =====
        let filteredPOSProducts = [];

        function filterPOSProducts() {
            const searchTerm = document.getElementById('posSearch').value.toLowerCase();
            
            if (!searchTerm) {
                renderProducts();
                return;
            }

            filteredPOSProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm) ||
                product.id.toString().includes(searchTerm)
            );

            renderFilteredPOSProducts();
        }

        function renderFilteredPOSProducts() {
            const grid = document.getElementById('productsGrid');
            
            if (filteredPOSProducts.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">No products found</div>
                        <div class="empty-state-subtext">Try a different search term</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredPOSProducts.map(product => {
                const isOutOfStock = product.qty === 0;
                const isLowStock = product.qty > 0 && product.qty <= 10;
                
                let stockClass = '';
                let stockText = `${product.qty} in stock`;
                
                if (isOutOfStock) {
                    stockClass = 'out';
                    stockText = 'Out of stock';
                } else if (isLowStock) {
                    stockClass = 'low';
                    stockText = `${product.qty} left (Low stock)`;
                }

                return `
                    <div class="product-card ${isOutOfStock ? 'out-of-stock' : ''}" 
                         onclick="${isOutOfStock ? '' : `addToCart(${product.id})`}">
                        <div class="product-icon">${product.icon || 'üì¶'}</div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${formatCurrency(product.price)}</div>
                        <div class="product-stock ${stockClass}">${stockText}</div>
                        <button class="btn" 
                                onclick="event.stopPropagation(); addToCart(${product.id})"
                                ${isOutOfStock ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                            ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function handleBarcodeInput(event) {
            if (event.key === 'Enter') {
                const barcode = document.getElementById('barcodeInput').value.trim();
                if (!barcode) return;

                // Ensure all products have barcodes
                let needsUpdate = false;
                products.forEach(p => {
                    if (!p.barcode || p.barcode.length !== 13 || !/^\d+$/.test(p.barcode)) {
                        p.barcode = generateBarcode(p.id);
                        needsUpdate = true;
                    }
                });
                if (needsUpdate) {
                    localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
                }

                // Try to find product by barcode or ID
                const product = products.find(p => 
                    p.barcode === barcode || 
                    String(p.id) === barcode
                );

                if (product && product.qty > 0) {
                    addToCart(product.id);
                    document.getElementById('barcodeInput').value = '';
                    document.getElementById('barcodeInput').focus();
                } else if (product && product.qty === 0) {
                    alert('‚ö†Ô∏è Product is out of stock!');
                    document.getElementById('barcodeInput').value = '';
                } else {
                    alert('‚ùå Product not found with barcode: ' + barcode);
                    document.getElementById('barcodeInput').value = '';
                }
            }
        }

        function clearCart() {
            if (cart.length === 0) return;
            
            if (confirm('Are you sure you want to clear the cart?')) {
                cart = [];
                updateCart();
            }
        }

        // ===== CHECKOUT PROCESS =====
        function showPaymentModal() {
            if (cart.length === 0) return;
            document.getElementById('paymentModal').classList.add('active');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
        }

        function completeCheckout(paymentMethod) {
            selectedPaymentMethod = paymentMethod;
            closePaymentModal();
            processCheckout();
        }

        function processCheckout() {
            // Validate stock availability
            for (const cartItem of cart) {
                const product = products.find(p => p.id === cartItem.id);
                if (!product || product.qty < cartItem.qty) {
                    alert(`Insufficient stock for ${cartItem.name}. Available: ${product ? product.qty : 0}`);
                    updateCart();
                    return;
                }
            }

            // Get customer info
            const customerName = document.getElementById('customerName').value.trim() || 'Walk-in Customer';
            const customerPhone = document.getElementById('customerPhone').value.trim() || 'N/A';

            // Calculate amounts
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            
            const discountType = document.getElementById('discountType').value;
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            let discount = 0;
            
            if (discountType === 'percentage') {
                discount = (subtotal * discountValue) / 100;
            } else if (discountType === 'fixed') {
                discount = discountValue;
            }
            
            const taxRate = parseFloat(document.getElementById('taxType').value) || 0;
            const amountAfterDiscount = subtotal - discount;
            const tax = (amountAfterDiscount * taxRate) / 100;
            const total = amountAfterDiscount + tax;

            // Update inventory
            cart.forEach(cartItem => {
                const product = products.find(p => p.id === cartItem.id);
                if (product) {
                    product.qty -= cartItem.qty;
                }
            });

            // Record transaction
            const transaction = {
                id: Date.now(),
                date: new Date().toISOString(),
                customerName: customerName,
                customerPhone: customerPhone,
                items: cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    qty: item.qty,
                    price: item.price
                })),
                subtotal: subtotal,
                discount: discount,
                discountType: discountType,
                discountValue: discountValue,
                tax: tax,
                taxRate: taxRate,
                total: total,
                paymentMethod: selectedPaymentMethod,
                timestamp: Date.now()
            };

            transactions.push(transaction);
            saveData();

            // Show receipt
            showReceipt(transaction);

            // Reset form
            cart = [];
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('discountType').value = 'none';
            document.getElementById('discountValue').value = '';
            document.getElementById('taxType').value = '0';
            document.getElementById('customTax').value = '';
            
            updateCart();
            renderProducts();
            renderDashboard();

            // Show success message
            setTimeout(() => {
                alert(`‚úÖ Transaction successful!\nTotal: ${formatCurrency(total)}\nPayment: ${selectedPaymentMethod}`);
            }, 500);
        }

        // ===== RECEIPT MANAGEMENT =====
        function showReceipt(transaction) {
            const subtotal = transaction.subtotal;
            const discount = transaction.discount || 0;
            const tax = transaction.tax || 0;
            const total = transaction.total;
            const customerName = transaction.customerName || 'Walk-in Customer';
            const customerPhone = transaction.customerPhone || 'N/A';

            const receiptContent = `
                <div class="receipt-header">
                    <div class="receipt-title">${shopDetails.shopName}</div>
                    <div class="receipt-shop-info">
                        ${shopDetails.shopAddress}<br>
                        ${shopDetails.shopPhone}
                        ${shopDetails.shopEmail ? '<br>' + shopDetails.shopEmail : ''}
                        ${shopDetails.shopGST ? '<br>GST: ' + shopDetails.shopGST : ''}
                    </div>
                    <div class="receipt-date">${formatDate(new Date())}</div>
                    <div class="receipt-date">Receipt #${Date.now().toString().slice(-8)}</div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd;">
                        <strong>Customer:</strong> ${customerName}<br>
                        <strong>Phone:</strong> ${customerPhone}
                    </div>
                </div>
                
                <div class="receipt-items">
                    ${cart.map(item => `
                        <div class="receipt-item">
                            <div class="receipt-item-name">${item.name}</div>
                            <div class="receipt-item-qty">√ó${item.qty}</div>
                            <div class="receipt-item-price">${formatCurrency(item.price * item.qty)}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="receipt-totals">
                    <div class="receipt-total-row">
                        <span>Subtotal:</span>
                        <span>${formatCurrency(subtotal)}</span>
                    </div>
                    ${discount > 0 ? `
                        <div class="receipt-total-row" style="color: var(--success);">
                            <span>Discount:</span>
                            <span>-${formatCurrency(discount)}</span>
                        </div>
                    ` : ''}
                    ${tax > 0 ? `
                        <div class="receipt-total-row">
                            <span>Tax (${transaction.taxRate}%):</span>
                            <span>${formatCurrency(tax)}</span>
                        </div>
                    ` : ''}
                    <div class="receipt-total-row grand-total">
                        <span>Total:</span>
                        <span>${formatCurrency(total)}</span>
                    </div>
                </div>
                
                <div class="receipt-payment">
                    <strong>Payment Method:</strong> ${selectedPaymentMethod}<br>
                    <strong>Transaction ID:</strong> ${Date.now().toString().slice(-8)}
                </div>
                
                <div class="receipt-footer">
                    ${shopDetails.shopFooter}<br>
                    For queries, contact: ${shopDetails.shopPhone}
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn" onclick="printReceipt()" style="flex: 1; padding: 12px;">
                        üñ®Ô∏è Print Receipt
                    </button>
                    <button class="btn" onclick="closeReceipt()" style="flex: 1; padding: 12px; background: var(--light-gray);">
                        ‚úï Close
                    </button>
                </div>
            `;

            document.getElementById('receipt').innerHTML = receiptContent;
            document.getElementById('receiptModal').classList.add('active');
        }

        function printReceipt() {
            window.print();
        }

        function closeReceipt() {
            document.getElementById('receiptModal').classList.remove('active');
        }

        // ===== BILL REPRINT FUNCTIONS =====
        function reprintReceipt(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) {
                alert('‚ùå Transaction not found!');
                return;
            }

            // Generate receipt from transaction data
            const subtotal = transaction.subtotal || transaction.total;
            const discount = transaction.discount || 0;
            const tax = transaction.tax || 0;
            const total = transaction.total;
            const customerName = transaction.customerName || 'Walk-in Customer';
            const customerPhone = transaction.customerPhone || 'N/A';

            const receiptContent = `
                <div class="receipt-header">
                    <div class="receipt-title">${shopDetails.shopName}</div>
                    <div class="receipt-shop-info">
                        ${shopDetails.shopAddress}<br>
                        ${shopDetails.shopPhone}
                        ${shopDetails.shopEmail ? '<br>' + shopDetails.shopEmail : ''}
                        ${shopDetails.shopGST ? '<br>GST: ' + shopDetails.shopGST : ''}
                    </div>
                    <div class="receipt-date">${formatDate(transaction.date)}</div>
                    <div class="receipt-date">Receipt #${transaction.id.toString().slice(-8)}</div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd; color: var(--danger); font-weight: 600; text-align: center;">
                        ‚ö†Ô∏è DUPLICATE COPY
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd;">
                        <strong>Customer:</strong> ${customerName}<br>
                        <strong>Phone:</strong> ${customerPhone}
                    </div>
                </div>
                
                <div class="receipt-items">
                    ${transaction.items.map(item => `
                        <div class="receipt-item">
                            <div class="receipt-item-name">${item.name}</div>
                            <div class="receipt-item-qty">√ó${item.qty}</div>
                            <div class="receipt-item-price">${formatCurrency(item.price * item.qty)}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="receipt-totals">
                    <div class="receipt-total-row">
                        <span>Subtotal:</span>
                        <span>${formatCurrency(subtotal)}</span>
                    </div>
                    ${discount > 0 ? `
                        <div class="receipt-total-row" style="color: var(--success);">
                            <span>Discount:</span>
                            <span>-${formatCurrency(discount)}</span>
                        </div>
                    ` : ''}
                    ${tax > 0 ? `
                        <div class="receipt-total-row">
                            <span>Tax (${transaction.taxRate || 0}%):</span>
                            <span>${formatCurrency(tax)}</span>
                        </div>
                    ` : ''}
                    <div class="receipt-total-row grand-total">
                        <span>Total:</span>
                        <span>${formatCurrency(total)}</span>
                    </div>
                </div>
                
                <div class="receipt-payment">
                    <strong>Payment Method:</strong> ${transaction.paymentMethod}<br>
                    <strong>Transaction ID:</strong> ${transaction.id.toString().slice(-8)}<br>
                    <strong>Original Date:</strong> ${formatDate(transaction.date)}
                </div>
                
                <div class="receipt-footer">
                    ${shopDetails.shopFooter}<br>
                    For queries, contact: ${shopDetails.shopPhone}
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn" onclick="printReceipt()" style="flex: 1; padding: 12px;">
                        üñ®Ô∏è Print Receipt
                    </button>
                    <button class="btn" onclick="closeReceipt()" style="flex: 1; padding: 12px; background: var(--light-gray);">
                        ‚úï Close
                    </button>
                </div>
            `;

            document.getElementById('receipt').innerHTML = receiptContent;
            document.getElementById('receiptModal').classList.add('active');
        }

        function viewTransactionDetails(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) {
                alert('‚ùå Transaction not found!');
                return;
            }

            const subtotal = transaction.subtotal || transaction.total;
            const discount = transaction.discount || 0;
            const tax = transaction.tax || 0;
            const total = transaction.total;

            let details = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìã TRANSACTION DETAILS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üÜî Transaction ID: ${transaction.id.toString().slice(-8)}
üìÖ Date: ${formatDate(transaction.date)}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ CUSTOMER INFORMATION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Name: ${transaction.customerName || 'Walk-in Customer'}
Phone: ${transaction.customerPhone || 'N/A'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üõí ITEMS (${transaction.items.length})
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

`;

            transaction.items.forEach((item, index) => {
                details += `${index + 1}. ${item.name}
   Qty: ${item.qty} √ó ${formatCurrency(item.price)}
   Amount: ${formatCurrency(item.qty * item.price)}

`;
            });

            details += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ PAYMENT SUMMARY
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Subtotal: ${formatCurrency(subtotal)}`;

            if (discount > 0) {
                details += `
Discount (${transaction.discountType === 'percentage' ? transaction.discountValue + '%' : 'Fixed'}): -${formatCurrency(discount)}`;
            }

            if (tax > 0) {
                details += `
Tax (${transaction.taxRate || 0}%): ${formatCurrency(tax)}`;
            }

            details += `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
TOTAL PAID: ${formatCurrency(total)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí≥ Payment Method: ${transaction.paymentMethod}
`;

            alert(details);
        }

        // ===== INVENTORY MANAGEMENT =====
        function renderInventory() {
            // Update quick stats
            updateInventoryStats();

            // Update category dropdown in add form
            const categorySelect = document.getElementById('productCategory');
            if (categorySelect) {
                categorySelect.innerHTML = categories.map(cat => 
                    `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`
                ).join('');
            }

            // Reset filters and render table
            filteredProducts = [...products];
            renderFilteredInventory();
        }

        function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const icon = document.getElementById('productIcon').value.trim();
            const category = document.getElementById('productCategory').value;
            const mrp = parseFloat(document.getElementById('productMRP').value);
            const costPrice = parseFloat(document.getElementById('productCostPrice').value);
            const price = parseFloat(document.getElementById('productPrice').value);
            const qty = parseInt(document.getElementById('productQty').value);

            // Validation
            if (!name) {
                alert('Please enter product name');
                return;
            }
            
            if (!icon) {
                alert('Please enter product icon');
                return;
            }
            
            if (!category) {
                alert('Please select a category');
                return;
            }
            
            if (isNaN(mrp) || mrp < 0) {
                alert('Please enter a valid MRP');
                return;
            }
            
            if (isNaN(costPrice) || costPrice < 0) {
                alert('Please enter a valid cost price');
                return;
            }
            
            if (isNaN(price) || price < 0) {
                alert('Please enter a valid selling price');
                return;
            }
            
            if (isNaN(qty) || qty < 0) {
                alert('Please enter a valid quantity');
                return;
            }

            // Generate unique barcode
            const barcode = generateBarcode(nextProductId);

            // Add product
            products.push({
                id: nextProductId++,
                name,
                category,
                mrp,
                costPrice,
                price,
                qty,
                icon,
                barcode,
                createdAt: new Date().toISOString()
            });

            saveData();
            clearProductForm();
            renderProducts();
            renderInventory();
            alert('‚úÖ Product added successfully!');
        }

        function clearProductForm() {
            document.getElementById('productName').value = '';
            const iconField = document.getElementById('productIcon');
            if (iconField) iconField.value = '';
            const barcodeField = document.getElementById('productBarcode');
            if (barcodeField) barcodeField.value = '';
            document.getElementById('productMRP').value = '';
            document.getElementById('productCostPrice').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productQty').value = '';
            const profitDisplay = document.getElementById('profitMarginDisplay');
            if (profitDisplay) profitDisplay.textContent = '-';
        }

        function openEditModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            editingProductId = productId;
            
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductMRP').value = product.mrp || 0;
            document.getElementById('editProductCostPrice').value = product.costPrice || 0;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductQty').value = product.qty;
            
            // Populate category dropdown
            const categorySelect = document.getElementById('editProductCategory');
            categorySelect.innerHTML = categories.map(cat => 
                `<option value="${cat.name}" ${cat.name === product.category ? 'selected' : ''}>
                    ${cat.icon} ${cat.name}
                </option>`
            ).join('');
            
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingProductId = null;
        }

        function saveProduct() {
            const product = products.find(p => p.id === editingProductId);
            if (!product) return;

            product.name = document.getElementById('editProductName').value.trim();
            product.mrp = parseFloat(document.getElementById('editProductMRP').value);
            product.costPrice = parseFloat(document.getElementById('editProductCostPrice').value);
            product.price = parseFloat(document.getElementById('editProductPrice').value);
            product.qty = parseInt(document.getElementById('editProductQty').value);
            product.category = document.getElementById('editProductCategory').value;
            
            // Update icon based on new category
            const categoryObj = categories.find(c => c.name === product.category);
            if (categoryObj) {
                product.icon = categoryObj.icon;
            }

            saveData();
            renderProducts();
            renderInventory();
            closeEditModal();
            alert('‚úÖ Product updated successfully!');
        }

        function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            // Remove from products
            products = products.filter(p => p.id !== productId);
            
            // Remove from cart
            cart = cart.filter(item => item.id !== productId);

            saveData();
            renderProducts();
            renderInventory();
            updateCart();
            alert('‚úÖ Product deleted successfully!');
        }

        // ===== ENHANCED INVENTORY FEATURES =====
        let inventorySort = { field: null, order: 'asc' };
        let filteredProducts = [];

        function updateInventoryStats() {
            const totalProducts = products.length;
            const totalUnits = products.reduce((sum, p) => sum + p.qty, 0);
            const lowStockCount = products.filter(p => p.qty > 0 && p.qty <= 10).length;
            const outOfStockCount = products.filter(p => p.qty === 0).length;
            const totalValue = products.reduce((sum, p) => sum + (p.price * p.qty), 0);

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalUnits').textContent = totalUnits.toLocaleString();
            document.getElementById('lowStockCount').textContent = lowStockCount;
            document.getElementById('outOfStockCount').textContent = outOfStockCount;
            document.getElementById('totalInventoryValue').textContent = formatCurrency(totalValue);

            // Update category filter
            const categoryFilter = document.getElementById('categoryFilter');
            const currentValue = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="">All Categories</option>' + 
                categories.map(cat => `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`).join('');
            categoryFilter.value = currentValue;
        }

        function toggleAddProductForm() {
            const form = document.getElementById('addProductForm');
            if (form.style.display === 'none') {
                form.style.display = 'grid';
                // Pre-generate barcode for preview
                const newBarcode = generateBarcode(nextProductId);
                document.getElementById('productBarcode').value = newBarcode;
            } else {
                form.style.display = 'none';
                clearProductForm();
            }
        }

        function calculateProfitMargin() {
            const costPrice = parseFloat(document.getElementById('productCostPrice').value) || 0;
            const sellingPrice = parseFloat(document.getElementById('productPrice').value) || 0;
            
            if (costPrice > 0 && sellingPrice > 0) {
                const profit = sellingPrice - costPrice;
                const margin = (profit / costPrice * 100).toFixed(2);
                const display = document.getElementById('profitMarginDisplay');
                
                if (profit > 0) {
                    display.textContent = `Profit: ${formatCurrency(profit)} (${margin}% margin)`;
                    display.style.color = 'var(--success)';
                } else if (profit < 0) {
                    display.textContent = `Loss: ${formatCurrency(Math.abs(profit))} (${margin}% margin)`;
                    display.style.color = 'var(--danger)';
                } else {
                    display.textContent = 'No profit, no loss';
                    display.style.color = 'var(--gray)';
                }
            } else {
                document.getElementById('profitMarginDisplay').textContent = '-';
            }
        }

        function filterInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            
            // Show/hide clear button
            const clearBtn = document.querySelector('.clear-search');
            if (searchTerm) {
                clearBtn.classList.add('active');
            } else {
                clearBtn.classList.remove('active');
            }

            filteredProducts = products.filter(product => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm);
                
                // Category filter
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                
                // Stock filter
                let matchesStock = true;
                if (stockFilter === 'in-stock') {
                    matchesStock = product.qty > 10;
                } else if (stockFilter === 'low-stock') {
                    matchesStock = product.qty > 0 && product.qty <= 10;
                } else if (stockFilter === 'out-of-stock') {
                    matchesStock = product.qty === 0;
                }
                
                return matchesSearch && matchesCategory && matchesStock;
            });

            renderFilteredInventory();
        }

        function clearInventorySearch() {
            document.getElementById('inventorySearch').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('stockFilter').value = '';
            document.querySelector('.clear-search').classList.remove('active');
            filterInventory();
        }

        function sortInventory(field) {
            // Update sort state
            if (inventorySort.field === field) {
                inventorySort.order = inventorySort.order === 'asc' ? 'desc' : 'asc';
            } else {
                inventorySort.field = field;
                inventorySort.order = 'asc';
            }

            // Update header classes
            document.querySelectorAll('.table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const activeHeader = event.target;
            activeHeader.classList.add(inventorySort.order === 'asc' ? 'sort-asc' : 'sort-desc');

            // Sort products
            const productsToSort = filteredProducts.length > 0 || 
                document.getElementById('inventorySearch').value || 
                document.getElementById('categoryFilter').value || 
                document.getElementById('stockFilter').value
                ? filteredProducts 
                : [...products];

            productsToSort.sort((a, b) => {
                let valA, valB;

                switch(field) {
                    case 'name':
                    case 'category':
                        valA = a[field].toLowerCase();
                        valB = b[field].toLowerCase();
                        break;
                    case 'profit':
                        valA = (a.price - a.costPrice) * a.qty;
                        valB = (b.price - b.costPrice) * b.qty;
                        break;
                    case 'status':
                        valA = a.qty === 0 ? 0 : (a.qty <= 10 ? 1 : 2);
                        valB = b.qty === 0 ? 0 : (b.qty <= 10 ? 1 : 2);
                        break;
                    default:
                        valA = a[field];
                        valB = b[field];
                }

                if (valA < valB) return inventorySort.order === 'asc' ? -1 : 1;
                if (valA > valB) return inventorySort.order === 'asc' ? 1 : -1;
                return 0;
            });

            filteredProducts = productsToSort;
            renderFilteredInventory();
        }

        function renderFilteredInventory() {
            const table = document.getElementById('inventoryTable');
            const displayProducts = filteredProducts.length > 0 || 
                document.getElementById('inventorySearch').value || 
                document.getElementById('categoryFilter').value || 
                document.getElementById('stockFilter').value
                ? filteredProducts 
                : products;

            if (displayProducts.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="10">
                            <div class="empty-state" style="padding: 30px;">
                                <div class="empty-state-icon">üîç</div>
                                <div class="empty-state-text">No products found</div>
                                <div class="empty-state-subtext">Try adjusting your filters or search term</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            table.innerHTML = displayProducts.map(product => {
                const isOutOfStock = product.qty === 0;
                const isLowStock = product.qty > 0 && product.qty <= 10;
                
                let status = '‚úÖ In Stock';
                let statusClass = 'success';
                
                if (isOutOfStock) {
                    status = '‚ùå Out of Stock';
                    statusClass = 'danger';
                } else if (isLowStock) {
                    status = '‚ö†Ô∏è Low Stock';
                    statusClass = 'warning';
                }

                const profit = (product.price - product.costPrice) * product.qty;
                const profitPercentage = product.costPrice > 0 ? ((product.price - product.costPrice) / product.costPrice * 100).toFixed(1) : 0;
                
                // Generate barcode if not exists
                if (!product.barcode) {
                    product.barcode = generateBarcode(product.id);
                }
                
                // Ensure icon exists
                const productIcon = product.icon || 'üì¶';
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px; min-width: 180px;">
                                <span style="font-size: 1.1rem; flex-shrink: 0;">${productIcon}</span>
                                <div style="min-width: 0; flex: 1;">
                                    <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;">${product.name}</div>
                                    <div style="font-size: 0.75rem; color: var(--gray); white-space: nowrap;">ID: ${product.id}</div>
                                </div>
                            </div>
                        </td>
                        <td style="min-width: 100px;">${product.category}</td>
                        <td style="min-width: 130px;">
                            <div style="font-size: 0.75rem; color: var(--gray);">${product.barcode}</div>
                            <button class="btn btn-edit" onclick="showBarcode(${product.id})" style="margin-top: 4px; font-size: 0.75rem; padding: 4px 8px;">
                                üìä View
                            </button>
                        </td>
                        <td style="font-weight: 600; min-width: 110px;" title="MRP">${formatCurrency(product.mrp || 0)}</td>
                        <td style="color: #ff6b6b; min-width: 110px;" title="Cost Price">${formatCurrency(product.costPrice || 0)}</td>
                        <td style="font-weight: 600; color: #51cf66; min-width: 110px;" title="Selling Price">${formatCurrency(product.price)}</td>
                        <td style="color: ${profit > 0 ? '#51cf66' : '#ff6b6b'}; font-weight: 600; min-width: 110px;" title="Profit">
                            ${formatCurrency(profit)}<br><span style="font-size: 0.75rem;">(${profitPercentage}%)</span>
                        </td>
                        <td style="min-width: 70px; text-align: center;">
                            <span style="font-weight: 600; ${isLowStock ? 'color: var(--warning);' : ''} ${isOutOfStock ? 'color: var(--danger);' : ''}">
                                ${product.qty}
                            </span>
                        </td>
                        <td style="min-width: 110px;">
                            <span class="${statusClass}" style="font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; display: inline-block; white-space: nowrap; background: ${statusClass === 'success' ? '#e8f5e9' : statusClass === 'warning' ? '#fff3cd' : '#ffebee'};">
                                ${status}
                            </span>
                        </td>
                        <td style="min-width: 150px;">
                            <div class="action-buttons" style="flex-wrap: wrap; justify-content: center;">
                                <button class="btn btn-edit" onclick="openEditModal(${product.id})" style="flex: 1; min-width: 60px;">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-delete" onclick="deleteProduct(${product.id})" style="flex: 1; min-width: 60px;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function exportInventoryCSV() {
            const headers = ['ID', 'Product Name', 'Category', 'MRP', 'Cost Price', 'Selling Price', 'Stock', 'Status'];
            const rows = products.map(p => {
                const status = p.qty === 0 ? 'Out of Stock' : (p.qty <= 10 ? 'Low Stock' : 'In Stock');
                return [
                    p.id,
                    p.name,
                    p.category,
                    p.mrp || 0,
                    p.costPrice || 0,
                    p.price,
                    p.qty,
                    status
                ];
            });

            let csvContent = headers.join(',') + '\\n';
            rows.forEach(row => {
                csvContent += row.map(cell => `"${cell}"`).join(',') + '\\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('‚úÖ Inventory exported successfully!');
        }

        function importInventoryCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\\n');
                    let imported = 0;
                    
                    // Skip header line
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const values = line.match(/(".*?"|[^,]+)(?=\\s*,|\\s*$)/g).map(v => v.replace(/^"|"$/g, ''));
                        
                        if (values.length >= 7) {
                            const [id, name, category, mrp, costPrice, price, qty] = values;
                            
                            // Check if category exists
                            const categoryObj = categories.find(c => c.name === category);
                            if (!categoryObj) continue;

                            products.push({
                                id: nextProductId,
                                name: name,
                                category: category,
                                mrp: parseFloat(mrp) || 0,
                                costPrice: parseFloat(costPrice) || 0,
                                price: parseFloat(price),
                                qty: parseInt(qty),
                                icon: categoryObj.icon,
                                barcode: generateBarcode(nextProductId),
                                createdAt: new Date().toISOString()
                            });
                            nextProductId++;
                            imported++;
                        }
                    }

                    if (imported > 0) {
                        saveData();
                        renderProducts();
                        renderInventory();
                        alert(`‚úÖ Successfully imported ${imported} product(s)!`);
                    } else {
                        alert('‚ö†Ô∏è No valid products found in the CSV file.');
                    }
                } catch (error) {
                    alert('‚ùå Error importing CSV: ' + error.message);
                }
                
                // Reset file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function printInventoryReport() {
            const printWindow = window.open('', '', 'width=800,height=600');
            const reportContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Inventory Report - ${shopDetails.shopName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #667eea; color: white; }
                        .summary { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>${shopDetails.shopName} - Inventory Report</h1>
                    <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
                    
                    <div class="summary">
                        <h3>Summary</h3>
                        <p><strong>Total Products:</strong> ${products.length}</p>
                        <p><strong>Total Stock Units:</strong> ${products.reduce((s, p) => s + p.qty, 0)}</p>
                        <p><strong>Total Inventory Value:</strong> ${formatCurrency(products.reduce((s, p) => s + (p.price * p.qty), 0))}</p>
                        <p><strong>Low Stock Items:</strong> ${products.filter(p => p.qty > 0 && p.qty <= 10).length}</p>
                        <p><strong>Out of Stock:</strong> ${products.filter(p => p.qty === 0).length}</p>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Cost Price</th>
                                <th>Selling Price</th>
                                <th>Stock</th>
                                <th>Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(p => {
                                const status = p.qty === 0 ? 'Out of Stock' : (p.qty <= 10 ? 'Low Stock' : 'In Stock');
                                return `
                                    <tr>
                                        <td>${p.name}</td>
                                        <td>${p.category}</td>
                                        <td>${formatCurrency(p.costPrice || 0)}</td>
                                        <td>${formatCurrency(p.price)}</td>
                                        <td>${p.qty}</td>
                                        <td>${formatCurrency(p.price * p.qty)}</td>
                                        <td>${status}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Print Report
                    </button>
                </body>
                </html>
            `;
            
            printWindow.document.write(reportContent);
            printWindow.document.close();
        }

        // ===== DASHBOARD =====
        function renderDashboard() {
            // Calculate statistics
            const totalSales = transactions.reduce((sum, t) => sum + t.total, 0);
            const totalTransactions = transactions.length;
            const totalStockValue = products.reduce((sum, p) => sum + (p.price * p.qty), 0);
            const totalStock = products.reduce((sum, p) => sum + p.qty, 0);

            // Update stat cards
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
            document.getElementById('stockValue').textContent = formatCurrency(totalStockValue);
            document.getElementById('totalStock').textContent = totalStock.toLocaleString();

            // Low Stock Alert
            const lowStockItems = products
                .filter(p => p.qty > 0 && p.qty <= 10)
                .sort((a, b) => a.qty - b.qty);
            
            const lowStockList = document.getElementById('lowStockList');
            lowStockList.innerHTML = lowStockItems.length > 0
                ? lowStockItems.map(p => `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${p.icon || 'üì¶'}
                                <span>${p.name}</span>
                            </div>
                        </td>
                        <td style="font-weight: 600; color: var(--warning);">${p.qty}</td>
                        <td>
                            <span style="padding: 4px 8px; background: #fff3cd; border-radius: 4px; font-size: 0.85rem;">
                                ‚ö†Ô∏è Low Stock
                            </span>
                        </td>
                    </tr>
                `).join('')
                : '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--gray);">No low stock items</td></tr>';

            // Stock by Category
            const categoryStats = {};
            products.forEach(p => {
                if (!categoryStats[p.category]) {
                    categoryStats[p.category] = { qty: 0, value: 0 };
                }
                categoryStats[p.category].qty += p.qty;
                categoryStats[p.category].value += p.price * p.qty;
            });

            const stockByCategory = document.getElementById('stockByCategory');
            stockByCategory.innerHTML = Object.entries(categoryStats).length > 0
                ? Object.entries(categoryStats).map(([category, stats]) => {
                    const catObj = categories.find(c => c.name === category);
                    return `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    ${catObj ? catObj.icon : 'üì¶'}
                                    <span>${category}</span>
                                </div>
                            </td>
                            <td style="font-weight: 600;">${stats.qty.toLocaleString()}</td>
                            <td style="font-weight: 600; color: var(--primary);">
                                ${formatCurrency(stats.value)}
                            </td>
                        </tr>
                    `;
                }).join('')
                : '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--gray);">No stock data</td></tr>';

            // Sales by Product
            const productSales = {};
            
            // Initialize with all products
            products.forEach(p => {
                productSales[p.id] = {
                    name: p.name,
                    icon: p.icon || 'üì¶',
                    unitsSold: 0,
                    revenue: 0,
                    currentStock: p.qty
                };
            });

            // Calculate sales from transactions
            transactions.forEach(t => {
                t.items.forEach(item => {
                    if (productSales[item.id]) {
                        productSales[item.id].unitsSold += item.qty;
                        productSales[item.id].revenue += item.price * item.qty;
                    }
                });
            });

            const salesByProduct = document.getElementById('salesByProduct');
            const sortedProductSales = Object.values(productSales)
                .filter(p => p.unitsSold > 0)
                .sort((a, b) => b.revenue - a.revenue);

            salesByProduct.innerHTML = sortedProductSales.length > 0
                ? sortedProductSales.map(p => `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${p.icon}
                                <span>${p.name}</span>
                            </div>
                        </td>
                        <td style="font-weight: 600;">${p.unitsSold.toLocaleString()}</td>
                        <td style="font-weight: 600; color: var(--primary);">
                            ${formatCurrency(p.revenue)}
                        </td>
                        <td>${p.currentStock.toLocaleString()}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--gray);">No sales data yet</td></tr>';

            // Recent Transactions
            const transactionsList = document.getElementById('transactionsList');
            const recentTransactions = transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);

            transactionsList.innerHTML = recentTransactions.length > 0
                ? recentTransactions.map(t => {
                    let statusBadge = '';
                    if (t.isExchanged) {
                        statusBadge = '<br><span style="padding: 2px 6px; background: var(--warning); color: white; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üîÑ EXCHANGED</span>';
                    } else if (t.isRefunded) {
                        statusBadge = '<br><span style="padding: 2px 6px; background: var(--danger); color: white; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">üí∞ REFUNDED</span>';
                    }
                    
                    return `
                    <tr style="${t.isExchanged || t.isRefunded ? 'opacity: 0.7; background: #f8f9fa;' : ''}">
                        <td>
                            ${formatDate(t.date)}<br>
                            <small style="color: var(--gray);">#${t.id.toString().slice(-8)}</small>
                            ${statusBadge}
                        </td>
                        <td>
                            <strong>${t.customerName || 'Walk-in'}</strong><br>
                            <small style="color: var(--gray);">${t.customerPhone || 'N/A'}</small>
                        </td>
                        <td>${t.items.length} item${t.items.length !== 1 ? 's' : ''}</td>
                        <td style="font-weight: 600;">
                            ${formatCurrency(t.total)}
                            ${t.discount > 0 ? `<br><small style="color: var(--success);">-${formatCurrency(t.discount)} disc.</small>` : ''}
                        </td>
                        <td>
                            <span style="padding: 4px 8px; background: var(--light-gray); border-radius: 4px; font-size: 0.85rem;">
                                ${t.paymentMethod}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons" style="gap: 5px;">
                                <button class="btn btn-edit" onclick="reprintReceipt(${t.id})" title="Reprint Receipt" style="min-width: auto; padding: 8px 12px;">
                                    üñ®Ô∏è
                                </button>
                                <button class="btn btn-edit" onclick="viewTransactionDetails(${t.id})" title="View Details" style="min-width: auto; padding: 8px 12px;">
                                    üëÅÔ∏è
                                </button>
                                ${!t.isExchanged && !t.isRefunded ? `
                                <button class="btn btn-edit" onclick="openExchangeRefundModal(${t.id})" title="Exchange/Refund" style="min-width: auto; padding: 8px 12px; background: var(--warning);">
                                    üîÑ
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                    `;
                }).join('')
                : '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">No transactions yet</td></tr>';
        }

        // ===== SETTINGS MANAGEMENT =====
        function loadShopSettings() {
            document.getElementById('shopName').value = shopDetails.shopName;
            document.getElementById('shopAddress').value = shopDetails.shopAddress;
            document.getElementById('shopPhone').value = shopDetails.shopPhone;
            document.getElementById('shopEmail').value = shopDetails.shopEmail;
            document.getElementById('shopGST').value = shopDetails.shopGST;
            document.getElementById('shopFooter').value = shopDetails.shopFooter;
            renderCategoriesList();
        }

        function renderCategoriesList() {
            const list = document.getElementById('categoriesList');
            list.innerHTML = categories.map((cat, index) => `
                <div class="category-item">
                    <div class="category-info">
                        <span style="font-size: 1.2rem;">${cat.icon}</span>
                        <span style="font-weight: 600;">${cat.name}</span>
                    </div>
                    <button class="btn btn-delete" onclick="deleteCategory(${index})" 
                            style="padding: 6px 12px; font-size: 0.85rem;">
                        Delete
                    </button>
                </div>
            `).join('');
        }

        function addCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const icon = document.getElementById('newCategoryIcon').value.trim();

            if (!name) {
                alert('Please enter category name');
                return;
            }

            if (!icon) {
                alert('Please enter category icon (emoji)');
                return;
            }

            // Check for duplicates
            if (categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                alert('Category already exists');
                return;
            }

            categories.push({ name, icon });
            saveData();
            
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryIcon').value = '';
            
            renderCategoriesList();
            renderInventory();
            alert('‚úÖ Category added successfully!');
        }

        function deleteCategory(index) {
            const category = categories[index];
            
            // Check if any products use this category
            const productsInCategory = products.filter(p => p.category === category.name);
            if (productsInCategory.length > 0) {
                alert(`Cannot delete category "${category.name}". ${productsInCategory.length} product(s) use this category. Please change their category first.`);
                return;
            }

            if (!confirm(`Delete category "${category.name}"?`)) return;

            categories.splice(index, 1);
            saveData();
            renderCategoriesList();
            renderInventory();
            alert('‚úÖ Category deleted!');
        }

        function saveShopSettings() {
            shopDetails.shopName = document.getElementById('shopName').value.trim();
            shopDetails.shopAddress = document.getElementById('shopAddress').value.trim();
            shopDetails.shopPhone = document.getElementById('shopPhone').value.trim();
            shopDetails.shopEmail = document.getElementById('shopEmail').value.trim();
            shopDetails.shopGST = document.getElementById('shopGST').value.trim();
            shopDetails.shopFooter = document.getElementById('shopFooter').value.trim();

            if (!shopDetails.shopName) {
                alert('Please enter shop name');
                return;
            }

            saveData();
            alert('‚úÖ Shop settings saved successfully!');
        }

        // ===== DATA RESET FUNCTIONS =====
        function confirmReset() {
            document.getElementById('confirmModal').classList.add('active');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        function forceResetSystem() {
            localStorage.clear();
            location.reload();
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è This will delete ALL data including products, transactions, and settings. This action cannot be undone. Are you sure?')) {
                return;
            }

            products = [];
            cart = [];
            transactions = [];
            categories = [
                { name: 'Vegetables', icon: 'ü•¨' },
                { name: 'Fruits', icon: 'üçé' },
                { name: 'Dairy', icon: 'ü•õ' },
                { name: 'Meat', icon: 'üçñ' },
                { name: 'Bakery', icon: 'üçû' },
                { name: 'Beverages', icon: 'ü•§' }
            ];
            shopDetails = {
                shopName: 'Supermarket Store',
                shopAddress: '123 Market Street, City Center',
                shopPhone: '+91 9876543210',
                shopEmail: 'shop@example.com',
                shopGST: '',
                shopFooter: 'Thank you for your purchase! Visit us again.'
            };
            nextProductId = 1;

            saveData();
            
            if (document.getElementById('pos').classList.contains('active')) {
                renderProducts();
            } else if (document.getElementById('inventory').classList.contains('active')) {
                renderInventory();
            } else if (document.getElementById('dashboard').classList.contains('active')) {
                renderDashboard();
            } else if (document.getElementById('settings').classList.contains('active')) {
                loadShopSettings();
            }
            
            updateCart();
            alert('‚úÖ All data cleared! Starting fresh.');
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize all sections
            loadShopSettings();
            renderProducts();
            renderInventory();
            renderDashboard();
            updateCart();

            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            // Close modals with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });

            // Initialize navigation visibility based on user role
            updateNavigationVisibility();

            console.log('üöÄ Supermarket Management System Ready!');
            console.log(`üì¶ Products: ${products.length}`);
            console.log(`üí∞ Transactions: ${transactions.length}`);
            console.log(`üè™ Shop: ${shopDetails.shopName}`);
        });
    </script>
</body>
</html>